var Fi=Object.defineProperty;var Ui=(a,e,t)=>e in a?Fi(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var Ze=(a,e,t)=>Ui(a,typeof e!="symbol"?e+"":e,t);import{K as Bi,Q as Hs,_ as kr,$ as Rr,a0 as It,a1 as Dt,f as ke,h as Y,a2 as Qe,a3 as Be,a4 as Nt,a5 as Vi,a6 as zi,a7 as ji,c as Z,V as S,a8 as Lr,a9 as Re,aa as Wi,O as Or,T as Gi,ab as Hi,ac as ge,ad as qi,ae as Ir,af as Ki,ag as $i,ah as Xi,L as ss,ai as Dr,F as qs,aj as Qi,ak as Zi,al as Nr,am as ms,an as Yi,ao as Fr,ap as Ji,x as dt,aq as eo,ar as Bt,as as to,M as os,at as so,au as no,av as ro,aw as Ur,G as pt,a as io,ax as Q,ay as Br,az as oo,aA as ao,aB as co,aC as lo,aD as Vr,aE as uo,n as hn,aF as dn,aG as fn,aH as pn,aI as mn,aJ as ho,aK as fo,B as zr,aL as Ys,aM as as,aN as nt,aO as jr,aP as po,aQ as Js,aR as mo,aS as Wr,aT as go,aU as yo,E as Rt,b as To,aV as Gr,aW as _o,g as bo,aX as wo,o as xo,aY as gn,W as Ao,u as yn,aZ as vo,a_ as Eo,a$ as So,b0 as Po,b1 as Mo,b2 as Co,b3 as ko,b4 as Ro,b5 as Lo}from"./index-CYDsy1T_.js";function Tn(a){if(!a)return null;const e=a.replace(/[a-z]+:\/\/[^/]+/i,"").replace(/\?.*$/i,"").replace(/.*\//g,""),t=e.lastIndexOf(".");return t===-1?null:e.substring(t+1)||null}const _n=2**30;class Hr{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(e){e.length===1?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(t,s)=>{const n=e(t),r=e(s);return n<r?-1:n>r?1:0}):this._unloadPriorityCallback=e}constructor(){this.minSize=6e3,this.maxSize=8e3,this.minBytesSize=.3*_n,this.maxBytesSize=.4*_n,this.unloadPercent=.05,this.autoMarkUnused=!0,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadingHandle=-1,this.cachedBytes=0,this.bytesMap=new Map,this.loadedSet=new Set,this._unloadPriorityCallback=null,this.computeMemoryUsageCallback=()=>null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize||this.cachedBytes>=this.maxBytesSize}getMemoryUsage(e){return this.bytesMap.get(e)??null}add(e,t){const s=this.itemSet;if(s.has(e)||this.isFull())return!1;const n=this.usedSet,r=this.itemList,i=this.callbacks,o=this.bytesMap;r.push(e),n.add(e),s.set(e,Date.now()),i.set(e,t);const c=this.computeMemoryUsageCallback(e);return this.cachedBytes+=c||0,o.set(e,c),!0}has(e){return this.itemSet.has(e)}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,r=this.bytesMap,i=this.callbacks,o=this.loadedSet;if(s.has(e)){this.cachedBytes-=r.get(e)||0,r.delete(e),i.get(e)(e);const c=n.indexOf(e);return n.splice(c,1),t.delete(e),s.delete(e),i.delete(e),o.delete(e),!0}return!1}setLoaded(e,t){const{itemSet:s,loadedSet:n}=this;s.has(e)&&(t===!0?n.add(e):n.delete(e))}updateMemoryUsage(e){const t=this.itemSet,s=this.bytesMap;if(!t.has(e))return;this.cachedBytes-=s.get(e)||0;const n=this.computeMemoryUsageCallback(e);s.set(e,n),this.cachedBytes+=n}markUsed(e){const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markUnused(e){this.usedSet.delete(e)}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const{unloadPercent:e,minSize:t,maxSize:s,itemList:n,itemSet:r,usedSet:i,loadedSet:o,callbacks:c,bytesMap:l,minBytesSize:u,maxBytesSize:h}=this,d=n.length-i.size,f=n.length-o.size,p=Math.max(Math.min(n.length-t,d),0),m=this.cachedBytes-u,g=this.unloadPriorityCallback||this.defaultPriorityCallback;let y=!1;const _=p>0&&d>0||f&&n.length>s;if(d&&this.cachedBytes>u||f&&this.cachedBytes>h||_){n.sort((V,ie)=>{const de=i.has(V),yt=i.has(ie);if(de===yt){const rt=o.has(V),jt=o.has(ie);return rt===jt?-g(V,ie):rt?1:-1}else return de?1:-1});const k=Math.max(t*e,p*e),A=Math.ceil(Math.min(k,d,p)),L=Math.max(e*m,e*u),I=Math.min(L,m);let O=0,R=0;for(;this.cachedBytes-R>h||n.length-O>s;){const V=n[O],ie=l.get(V)||0;if(i.has(V)&&o.has(V)||this.cachedBytes-R-ie<h&&n.length-O<=s)break;R+=ie,O++}for(;R<I||O<A;){const V=n[O],ie=l.get(V)||0;if(i.has(V)||this.cachedBytes-R-ie<u&&O>=A)break;R+=ie,O++}n.splice(0,O).forEach(V=>{this.cachedBytes-=l.get(V)||0,c.get(V)(V),l.delete(V),r.delete(V),c.delete(V),o.delete(V),i.delete(V)}),y=O<p||R<m&&O<d,y=y&&O>0}y&&(this.unloadingHandle=requestAnimationFrame(()=>this.scheduleUnload()))}scheduleUnload(){cancelAnimationFrame(this.unloadingHandle),this.scheduled||(this.scheduled=!0,queueMicrotask(()=>{this.scheduled=!1,this.unloadUnusedContent()}))}}class gs{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.scheduled=!1,this.tryRunJobs()}}sort(){const e=this.priorityCallback;this.items.sort(e)}has(e){return this.callbacks.has(e)}add(e,t){return new Promise((s,n)=>{const r=this.items,i=this.callbacks;r.push(e),i.set(e,{callback:t,resolve:s,reject:n}),this.autoUpdate&&this.scheduleJobRun()})}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);n!==-1&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=0;const r=()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()};for(;s>this.currJobs&&e.length>0&&n<s;){this.currJobs++,n++;const i=e.pop(),{callback:o,resolve:c,reject:l}=t.get(i);t.delete(i);let u;try{u=o(i)}catch(h){l(h),r()}u instanceof Promise?u.then(c).catch(l).finally(r):(c(u),r())}}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const ft=-1,Fe=0,Wt=1,ys=2,Ft=3,bn=6378137,Oo=6356752314245179e-9,Gt={inView:!1,error:1/0,distance:1/0};function qr(a){return a===Ft||a===ft}function Xe(a,e){return a.__lastFrameVisited===e&&a.__used}function en(a){return a.__childrenProcessed===a.children.length}function tn(a,e){a.__lastFrameVisited!==e.frameCount&&(a.__lastFrameVisited=e.frameCount,a.__used=!1,a.__inFrustum=!1,a.__isLeaf=!1,a.__visible=!1,a.__active=!1,a.__error=1/0,a.__distanceFromCamera=1/0,a.__childrenWereVisible=!1,a.__allChildrenLoaded=!1,e.calculateTileViewError(a,Gt),a.__inFrustum=Gt.inView,a.__error=Gt.error,a.__distanceFromCamera=Gt.distance)}function Kr(a,e){if(e.ensureChildrenArePreprocessed(a),tn(a,e),Ks(a,e),!a.__hasRenderableContent&&en(a)){const t=a.children;for(let s=0,n=t.length;s<n;s++)Kr(t[s],e)}}function $r(a,e){if(e.ensureChildrenArePreprocessed(a),Xe(a,e.frameCount)&&(a.__hasContent&&a.__loadingState===Fe&&!e.lruCache.isFull()&&e.queueTileForDownload(a),en(a))){const t=a.children;for(let s=0,n=t.length;s<n;s++)$r(t[s],e)}}function Ks(a,e){a.__used||(a.__used=!0,e.markTileUsed(a),e.stats.used++,a.__inFrustum===!0&&e.stats.inFrustum++)}function Io(a,e){return!(a.__error<=e.errorTarget||e.maxDepth>0&&a.__depth+1>=e.maxDepth||!en(a))}function Xr(a,e=null,t=null){const s=[];for(s.push(a),s.push(null),s.push(0);s.length>0;){const n=s.pop(),r=s.pop(),i=s.pop();if(e&&e(i,r,n)){t&&t(i,r,n);return}const o=i.children;if(o)for(let c=o.length-1;c>=0;c--)s.push(o[c]),s.push(i),s.push(n+1);t&&t(i,r,n)}}function Qr(a,e){if(e.ensureChildrenArePreprocessed(a),tn(a,e),!a.__inFrustum)return;if(!Io(a,e)){Ks(a,e);return}let t=!1,s=!1;const n=a.children;for(let r=0,i=n.length;r<i;r++){const o=n[r];Qr(o,e),t=t||Xe(o,e.frameCount),s=s||o.__inFrustum}if(a.refine==="REPLACE"&&!s&&n.length!==0&&!a.__hasUnrenderableContent){a.__inFrustum=!1;return}if(Ks(a,e),t&&a.refine==="REPLACE")for(let r=0,i=n.length;r<i;r++){const o=n[r];Kr(o,e)}}function Zr(a,e){const t=e.frameCount;if(!Xe(a,t))return;const s=a.children;let n=!1;for(let r=0,i=s.length;r<i;r++){const o=s[r];n=n||Xe(o,t)}if(!n)a.__isLeaf=!0;else{let r=!1,i=!0;for(let o=0,c=s.length;o<c;o++){const l=s[o];if(Zr(l,e),r=r||l.__wasSetVisible||l.__childrenWereVisible,Xe(l,t)){const u=l.__allChildrenLoaded||l.__hasRenderableContent&&qr(l.__loadingState)||!l.__hasContent&&l.children.length===0||l.__hasUnrenderableContent&&l.__loadingState===ft;i=i&&u}}a.__childrenWereVisible=r,a.__allChildrenLoaded=i}}function Yr(a,e){const t=e.stats;if(!Xe(a,e.frameCount))return;const s=e.lruCache;if(a.__isLeaf){a.__loadingState===Ft?(a.__inFrustum&&(a.__visible=!0,t.visible++),a.__active=!0,t.active++):!s.isFull()&&a.__hasContent&&e.queueTileForDownload(a);return}const n=a.children,r=a.__hasContent,i=qr(a.__loadingState)&&r,o=(e.errorTarget+1)*e.errorThreshold,c=a.__error<=o,l=a.__childrenWereVisible,u=a.__allChildrenLoaded;if((c||a.refine==="ADD")&&!i&&!s.isFull()&&r&&e.queueTileForDownload(a),(c&&!u&&!l&&i||a.refine==="ADD"&&i)&&(a.__inFrustum&&(a.__visible=!0,t.visible++),a.__active=!0,t.active++),a.refine==="REPLACE"&&c&&!u)for(let d=0,f=n.length;d<f;d++){const p=n[d];Xe(p,e.frameCount)&&$r(p,e)}else for(let d=0,f=n.length;d<f;d++)Yr(n[d],e)}function Jr(a,e){const t=Xe(a,e.frameCount);if(t||a.__usedLastFrame){let s=!1,n=!1;t?(s=a.__active,e.displayActiveTiles?n=a.__active||a.__visible:n=a.__visible):tn(a,e),a.__hasRenderableContent&&a.__loadingState===Ft&&(a.__wasSetActive!==s&&e.invokeOnePlugin(i=>i.setTileActive&&i.setTileActive(a,s)),a.__wasSetVisible!==n&&e.invokeOnePlugin(i=>i.setTileVisible&&i.setTileVisible(a,n))),a.__wasSetActive=s,a.__wasSetVisible=n,a.__usedLastFrame=t;const r=a.children;for(let i=0,o=r.length;i<o;i++){const c=r[i];Jr(c,e)}}}const wn=Symbol("PLUGIN_REGISTERED"),Ts=(a,e)=>a.__depthFromRenderedParent!==e.__depthFromRenderedParent?a.__depthFromRenderedParent>e.__depthFromRenderedParent?-1:1:a.__inFrustum!==e.__inFrustum?a.__inFrustum?1:-1:a.__used!==e.__used?a.__used?1:-1:a.__error!==e.__error?a.__error>e.__error?1:-1:a.__distanceFromCamera!==e.__distanceFromCamera?a.__distanceFromCamera>e.__distanceFromCamera?-1:1:0,Do=(a,e)=>a.__depthFromRenderedParent!==e.__depthFromRenderedParent?a.__depthFromRenderedParent>e.__depthFromRenderedParent?1:-1:a.__loadingState!==e.__loadingState?a.__loadingState>e.__loadingState?-1:1:a.__lastFrameVisited!==e.__lastFrameVisited?a.__lastFrameVisited>e.__lastFrameVisited?-1:1:a.__hasUnrenderableContent!==e.__hasUnrenderableContent?a.__hasUnrenderableContent?-1:1:a.__error!==e.__error?a.__error>e.__error?-1:1:0;class No{get root(){const e=this.rootTileSet;return e?e.root:null}get loadProgress(){const e=this.stats,t=e.downloading+e.parsing,s=e.inCacheSinceLoad;return s===0?1:1-t/s}get errorThreshold(){return this._errorThreshold}set errorThreshold(e){console.warn('TilesRenderer: The "errorThreshold" option has been deprecated.'),this._errorThreshold=e}constructor(e=null){this.rootLoadingState=Fe,this.rootTileSet=null,this.rootURL=e,this.fetchOptions={},this.plugins=[],this.queuedTiles=[],this.cachedSinceLoadComplete=new Set;const t=new Hr;t.unloadPriorityCallback=Do;const s=new gs;s.maxJobs=10,s.priorityCallback=Ts;const n=new gs;n.maxJobs=1,n.priorityCallback=Ts;const r=new gs;r.maxJobs=25,r.priorityCallback=Ts,r.log=!0,this.visibleTiles=new Set,this.activeTiles=new Set,this.usedSet=new Set,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.processNodeQueue=r,this.stats={inCacheSinceLoad:0,inCache:0,parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this._errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0}registerPlugin(e){if(e[wn]===!0)throw new Error("TilesRendererBase: A plugin can only be registered to a single tile set");const t=this.plugins,s=e.priority||0;let n=t.length;for(let r=0;r<t.length;r++)if((t[r].priority||0)>s){n=r;break}t.splice(n,0,e),e[wn]=!0,e.init&&e.init(this)}unregisterPlugin(e){const t=this.plugins;if(typeof e=="string"&&(e=this.getPluginByName(name)),t.includes(e)){const s=t.indexOf(e);return t.splice(s,1),e.dispose&&e.dispose(),!0}return!1}getPluginByName(e){return this.plugins.find(t=>t.name===e)||null}traverse(e,t,s=!0){this.root&&Xr(this.root,(n,...r)=>(s&&this.ensureChildrenArePreprocessed(n,!0),e?e(n,...r):!1),t)}queueTileForDownload(e){e.__loadingState===Fe&&this.queuedTiles.push(e)}markTileUsed(e){this.usedSet.add(e),this.lruCache.markUsed(e)}update(){const{lruCache:e,usedSet:t,stats:s,root:n}=this;if(this.rootLoadingState===Fe&&(this.rootLoadingState=Wt,this.invokeOnePlugin(i=>i.loadRootTileSet&&i.loadRootTileSet()).then(i=>{this.rootLoadingState=Ft,this.rootTileSet=i,this.dispatchEvent({type:"load-content"}),this.dispatchEvent({type:"load-tile-set",tileSet:i})}).catch(i=>{this.rootLoadingState=ft,console.error(i),this.rootTileSet=null,this.dispatchEvent({type:"load-error",tile:null,error:i})})),!n)return;s.inFrustum=0,s.used=0,s.active=0,s.visible=0,this.frameCount++,t.forEach(i=>e.markUnused(i)),t.clear(),Qr(n,this),Zr(n,this),Yr(n,this),Jr(n,this);const r=this.queuedTiles;r.sort(e.unloadPriorityCallback);for(let i=0,o=r.length;i<o&&!e.isFull();i++)this.requestTileContents(r[i]);r.length=0,e.scheduleUnload()}resetFailedTiles(){this.rootLoadingState===ft&&(this.rootLoadingState=Fe);const e=this.stats;e.failed!==0&&(this.traverse(t=>{t.__loadingState===ft&&(t.__loadingState=Fe)},null,!1),e.failed=0)}dispose(){this.plugins.forEach(s=>{this.unregisterPlugin(s)});const e=this.lruCache,t=[];this.traverse(s=>(t.push(s),!1),null,!1);for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}dispatchEvent(e){}fetchData(e,t){return fetch(e,t)}parseTile(e,t,s){return null}disposeTile(e){e.__visible&&(this.invokeOnePlugin(t=>t.setTileVisible&&t.setTileVisible(e,!1)),e.__visible=!1),e.__active&&(this.invokeOnePlugin(t=>t.setTileActive&&t.setTileActive(e,!1)),e.__active=!1)}preprocessNode(e,t,s=null){var n;if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],(n=e.content)!=null&&n.uri){const r=Tn(e.content.uri);e.__hasContent=!0,e.__hasUnrenderableContent=!!(r&&/json$/.test(r)),e.__hasRenderableContent=!e.__hasUnrenderableContent}else e.__hasContent=!1,e.__hasUnrenderableContent=!1,e.__hasRenderableContent=!1;e.__childrenProcessed=0,s&&s.__childrenProcessed++,e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=Fe,s===null?(e.__depth=0,e.__depthFromRenderedParent=e.__hasRenderableContent?1:0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.__depthFromRenderedParent=s.__depthFromRenderedParent+(e.__hasRenderableContent?1:0),e.refine=e.refine||s.refine),e.__basePath=t,e.__lastFrameVisited=-1,this.invokeAllPlugins(r=>{r!==this&&r.preprocessNode&&r.preprocessNode(e,t,s)})}setTileActive(e,t){t?this.activeTiles.add(e):this.activeTiles.delete(e)}setTileVisible(e,t){t?this.visibleTiles.add(e):this.visibleTiles.delete(e)}calculateTileViewError(e,t){}ensureChildrenArePreprocessed(e,t=!1){const s=e.children;for(let n=0,r=s.length;n<r;n++){const i=s[n];if("__depth"in i)break;t?(this.processNodeQueue.remove(i),this.preprocessNode(i,e.__basePath,e)):this.processNodeQueue.has(i)||this.processNodeQueue.add(i,o=>{this.preprocessNode(o,e.__basePath,e)})}}preprocessTileSet(e,t,s=null){const n=e.asset.version,[r,i]=n.split(".").map(c=>parseInt(c));console.assert(r<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),r===1&&i>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let o=t.replace(/\/[^/]*\/?$/,"");o=new URL(o,window.location.href).toString(),this.preprocessNode(e.root,o,s)}loadRootTileSet(){let e=this.rootURL;return this.invokeAllPlugins(s=>e=s.preprocessURL?s.preprocessURL(e,null):e),this.invokeOnePlugin(s=>s.fetchData&&s.fetchData(e,this.fetchOptions)).then(s=>{if(s.ok)return s.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${s.status} : ${s.statusText}`)}).then(s=>(this.preprocessTileSet(s,e),s))}requestTileContents(e){if(e.__loadingState!==Fe)return;let t=!1,s=new URL(e.content.uri,e.__basePath+"/").toString();this.invokeAllPlugins(d=>s=d.preprocessURL?d.preprocessURL(s,e):s);const n=this.stats,r=this.lruCache,i=this.downloadQueue,o=this.parseQueue,c=Tn(s),l=new AbortController,u=l.signal;if(r.add(e,d=>{l.abort(),t?(d.children.length=0,d.__childrenProcessed=0):this.invokeAllPlugins(f=>{f.disposeTile&&f.disposeTile(d)}),n.inCache--,this.cachedSinceLoadComplete.has(e)&&(this.cachedSinceLoadComplete.delete(e),n.inCacheSinceLoad--),d.__loadingState===Wt?n.downloading--:d.__loadingState===ys&&n.parsing--,d.__loadingState=Fe,o.remove(d),i.remove(d)}))return n.parsing===0&&n.downloading===0&&this.dispatchEvent({type:"tiles-load-start"}),this.cachedSinceLoadComplete.add(e),n.inCacheSinceLoad++,n.inCache++,n.downloading++,e.__loadingState=Wt,i.add(e,d=>u.aborted?Promise.resolve():this.invokeOnePlugin(f=>f.fetchData&&f.fetchData(s,{...this.fetchOptions,signal:u}))).then(d=>{if(!u.aborted){if(d.ok)return c==="json"?d.json():d.arrayBuffer();throw new Error(`Failed to load model with error code ${d.status}`)}}).then(d=>{if(!u.aborted)return n.downloading--,n.parsing++,e.__loadingState=ys,o.add(e,f=>u.aborted?Promise.resolve():c==="json"&&d.root?(this.preprocessTileSet(d,s,e),e.children.push(d.root),t=!0,Promise.resolve()):this.invokeOnePlugin(p=>p.parseTile&&p.parseTile(d,f,c,s,u)))}).then(()=>{u.aborted||(n.parsing--,e.__loadingState=Ft,r.setLoaded(e,!0),r.getMemoryUsage(e)===null&&(r.isFull()&&r.computeMemoryUsageCallback(e)>0?r.remove(e):r.updateMemoryUsage(e)),this.dispatchEvent({type:"load-content"}),e.cached.scene&&this.dispatchEvent({type:"load-model",scene:e.cached.scene,tile:e}))}).catch(d=>{u.aborted||(d.name!=="AbortError"?(o.remove(e),i.remove(e),e.__loadingState===ys?n.parsing--:e.__loadingState===Wt&&n.downloading--,n.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(d),e.__loadingState=ft,r.setLoaded(e,!0),this.dispatchEvent({type:"load-error",tile:e,error:d,uri:s})):r.remove(e))}).finally(()=>{n.parsing===0&&n.downloading===0&&(this.cachedSinceLoadComplete.clear(),n.inCacheSinceLoad=0,this.dispatchEvent({type:"tiles-load-end"}))})}getAttributions(e=[]){return this.invokeAllPlugins(t=>t!==this&&t.getAttributions&&t.getAttributions(e)),e}invokeOnePlugin(e){const t=[...this.plugins,this];for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}invokeAllPlugins(e){const t=[...this.plugins,this],s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return s.length===0?null:Promise.all(s)}}const Fo=new TextDecoder;function ei(a){return Fo.decode(a)}function ti(a,e,t,s,n,r){let i;switch(s){case"SCALAR":i=1;break;case"VEC2":i=2;break;case"VEC3":i=3;break;case"VEC4":i=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${r}".`)}let o;const c=t*i;switch(n){case"BYTE":o=new Int8Array(a,e,c);break;case"UNSIGNED_BYTE":o=new Uint8Array(a,e,c);break;case"SHORT":o=new Int16Array(a,e,c);break;case"UNSIGNED_SHORT":o=new Uint16Array(a,e,c);break;case"INT":o=new Int32Array(a,e,c);break;case"UNSIGNED_INT":o=new Uint32Array(a,e,c);break;case"FLOAT":o=new Float32Array(a,e,c);break;case"DOUBLE":o=new Float64Array(a,e,c);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${r}".`)}return o}class cs{constructor(e,t,s,n){this.buffer=e,this.binOffset=t+s,this.binLength=n;let r=null;if(s!==0){const i=new Uint8Array(e,t,s);r=JSON.parse(ei(i))}else r={};this.header=r}getKeys(){return Object.keys(this.header)}getData(e,t,s=null,n=null){const r=this.header;if(!(e in r))return null;const i=r[e];if(i instanceof Object){if(Array.isArray(i))return i;{const{buffer:o,binOffset:c,binLength:l}=this,u=i.byteOffset||0,h=i.type||n,d=i.componentType||s;if("type"in i&&n&&i.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");const f=c+u,p=ti(o,f,t,h,d,e);if(f+p.byteLength>c+l)throw new Error("FeatureTable: Feature data read outside binary body length.");return p}}else return i}getBuffer(e,t){const{buffer:s,binOffset:n}=this;return s.slice(n+e,n+e+t)}}class Uo{constructor(e){this.batchTable=e;const t=e.header.extensions["3DTILES_batch_table_hierarchy"];this.classes=t.classes;for(const n of this.classes){const r=n.instances;for(const i in r)n.instances[i]=this._parseProperty(r[i],n.length,i)}if(this.instancesLength=t.instancesLength,this.classIds=this._parseProperty(t.classIds,this.instancesLength,"classIds"),t.parentCounts?this.parentCounts=this._parseProperty(t.parentCounts,this.instancesLength,"parentCounts"):this.parentCounts=new Array(this.instancesLength).fill(1),t.parentIds){const n=this.parentCounts.reduce((r,i)=>r+i,0);this.parentIds=this._parseProperty(t.parentIds,n,"parentIds")}else this.parentIds=null;this.instancesIds=[];const s={};for(const n of this.classIds)s[n]=s[n]??0,this.instancesIds.push(s[n]),s[n]++}_parseProperty(e,t,s){if(Array.isArray(e))return e;{const{buffer:n,binOffset:r}=this.batchTable,i=e.byteOffset,o=e.componentType||"UNSIGNED_SHORT",c=r+i;return ti(n,c,t,"SCALAR",o,s)}}getDataFromId(e,t={}){const s=this.parentCounts[e];if(this.parentIds&&s>0){let c=0;for(let l=0;l<e;l++)c+=this.parentCounts[l];for(let l=0;l<s;l++){const u=this.parentIds[c+l];u!==e&&this.getDataFromId(u,t)}}const n=this.classIds[e],r=this.classes[n].instances,i=this.classes[n].name,o=this.instancesIds[e];for(const c in r)t[i]=t[i]||{},t[i][c]=r[c][o];return t}}class sn extends cs{get batchSize(){return console.warn("BatchTable.batchSize has been deprecated and replaced with BatchTable.count."),this.count}constructor(e,t,s,n,r){super(e,s,n,r),this.count=t,this.extensions={};const i=this.header.extensions;i&&i["3DTILES_batch_table_hierarchy"]&&(this.extensions["3DTILES_batch_table_hierarchy"]=new Uo(this))}getData(e,t=null,s=null){return console.warn("BatchTable: BatchTable.getData is deprecated. Use BatchTable.getDataFromId to get allproperties for an id or BatchTable.getPropertyArray for getting an array of value for a property."),super.getData(e,this.count,t,s)}getDataFromId(e,t={}){if(e<0||e>=this.count)throw new Error(`BatchTable: id value "${e}" out of bounds for "${this.count}" features number.`);for(const s of this.getKeys())s!=="extensions"&&(t[s]=super.getData(s,this.count)[e]);for(const s in this.extensions){const n=this.extensions[s];n.getDataFromId instanceof Function&&(t[s]=t[s]||{},n.getDataFromId(e,t[s]))}return t}getPropertyArray(e){return super.getData(e,this.count)}}class ls{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return console.warn('Loader: "load" function has been deprecated in favor of "loadAsync".'),this.loadAsync(e)}loadAsync(e){return fetch(e,this.fetchOptions).then(t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()}).then(t=>(this.workingPath===""&&(this.workingPath=this.workingPathForURL(e)),this.parse(t)))}resolveExternalURL(e){return/^[^\\/]/.test(e)&&!/^http/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);return t.pop(),t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}function gt(a){let e;if(a instanceof DataView?e=a:e=new DataView(a),String.fromCharCode(e.getUint8(0))==="{")return null;let t="";for(let s=0;s<4;s++)t+=String.fromCharCode(e.getUint8(s));return t}class Bo extends ls{parse(e){const t=new DataView(e),s=gt(t);console.assert(s==="b3dm");const n=t.getUint32(4,!0);console.assert(n===1);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),c=t.getUint32(20,!0),l=t.getUint32(24,!0),u=28,h=e.slice(u,u+i+o),d=new cs(h,0,i,o),f=u+i+o,p=e.slice(f,f+c+l),m=new sn(p,d.getData("BATCH_LENGTH"),0,c,l),g=f+c+l,y=new Uint8Array(e,g,r-g);return{version:n,featureTable:d,batchTable:m,glbBytes:y}}}function Vo(a){let e=0;for(const s in a.attributes){const n=a.getAttribute(s);e+=n.count*n.itemSize*n.array.BYTES_PER_ELEMENT}const t=a.getIndex();return e+=t?t.count*t.itemSize*t.array.BYTES_PER_ELEMENT:0,e}function xn(a,e){if(e===Bi)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),a;if(e===Hs||e===kr){let t=a.getIndex();if(t===null){const i=[],o=a.getAttribute("position");if(o!==void 0){for(let c=0;c<o.count;c++)i.push(c);a.setIndex(i),t=a.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),a}const s=t.count-2,n=[];if(e===Hs)for(let i=1;i<=s;i++)n.push(t.getX(0)),n.push(t.getX(i)),n.push(t.getX(i+1));else for(let i=0;i<s;i++)i%2===0?(n.push(t.getX(i)),n.push(t.getX(i+1)),n.push(t.getX(i+2))):(n.push(t.getX(i+2)),n.push(t.getX(i+1)),n.push(t.getX(i)));n.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=a.clone();return r.setIndex(n),r.clearGroups(),r}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),a}class us extends Rr{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new Ho(t)}),this.register(function(t){return new qo(t)}),this.register(function(t){return new ta(t)}),this.register(function(t){return new sa(t)}),this.register(function(t){return new na(t)}),this.register(function(t){return new $o(t)}),this.register(function(t){return new Xo(t)}),this.register(function(t){return new Qo(t)}),this.register(function(t){return new Zo(t)}),this.register(function(t){return new Go(t)}),this.register(function(t){return new Yo(t)}),this.register(function(t){return new Ko(t)}),this.register(function(t){return new ea(t)}),this.register(function(t){return new Jo(t)}),this.register(function(t){return new jo(t)}),this.register(function(t){return new ra(t)}),this.register(function(t){return new ia(t)})}load(e,t,s,n){const r=this;let i;if(this.resourcePath!=="")i=this.resourcePath;else if(this.path!==""){const l=It.extractUrlBase(e);i=It.resolveURL(l,this.path)}else i=It.extractUrlBase(e);this.manager.itemStart(e);const o=function(l){n?n(l):console.error(l),r.manager.itemError(e),r.manager.itemEnd(e)},c=new Dt(this.manager);c.setPath(this.path),c.setResponseType("arraybuffer"),c.setRequestHeader(this.requestHeader),c.setWithCredentials(this.withCredentials),c.load(e,function(l){try{r.parse(l,i,function(u){t(u),r.manager.itemEnd(e)},o)}catch(u){o(u)}},s,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let r;const i={},o={},c=new TextDecoder;if(typeof e=="string")r=JSON.parse(e);else if(e instanceof ArrayBuffer)if(c.decode(new Uint8Array(e,0,4))===si){try{i[G.KHR_BINARY_GLTF]=new oa(e)}catch(h){n&&n(h);return}r=JSON.parse(i[G.KHR_BINARY_GLTF].content)}else r=JSON.parse(c.decode(e));else r=e;if(r.asset===void 0||r.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const l=new _a(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let u=0;u<this.pluginCallbacks.length;u++){const h=this.pluginCallbacks[u](l);h.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),o[h.name]=h,i[h.name]=!0}if(r.extensionsUsed)for(let u=0;u<r.extensionsUsed.length;++u){const h=r.extensionsUsed[u],d=r.extensionsRequired||[];switch(h){case G.KHR_MATERIALS_UNLIT:i[h]=new Wo;break;case G.KHR_DRACO_MESH_COMPRESSION:i[h]=new aa(r,this.dracoLoader);break;case G.KHR_TEXTURE_TRANSFORM:i[h]=new ca;break;case G.KHR_MESH_QUANTIZATION:i[h]=new la;break;default:d.indexOf(h)>=0&&o[h]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+h+'".')}}l.setExtensions(i),l.setPlugins(o),l.parse(s,n)}parseAsync(e,t){const s=this;return new Promise(function(n,r){s.parse(e,t,n,r)})}}function zo(){let a={};return{get:function(e){return a[e]},add:function(e,t){a[e]=t},remove:function(e){delete a[e]},removeAll:function(){a={}}}}const G={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class jo{constructor(e){this.parser=e,this.name=G.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const r=t[s];r.extensions&&r.extensions[this.name]&&r.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let n=t.cache.get(s);if(n)return n;const r=t.json,c=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let l;const u=new Qe(16777215);c.color!==void 0&&u.setRGB(c.color[0],c.color[1],c.color[2],Be);const h=c.range!==void 0?c.range:0;switch(c.type){case"directional":l=new ji(u),l.target.position.set(0,0,-1),l.add(l.target);break;case"point":l=new zi(u),l.distance=h;break;case"spot":l=new Vi(u),l.distance=h,c.spot=c.spot||{},c.spot.innerConeAngle=c.spot.innerConeAngle!==void 0?c.spot.innerConeAngle:0,c.spot.outerConeAngle=c.spot.outerConeAngle!==void 0?c.spot.outerConeAngle:Math.PI/4,l.angle=c.spot.outerConeAngle,l.penumbra=1-c.spot.innerConeAngle/c.spot.outerConeAngle,l.target.position.set(0,0,-1),l.add(l.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+c.type)}return l.position.set(0,0,0),Ue(l,c),c.intensity!==void 0&&(l.intensity=c.intensity),l.name=t.createUniqueName(c.name||"light_"+e),n=Promise.resolve(l),t.cache.add(s,n),n}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,r=s.json.nodes[e],o=(r.extensions&&r.extensions[this.name]||{}).light;return o===void 0?null:this._loadLight(o).then(function(c){return s._getNodeRef(t.cache,o,c)})}}class Wo{constructor(){this.name=G.KHR_MATERIALS_UNLIT}getMaterialType(){return dt}extendParams(e,t,s){const n=[];e.color=new Qe(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const i=r.baseColorFactor;e.color.setRGB(i[0],i[1],i[2],Be),e.opacity=i[3]}r.baseColorTexture!==void 0&&n.push(s.assignTexture(e,"map",r.baseColorTexture,Nt))}return Promise.all(n)}}class Go{constructor(e){this.parser=e,this.name=G.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name].emissiveStrength;return r!==void 0&&(t.emissiveIntensity=r),Promise.resolve()}}class Ho{constructor(e){this.parser=e,this.name=G.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ke}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];if(i.clearcoatFactor!==void 0&&(t.clearcoat=i.clearcoatFactor),i.clearcoatTexture!==void 0&&r.push(s.assignTexture(t,"clearcoatMap",i.clearcoatTexture)),i.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=i.clearcoatRoughnessFactor),i.clearcoatRoughnessTexture!==void 0&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",i.clearcoatRoughnessTexture)),i.clearcoatNormalTexture!==void 0&&(r.push(s.assignTexture(t,"clearcoatNormalMap",i.clearcoatNormalTexture)),i.clearcoatNormalTexture.scale!==void 0)){const o=i.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Y(o,o)}return Promise.all(r)}}class qo{constructor(e){this.parser=e,this.name=G.KHR_MATERIALS_DISPERSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ke}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name];return t.dispersion=r.dispersion!==void 0?r.dispersion:0,Promise.resolve()}}class Ko{constructor(e){this.parser=e,this.name=G.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ke}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];return i.iridescenceFactor!==void 0&&(t.iridescence=i.iridescenceFactor),i.iridescenceTexture!==void 0&&r.push(s.assignTexture(t,"iridescenceMap",i.iridescenceTexture)),i.iridescenceIor!==void 0&&(t.iridescenceIOR=i.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),i.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=i.iridescenceThicknessMinimum),i.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=i.iridescenceThicknessMaximum),i.iridescenceThicknessTexture!==void 0&&r.push(s.assignTexture(t,"iridescenceThicknessMap",i.iridescenceThicknessTexture)),Promise.all(r)}}class $o{constructor(e){this.parser=e,this.name=G.KHR_MATERIALS_SHEEN}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ke}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new Qe(0,0,0),t.sheenRoughness=0,t.sheen=1;const i=n.extensions[this.name];if(i.sheenColorFactor!==void 0){const o=i.sheenColorFactor;t.sheenColor.setRGB(o[0],o[1],o[2],Be)}return i.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=i.sheenRoughnessFactor),i.sheenColorTexture!==void 0&&r.push(s.assignTexture(t,"sheenColorMap",i.sheenColorTexture,Nt)),i.sheenRoughnessTexture!==void 0&&r.push(s.assignTexture(t,"sheenRoughnessMap",i.sheenRoughnessTexture)),Promise.all(r)}}class Xo{constructor(e){this.parser=e,this.name=G.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ke}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];return i.transmissionFactor!==void 0&&(t.transmission=i.transmissionFactor),i.transmissionTexture!==void 0&&r.push(s.assignTexture(t,"transmissionMap",i.transmissionTexture)),Promise.all(r)}}class Qo{constructor(e){this.parser=e,this.name=G.KHR_MATERIALS_VOLUME}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ke}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];t.thickness=i.thicknessFactor!==void 0?i.thicknessFactor:0,i.thicknessTexture!==void 0&&r.push(s.assignTexture(t,"thicknessMap",i.thicknessTexture)),t.attenuationDistance=i.attenuationDistance||1/0;const o=i.attenuationColor||[1,1,1];return t.attenuationColor=new Qe().setRGB(o[0],o[1],o[2],Be),Promise.all(r)}}class Zo{constructor(e){this.parser=e,this.name=G.KHR_MATERIALS_IOR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ke}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name];return t.ior=r.ior!==void 0?r.ior:1.5,Promise.resolve()}}class Yo{constructor(e){this.parser=e,this.name=G.KHR_MATERIALS_SPECULAR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ke}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];t.specularIntensity=i.specularFactor!==void 0?i.specularFactor:1,i.specularTexture!==void 0&&r.push(s.assignTexture(t,"specularIntensityMap",i.specularTexture));const o=i.specularColorFactor||[1,1,1];return t.specularColor=new Qe().setRGB(o[0],o[1],o[2],Be),i.specularColorTexture!==void 0&&r.push(s.assignTexture(t,"specularColorMap",i.specularColorTexture,Nt)),Promise.all(r)}}class Jo{constructor(e){this.parser=e,this.name=G.EXT_MATERIALS_BUMP}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ke}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];return t.bumpScale=i.bumpFactor!==void 0?i.bumpFactor:1,i.bumpTexture!==void 0&&r.push(s.assignTexture(t,"bumpMap",i.bumpTexture)),Promise.all(r)}}class ea{constructor(e){this.parser=e,this.name=G.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ke}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];return i.anisotropyStrength!==void 0&&(t.anisotropy=i.anisotropyStrength),i.anisotropyRotation!==void 0&&(t.anisotropyRotation=i.anisotropyRotation),i.anisotropyTexture!==void 0&&r.push(s.assignTexture(t,"anisotropyMap",i.anisotropyTexture)),Promise.all(r)}}class ta{constructor(e){this.parser=e,this.name=G.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const r=n.extensions[this.name],i=t.options.ktx2Loader;if(!i){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,i)}}class sa{constructor(e){this.parser=e,this.name=G.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const i=r.extensions[t],o=n.images[i.source];let c=s.textureLoader;if(o.uri){const l=s.options.manager.getHandler(o.uri);l!==null&&(c=l)}return this.detectSupport().then(function(l){if(l)return s.loadTextureImage(e,i.source,c);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class na{constructor(e){this.parser=e,this.name=G.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const i=r.extensions[t],o=n.images[i.source];let c=s.textureLoader;if(o.uri){const l=s.options.manager.getHandler(o.uri);l!==null&&(c=l)}return this.detectSupport().then(function(l){if(l)return s.loadTextureImage(e,i.source,c);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class ra{constructor(e){this.name=G.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const n=s.extensions[this.name],r=this.parser.getDependency("buffer",n.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then(function(o){const c=n.byteOffset||0,l=n.byteLength||0,u=n.count,h=n.byteStride,d=new Uint8Array(o,c,l);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(u,h,d,n.mode,n.filter).then(function(f){return f.buffer}):i.ready.then(function(){const f=new ArrayBuffer(u*h);return i.decodeGltfBuffer(new Uint8Array(f),u,h,d,n.mode,n.filter),f})})}else return null}}class ia{constructor(e){this.name=G.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||s.mesh===void 0)return null;const n=t.meshes[s.mesh];for(const l of n.primitives)if(l.mode!==Se.TRIANGLES&&l.mode!==Se.TRIANGLE_STRIP&&l.mode!==Se.TRIANGLE_FAN&&l.mode!==void 0)return null;const i=s.extensions[this.name].attributes,o=[],c={};for(const l in i)o.push(this.parser.getDependency("accessor",i[l]).then(u=>(c[l]=u,c[l])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(l=>{const u=l.pop(),h=u.isGroup?u.children:[u],d=l[0].count,f=[];for(const p of h){const m=new Z,g=new S,y=new Re,_=new S(1,1,1),C=new Lr(p.geometry,p.material,d);for(let k=0;k<d;k++)c.TRANSLATION&&g.fromBufferAttribute(c.TRANSLATION,k),c.ROTATION&&y.fromBufferAttribute(c.ROTATION,k),c.SCALE&&_.fromBufferAttribute(c.SCALE,k),C.setMatrixAt(k,m.compose(g,y,_));for(const k in c)if(k==="_COLOR_0"){const A=c[k];C.instanceColor=new Wi(A.array,A.itemSize,A.normalized)}else k!=="TRANSLATION"&&k!=="ROTATION"&&k!=="SCALE"&&p.geometry.setAttribute(k,c[k]);Or.prototype.copy.call(C,p),this.parser.assignFinalMaterial(C),f.push(C)}return u.isGroup?(u.clear(),u.add(...f),u):f[0]}))}}const si="glTF",Tt=12,An={JSON:1313821514,BIN:5130562};class oa{constructor(e){this.name=G.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Tt),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==si)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-Tt,r=new DataView(e,Tt);let i=0;for(;i<n;){const o=r.getUint32(i,!0);i+=4;const c=r.getUint32(i,!0);if(i+=4,c===An.JSON){const l=new Uint8Array(e,Tt+i,o);this.content=s.decode(l)}else if(c===An.BIN){const l=Tt+i;this.body=e.slice(l,l+o)}i+=o}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class aa{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=G.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,r=e.extensions[this.name].bufferView,i=e.extensions[this.name].attributes,o={},c={},l={};for(const u in i){const h=$s[u]||u.toLowerCase();o[h]=i[u]}for(const u in e.attributes){const h=$s[u]||u.toLowerCase();if(i[u]!==void 0){const d=s.accessors[e.attributes[u]],f=mt[d.componentType];l[h]=f.name,c[h]=d.normalized===!0}}return t.getDependency("bufferView",r).then(function(u){return new Promise(function(h,d){n.decodeDracoFile(u,function(f){for(const p in f.attributes){const m=f.attributes[p],g=c[p];g!==void 0&&(m.normalized=g)}h(f)},o,l,Be,d)})})}}class ca{constructor(){this.name=G.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class la{constructor(){this.name=G.KHR_MESH_QUANTIZATION}}class ni extends fo{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,r=e*n*3+n;for(let i=0;i!==n;i++)t[i]=s[r+i];return t}interpolate_(e,t,s,n){const r=this.resultBuffer,i=this.sampleValues,o=this.valueSize,c=o*2,l=o*3,u=n-t,h=(s-t)/u,d=h*h,f=d*h,p=e*l,m=p-l,g=-2*f+3*d,y=f-d,_=1-g,C=y-d+h;for(let k=0;k!==o;k++){const A=i[m+k+o],L=i[m+k+c]*u,I=i[p+k+o],O=i[p+k]*u;r[k]=_*A+C*L+g*I+y*O}return r}}const ua=new Re;class ha extends ni{interpolate_(e,t,s,n){const r=super.interpolate_(e,t,s,n);return ua.fromArray(r).normalize().toArray(r),r}}const Se={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},mt={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},vn={9728:Dr,9729:ss,9984:Xi,9985:$i,9986:Ki,9987:Ir},En={33071:Zi,33648:Qi,10497:qs},_s={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},$s={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ze={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},da={CUBICSPLINE:void 0,LINEAR:Vr,STEP:lo},bs={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function fa(a){return a.DefaultMaterial===void 0&&(a.DefaultMaterial=new Fr({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:ho})),a.DefaultMaterial}function Ye(a,e,t){for(const s in t.extensions)a[s]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=t.extensions[s])}function Ue(a,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(a.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function pa(a,e,t){let s=!1,n=!1,r=!1;for(let l=0,u=e.length;l<u;l++){const h=e[l];if(h.POSITION!==void 0&&(s=!0),h.NORMAL!==void 0&&(n=!0),h.COLOR_0!==void 0&&(r=!0),s&&n&&r)break}if(!s&&!n&&!r)return Promise.resolve(a);const i=[],o=[],c=[];for(let l=0,u=e.length;l<u;l++){const h=e[l];if(s){const d=h.POSITION!==void 0?t.getDependency("accessor",h.POSITION):a.attributes.position;i.push(d)}if(n){const d=h.NORMAL!==void 0?t.getDependency("accessor",h.NORMAL):a.attributes.normal;o.push(d)}if(r){const d=h.COLOR_0!==void 0?t.getDependency("accessor",h.COLOR_0):a.attributes.color;c.push(d)}}return Promise.all([Promise.all(i),Promise.all(o),Promise.all(c)]).then(function(l){const u=l[0],h=l[1],d=l[2];return s&&(a.morphAttributes.position=u),n&&(a.morphAttributes.normal=h),r&&(a.morphAttributes.color=d),a.morphTargetsRelative=!0,a})}function ma(a,e){if(a.updateMorphTargets(),e.weights!==void 0)for(let t=0,s=e.weights.length;t<s;t++)a.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(a.morphTargetInfluences.length===t.length){a.morphTargetDictionary={};for(let s=0,n=t.length;s<n;s++)a.morphTargetDictionary[t[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function ga(a){let e;const t=a.extensions&&a.extensions[G.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+ws(t.attributes):e=a.indices+":"+ws(a.attributes)+":"+a.mode,a.targets!==void 0)for(let s=0,n=a.targets.length;s<n;s++)e+=":"+ws(a.targets[s]);return e}function ws(a){let e="";const t=Object.keys(a).sort();for(let s=0,n=t.length;s<n;s++)e+=t[s]+":"+a[t[s]]+";";return e}function Xs(a){switch(a){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function ya(a){return a.search(/\.jpe?g($|\?)/i)>0||a.search(/^data\:image\/jpeg/)===0?"image/jpeg":a.search(/\.webp($|\?)/i)>0||a.search(/^data\:image\/webp/)===0?"image/webp":a.search(/\.ktx2($|\?)/i)>0||a.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const Ta=new Z;class _a{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new zo,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=-1,r=!1,i=-1;if(typeof navigator<"u"){const o=navigator.userAgent;s=/^((?!chrome|android).)*safari/i.test(o)===!0;const c=o.match(/Version\/(\d+)/);n=s&&c?parseInt(c[1],10):-1,r=o.indexOf("Firefox")>-1,i=r?o.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||s&&n<17||r&&i<98?this.textureLoader=new Gi(this.options.manager):this.textureLoader=new Hi(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Dt(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(i){return i._markDefs&&i._markDefs()}),Promise.all(this._invokeAll(function(i){return i.beforeRoot&&i.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(i){const o={scene:i[0][n.scene||0],scenes:i[0],animations:i[1],cameras:i[2],asset:n.asset,parser:s,userData:{}};return Ye(r,o,n),Ue(o,n),Promise.all(s._invokeAll(function(c){return c.afterRoot&&c.afterRoot(o)})).then(function(){for(const c of o.scenes)c.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){const i=t[n].joints;for(let o=0,c=i.length;o<c;o++)e[i[o]].isBone=!0}for(let n=0,r=e.length;n<r;n++){const i=e[n];i.mesh!==void 0&&(this._addNodeRef(this.meshCache,i.mesh),i.skin!==void 0&&(s[i.mesh].isSkinnedMesh=!0)),i.camera!==void 0&&this._addNodeRef(this.cameraCache,i.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone(),r=(i,o)=>{const c=this.associations.get(i);c!=null&&this.associations.set(o,c);for(const[l,u]of i.children.entries())r(u,o.children[l])};return r(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(r){return r.loadNode&&r.loadNode(t)});break;case"mesh":n=this._invokeOne(function(r){return r.loadMesh&&r.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(r){return r.loadBufferView&&r.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(r){return r.loadMaterial&&r.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(r){return r.loadTexture&&r.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(r){return r.loadAnimation&&r.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(r){return r!=this&&r.getDependency&&r.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e);break}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(n.map(function(r,i){return s.getDependency(e,i)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[G.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(r,i){s.load(It.resolveURL(t.uri,n.path),r,void 0,function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(s){const n=t.byteLength||0,r=t.byteOffset||0;return s.slice(r,r+n)})}loadAccessor(e){const t=this,s=this.json,n=this.json.accessors[e];if(n.bufferView===void 0&&n.sparse===void 0){const i=_s[n.type],o=mt[n.componentType],c=n.normalized===!0,l=new o(n.count*i);return Promise.resolve(new ge(l,i,c))}const r=[];return n.bufferView!==void 0?r.push(this.getDependency("bufferView",n.bufferView)):r.push(null),n.sparse!==void 0&&(r.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(r).then(function(i){const o=i[0],c=_s[n.type],l=mt[n.componentType],u=l.BYTES_PER_ELEMENT,h=u*c,d=n.byteOffset||0,f=n.bufferView!==void 0?s.bufferViews[n.bufferView].byteStride:void 0,p=n.normalized===!0;let m,g;if(f&&f!==h){const y=Math.floor(d/f),_="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+y+":"+n.count;let C=t.cache.get(_);C||(m=new l(o,y*f,n.count*f/u),C=new qi(m,f/u),t.cache.add(_,C)),g=new uo(C,c,d%f/u,p)}else o===null?m=new l(n.count*c):m=new l(o,d,n.count*c),g=new ge(m,c,p);if(n.sparse!==void 0){const y=_s.SCALAR,_=mt[n.sparse.indices.componentType],C=n.sparse.indices.byteOffset||0,k=n.sparse.values.byteOffset||0,A=new _(i[1],C,n.sparse.count*y),L=new l(i[2],k,n.sparse.count*c);o!==null&&(g=new ge(g.array.slice(),g.itemSize,g.normalized)),g.normalized=!1;for(let I=0,O=A.length;I<O;I++){const R=A[I];if(g.setX(R,L[I*c]),c>=2&&g.setY(R,L[I*c+1]),c>=3&&g.setZ(R,L[I*c+2]),c>=4&&g.setW(R,L[I*c+3]),c>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}g.normalized=p}return g})}loadTexture(e){const t=this.json,s=this.options,r=t.textures[e].source,i=t.images[r];let o=this.textureLoader;if(i.uri){const c=s.manager.getHandler(i.uri);c!==null&&(o=c)}return this.loadTextureImage(e,r,o)}loadTextureImage(e,t,s){const n=this,r=this.json,i=r.textures[e],o=r.images[t],c=(o.uri||o.bufferView)+":"+i.sampler;if(this.textureCache[c])return this.textureCache[c];const l=this.loadImageSource(t,s).then(function(u){u.flipY=!1,u.name=i.name||o.name||"",u.name===""&&typeof o.uri=="string"&&o.uri.startsWith("data:image/")===!1&&(u.name=o.uri);const d=(r.samplers||{})[i.sampler]||{};return u.magFilter=vn[d.magFilter]||ss,u.minFilter=vn[d.minFilter]||Ir,u.wrapS=En[d.wrapS]||qs,u.wrapT=En[d.wrapT]||qs,u.generateMipmaps=!u.isCompressedTexture&&u.minFilter!==Dr&&u.minFilter!==ss,n.associations.set(u,{textures:e}),u}).catch(function(){return null});return this.textureCache[c]=l,l}loadImageSource(e,t){const s=this,n=this.json,r=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(h=>h.clone());const i=n.images[e],o=self.URL||self.webkitURL;let c=i.uri||"",l=!1;if(i.bufferView!==void 0)c=s.getDependency("bufferView",i.bufferView).then(function(h){l=!0;const d=new Blob([h],{type:i.mimeType});return c=o.createObjectURL(d),c});else if(i.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const u=Promise.resolve(c).then(function(h){return new Promise(function(d,f){let p=d;t.isImageBitmapLoader===!0&&(p=function(m){const g=new hn(m);g.needsUpdate=!0,d(g)}),t.load(It.resolveURL(h,r.path),p,void 0,f)})}).then(function(h){return l===!0&&o.revokeObjectURL(c),Ue(h,i),h.userData.mimeType=i.mimeType||ya(i.uri),h}).catch(function(h){throw console.error("THREE.GLTFLoader: Couldn't load texture",c),h});return this.sourceCache[e]=u,u}assignTexture(e,t,s,n){const r=this;return this.getDependency("texture",s.index).then(function(i){if(!i)return null;if(s.texCoord!==void 0&&s.texCoord>0&&(i=i.clone(),i.channel=s.texCoord),r.extensions[G.KHR_TEXTURE_TRANSFORM]){const o=s.extensions!==void 0?s.extensions[G.KHR_TEXTURE_TRANSFORM]:void 0;if(o){const c=r.associations.get(i);i=r.extensions[G.KHR_TEXTURE_TRANSFORM].extendTexture(i,o),r.associations.set(i,c)}}return n!==void 0&&(i.colorSpace=n),e[t]=i,i})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const n=t.attributes.tangent===void 0,r=t.attributes.color!==void 0,i=t.attributes.normal===void 0;if(e.isPoints){const o="PointsMaterial:"+s.uuid;let c=this.cache.get(o);c||(c=new Nr,ms.prototype.copy.call(c,s),c.color.copy(s.color),c.map=s.map,c.sizeAttenuation=!1,this.cache.add(o,c)),s=c}else if(e.isLine){const o="LineBasicMaterial:"+s.uuid;let c=this.cache.get(o);c||(c=new Yi,ms.prototype.copy.call(c,s),c.color.copy(s.color),c.map=s.map,this.cache.add(o,c)),s=c}if(n||r||i){let o="ClonedMaterial:"+s.uuid+":";n&&(o+="derivative-tangents:"),r&&(o+="vertex-colors:"),i&&(o+="flat-shading:");let c=this.cache.get(o);c||(c=s.clone(),r&&(c.vertexColors=!0),i&&(c.flatShading=!0),n&&(c.normalScale&&(c.normalScale.y*=-1),c.clearcoatNormalScale&&(c.clearcoatNormalScale.y*=-1)),this.cache.add(o,c),this.associations.set(c,this.associations.get(s))),s=c}e.material=s}getMaterialType(){return Fr}loadMaterial(e){const t=this,s=this.json,n=this.extensions,r=s.materials[e];let i;const o={},c=r.extensions||{},l=[];if(c[G.KHR_MATERIALS_UNLIT]){const h=n[G.KHR_MATERIALS_UNLIT];i=h.getMaterialType(),l.push(h.extendParams(o,r,t))}else{const h=r.pbrMetallicRoughness||{};if(o.color=new Qe(1,1,1),o.opacity=1,Array.isArray(h.baseColorFactor)){const d=h.baseColorFactor;o.color.setRGB(d[0],d[1],d[2],Be),o.opacity=d[3]}h.baseColorTexture!==void 0&&l.push(t.assignTexture(o,"map",h.baseColorTexture,Nt)),o.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,o.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(l.push(t.assignTexture(o,"metalnessMap",h.metallicRoughnessTexture)),l.push(t.assignTexture(o,"roughnessMap",h.metallicRoughnessTexture))),i=this._invokeOne(function(d){return d.getMaterialType&&d.getMaterialType(e)}),l.push(Promise.all(this._invokeAll(function(d){return d.extendMaterialParams&&d.extendMaterialParams(e,o)})))}r.doubleSided===!0&&(o.side=Ji);const u=r.alphaMode||bs.OPAQUE;if(u===bs.BLEND?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,u===bs.MASK&&(o.alphaTest=r.alphaCutoff!==void 0?r.alphaCutoff:.5)),r.normalTexture!==void 0&&i!==dt&&(l.push(t.assignTexture(o,"normalMap",r.normalTexture)),o.normalScale=new Y(1,1),r.normalTexture.scale!==void 0)){const h=r.normalTexture.scale;o.normalScale.set(h,h)}if(r.occlusionTexture!==void 0&&i!==dt&&(l.push(t.assignTexture(o,"aoMap",r.occlusionTexture)),r.occlusionTexture.strength!==void 0&&(o.aoMapIntensity=r.occlusionTexture.strength)),r.emissiveFactor!==void 0&&i!==dt){const h=r.emissiveFactor;o.emissive=new Qe().setRGB(h[0],h[1],h[2],Be)}return r.emissiveTexture!==void 0&&i!==dt&&l.push(t.assignTexture(o,"emissiveMap",r.emissiveTexture,Nt)),Promise.all(l).then(function(){const h=new i(o);return r.name&&(h.name=r.name),Ue(h,r),t.associations.set(h,{materials:e}),r.extensions&&Ye(n,h,r),h})}createUniqueName(e){const t=eo.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,n=this.primitiveCache;function r(o){return s[G.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(o,t).then(function(c){return Sn(c,o,t)})}const i=[];for(let o=0,c=e.length;o<c;o++){const l=e[o],u=ga(l),h=n[u];if(h)i.push(h.promise);else{let d;l.extensions&&l.extensions[G.KHR_DRACO_MESH_COMPRESSION]?d=r(l):d=Sn(new Bt,l,t),n[u]={primitive:l,promise:d},i.push(d)}}return Promise.all(i)}loadMesh(e){const t=this,s=this.json,n=this.extensions,r=s.meshes[e],i=r.primitives,o=[];for(let c=0,l=i.length;c<l;c++){const u=i[c].material===void 0?fa(this.cache):this.getDependency("material",i[c].material);o.push(u)}return o.push(t.loadGeometries(i)),Promise.all(o).then(function(c){const l=c.slice(0,c.length-1),u=c[c.length-1],h=[];for(let f=0,p=u.length;f<p;f++){const m=u[f],g=i[f];let y;const _=l[f];if(g.mode===Se.TRIANGLES||g.mode===Se.TRIANGLE_STRIP||g.mode===Se.TRIANGLE_FAN||g.mode===void 0)y=r.isSkinnedMesh===!0?new to(m,_):new os(m,_),y.isSkinnedMesh===!0&&y.normalizeSkinWeights(),g.mode===Se.TRIANGLE_STRIP?y.geometry=xn(y.geometry,kr):g.mode===Se.TRIANGLE_FAN&&(y.geometry=xn(y.geometry,Hs));else if(g.mode===Se.LINES)y=new so(m,_);else if(g.mode===Se.LINE_STRIP)y=new no(m,_);else if(g.mode===Se.LINE_LOOP)y=new ro(m,_);else if(g.mode===Se.POINTS)y=new Ur(m,_);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+g.mode);Object.keys(y.geometry.morphAttributes).length>0&&ma(y,r),y.name=t.createUniqueName(r.name||"mesh_"+e),Ue(y,r),g.extensions&&Ye(n,y,g),t.assignFinalMaterial(y),h.push(y)}for(let f=0,p=h.length;f<p;f++)t.associations.set(h[f],{meshes:e,primitives:f});if(h.length===1)return r.extensions&&Ye(n,h[0],r),h[0];const d=new pt;r.extensions&&Ye(n,d,r),t.associations.set(d,{meshes:e});for(let f=0,p=h.length;f<p;f++)d.add(h[f]);return d})}loadCamera(e){let t;const s=this.json.cameras[e],n=s[s.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return s.type==="perspective"?t=new io(Q.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):s.type==="orthographic"&&(t=new Br(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),Ue(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let n=0,r=t.joints.length;n<r;n++)s.push(this._loadNodeShallow(t.joints[n]));return t.inverseBindMatrices!==void 0?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(n){const r=n.pop(),i=n,o=[],c=[];for(let l=0,u=i.length;l<u;l++){const h=i[l];if(h){o.push(h);const d=new Z;r!==null&&d.fromArray(r.array,l*16),c.push(d)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[l])}return new oo(o,c)})}loadAnimation(e){const t=this.json,s=this,n=t.animations[e],r=n.name?n.name:"animation_"+e,i=[],o=[],c=[],l=[],u=[];for(let h=0,d=n.channels.length;h<d;h++){const f=n.channels[h],p=n.samplers[f.sampler],m=f.target,g=m.node,y=n.parameters!==void 0?n.parameters[p.input]:p.input,_=n.parameters!==void 0?n.parameters[p.output]:p.output;m.node!==void 0&&(i.push(this.getDependency("node",g)),o.push(this.getDependency("accessor",y)),c.push(this.getDependency("accessor",_)),l.push(p),u.push(m))}return Promise.all([Promise.all(i),Promise.all(o),Promise.all(c),Promise.all(l),Promise.all(u)]).then(function(h){const d=h[0],f=h[1],p=h[2],m=h[3],g=h[4],y=[];for(let _=0,C=d.length;_<C;_++){const k=d[_],A=f[_],L=p[_],I=m[_],O=g[_];if(k===void 0)continue;k.updateMatrix&&k.updateMatrix();const R=s._createAnimationTracks(k,A,L,I,O);if(R)for(let V=0;V<R.length;V++)y.push(R[V])}return new ao(r,void 0,y)})}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return n.mesh===void 0?null:s.getDependency("mesh",n.mesh).then(function(r){const i=s._getNodeRef(s.meshCache,n.mesh,r);return n.weights!==void 0&&i.traverse(function(o){if(o.isMesh)for(let c=0,l=n.weights.length;c<l;c++)o.morphTargetInfluences[c]=n.weights[c]}),i})}loadNode(e){const t=this.json,s=this,n=t.nodes[e],r=s._loadNodeShallow(e),i=[],o=n.children||[];for(let l=0,u=o.length;l<u;l++)i.push(s.getDependency("node",o[l]));const c=n.skin===void 0?Promise.resolve(null):s.getDependency("skin",n.skin);return Promise.all([r,Promise.all(i),c]).then(function(l){const u=l[0],h=l[1],d=l[2];d!==null&&u.traverse(function(f){f.isSkinnedMesh&&f.bind(d,Ta)});for(let f=0,p=h.length;f<p;f++)u.add(h[f]);return u})}_loadNodeShallow(e){const t=this.json,s=this.extensions,n=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const r=t.nodes[e],i=r.name?n.createUniqueName(r.name):"",o=[],c=n._invokeOne(function(l){return l.createNodeMesh&&l.createNodeMesh(e)});return c&&o.push(c),r.camera!==void 0&&o.push(n.getDependency("camera",r.camera).then(function(l){return n._getNodeRef(n.cameraCache,r.camera,l)})),n._invokeAll(function(l){return l.createNodeAttachment&&l.createNodeAttachment(e)}).forEach(function(l){o.push(l)}),this.nodeCache[e]=Promise.all(o).then(function(l){let u;if(r.isBone===!0?u=new co:l.length>1?u=new pt:l.length===1?u=l[0]:u=new Or,u!==l[0])for(let h=0,d=l.length;h<d;h++)u.add(l[h]);if(r.name&&(u.userData.name=r.name,u.name=i),Ue(u,r),r.extensions&&Ye(s,u,r),r.matrix!==void 0){const h=new Z;h.fromArray(r.matrix),u.applyMatrix4(h)}else r.translation!==void 0&&u.position.fromArray(r.translation),r.rotation!==void 0&&u.quaternion.fromArray(r.rotation),r.scale!==void 0&&u.scale.fromArray(r.scale);return n.associations.has(u)||n.associations.set(u,{}),n.associations.get(u).nodes=e,u}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],n=this,r=new pt;s.name&&(r.name=n.createUniqueName(s.name)),Ue(r,s),s.extensions&&Ye(t,r,s);const i=s.nodes||[],o=[];for(let c=0,l=i.length;c<l;c++)o.push(n.getDependency("node",i[c]));return Promise.all(o).then(function(c){for(let u=0,h=c.length;u<h;u++)r.add(c[u]);const l=u=>{const h=new Map;for(const[d,f]of n.associations)(d instanceof ms||d instanceof hn)&&h.set(d,f);return u.traverse(d=>{const f=n.associations.get(d);f!=null&&h.set(d,f)}),h};return n.associations=l(r),r})}_createAnimationTracks(e,t,s,n,r){const i=[],o=e.name?e.name:e.uuid,c=[];ze[r.path]===ze.weights?e.traverse(function(d){d.morphTargetInfluences&&c.push(d.name?d.name:d.uuid)}):c.push(o);let l;switch(ze[r.path]){case ze.weights:l=fn;break;case ze.rotation:l=pn;break;case ze.translation:case ze.scale:l=dn;break;default:switch(s.itemSize){case 1:l=fn;break;case 2:case 3:default:l=dn;break}break}const u=n.interpolation!==void 0?da[n.interpolation]:Vr,h=this._getArrayFromAccessor(s);for(let d=0,f=c.length;d<f;d++){const p=new l(c[d]+"."+ze[r.path],t.array,h,u);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(p),i.push(p)}return i}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const s=Xs(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*s;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(s){const n=this instanceof pn?ha:ni;return new n(this.times,this.values,this.getValueSize()/3,s)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function ba(a,e,t){const s=e.attributes,n=new zr;if(s.POSITION!==void 0){const o=t.json.accessors[s.POSITION],c=o.min,l=o.max;if(c!==void 0&&l!==void 0){if(n.set(new S(c[0],c[1],c[2]),new S(l[0],l[1],l[2])),o.normalized){const u=Xs(mt[o.componentType]);n.min.multiplyScalar(u),n.max.multiplyScalar(u)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const r=e.targets;if(r!==void 0){const o=new S,c=new S;for(let l=0,u=r.length;l<u;l++){const h=r[l];if(h.POSITION!==void 0){const d=t.json.accessors[h.POSITION],f=d.min,p=d.max;if(f!==void 0&&p!==void 0){if(c.setX(Math.max(Math.abs(f[0]),Math.abs(p[0]))),c.setY(Math.max(Math.abs(f[1]),Math.abs(p[1]))),c.setZ(Math.max(Math.abs(f[2]),Math.abs(p[2]))),d.normalized){const m=Xs(mt[d.componentType]);c.multiplyScalar(m)}o.max(c)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(o)}a.boundingBox=n;const i=new Ys;n.getCenter(i.center),i.radius=n.min.distanceTo(n.max)/2,a.boundingSphere=i}function Sn(a,e,t){const s=e.attributes,n=[];function r(i,o){return t.getDependency("accessor",i).then(function(c){a.setAttribute(o,c)})}for(const i in s){const o=$s[i]||i.toLowerCase();o in a.attributes||n.push(r(s[i],o))}if(e.indices!==void 0&&!a.index){const i=t.getDependency("accessor",e.indices).then(function(o){a.setIndex(o)});n.push(i)}return mn.workingColorSpace!==Be&&"COLOR_0"in s&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${mn.workingColorSpace}" not supported.`),Ue(a,e),ba(a,e,t),Promise.all(n).then(function(){return e.targets!==void 0?pa(a,e.targets,t):a})}class ri extends Bo{constructor(e=as){super(),this.manager=e,this.adjustmentTransform=new Z}parse(e){const t=super.parse(e),s=t.glbBytes.slice().buffer;return new Promise((n,r)=>{const i=this.manager,o=this.fetchOptions,c=i.getHandler("path.gltf")||new us(i);o.credentials==="include"&&o.mode==="cors"&&c.setCrossOrigin("use-credentials"),"credentials"in o&&c.setWithCredentials(o.credentials==="include"),o.headers&&c.setRequestHeader(o.headers);let l=this.workingPath;!/[\\/]$/.test(l)&&l.length&&(l+="/");const u=this.adjustmentTransform;c.parse(s,l,h=>{const{batchTable:d,featureTable:f}=t,{scene:p}=h,m=f.getData("RTC_CENTER");m&&(p.position.x+=m[0],p.position.y+=m[1],p.position.z+=m[2]),h.scene.updateMatrix(),h.scene.matrix.multiply(u),h.scene.matrix.decompose(h.scene.position,h.scene.quaternion,h.scene.scale),h.batchTable=d,h.featureTable=f,p.batchTable=d,p.featureTable=f,n(h)},r)})}}class wa extends ls{parse(e){const t=new DataView(e),s=gt(t);console.assert(s==="pnts");const n=t.getUint32(4,!0);console.assert(n===1);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),c=t.getUint32(20,!0),l=t.getUint32(24,!0),u=28,h=e.slice(u,u+i+o),d=new cs(h,0,i,o),f=u+i+o,p=e.slice(f,f+c+l),m=new sn(p,d.getData("BATCH_LENGTH")||d.getData("POINTS_LENGTH"),0,c,l);return Promise.resolve({version:n,featureTable:d,batchTable:m})}}function xa(a){const e=a>>11,t=a>>5&63,s=a&31,n=Math.round(e/31*255),r=Math.round(t/63*255),i=Math.round(s/31*255);return[n,r,i]}const _t=new Y;function Aa(a,e,t=new S){_t.set(a,e).divideScalar(256).multiplyScalar(2).subScalar(1),t.set(_t.x,_t.y,1-Math.abs(_t.x)-Math.abs(_t.y));const s=Q.clamp(-t.z,0,1);return t.x>=0?t.setX(t.x-s):t.setX(t.x+s),t.y>=0?t.setY(t.y-s):t.setY(t.y+s),t.normalize(),t}const Pn={RGB:"color",POSITION:"position"};class ii extends wa{constructor(e=as){super(),this.manager=e}parse(e){return super.parse(e).then(async t=>{const{featureTable:s,batchTable:n}=t,r=new Nr,i=s.header.extensions,o=new S;let c;if(i&&i["3DTILES_draco_point_compression"]){const{byteOffset:h,byteLength:d,properties:f}=i["3DTILES_draco_point_compression"],p=this.manager.getHandler("draco.drc");if(p==null)throw new Error("PNTSLoader: dracoLoader not available.");const m={};for(const _ in f)if(_ in Pn&&_ in f){const C=Pn[_];m[C]=f[_]}const g={attributeIDs:m,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},y=s.getBuffer(h,d);c=await p.decodeGeometry(y,g),c.attributes.color&&(r.vertexColors=!0)}else{const h=s.getData("POINTS_LENGTH"),d=s.getData("POSITION",h,"FLOAT","VEC3"),f=s.getData("NORMAL",h,"FLOAT","VEC3"),p=s.getData("NORMAL",h,"UNSIGNED_BYTE","VEC2"),m=s.getData("RGB",h,"UNSIGNED_BYTE","VEC3"),g=s.getData("RGBA",h,"UNSIGNED_BYTE","VEC4"),y=s.getData("RGB565",h,"UNSIGNED_SHORT","SCALAR"),_=s.getData("CONSTANT_RGBA",h,"UNSIGNED_BYTE","VEC4"),C=s.getData("POSITION_QUANTIZED",h,"UNSIGNED_SHORT","VEC3"),k=s.getData("QUANTIZED_VOLUME_SCALE",h,"FLOAT","VEC3"),A=s.getData("QUANTIZED_VOLUME_OFFSET",h,"FLOAT","VEC3");if(c=new Bt,C){const L=new Float32Array(h*3);for(let I=0;I<h;I++)for(let O=0;O<3;O++){const R=3*I+O;L[R]=C[R]/65535*k[O]}o.x=A[0],o.y=A[1],o.z=A[2],c.setAttribute("position",new ge(L,3,!1))}else c.setAttribute("position",new ge(d,3,!1));if(f!==null)c.setAttribute("normal",new ge(f,3,!1));else if(p!==null){const L=new Float32Array(h*3),I=new S;for(let O=0;O<h;O++){const R=p[O*2],V=p[O*2+1],ie=Aa(R,V,I);L[O*3]=ie.x,L[O*3+1]=ie.y,L[O*3+2]=ie.z}c.setAttribute("normal",new ge(L,3,!1))}if(g!==null)c.setAttribute("color",new ge(g,4,!0)),r.vertexColors=!0,r.transparent=!0,r.depthWrite=!1;else if(m!==null)c.setAttribute("color",new ge(m,3,!0)),r.vertexColors=!0;else if(y!==null){const L=new Uint8Array(h*3);for(let I=0;I<h;I++){const O=xa(y[I]);for(let R=0;R<3;R++){const V=3*I+R;L[V]=O[R]}}c.setAttribute("color",new ge(L,3,!0)),r.vertexColors=!0}else if(_!==null){const L=new Qe(_[0],_[1],_[2]);r.color=L;const I=_[3]/255;I<1&&(r.opacity=I,r.transparent=!0,r.depthWrite=!1)}}const l=new Ur(c,r);l.position.copy(o),t.scene=l,t.scene.featureTable=s,t.scene.batchTable=n;const u=s.getData("RTC_CENTER");return u&&(t.scene.position.x+=u[0],t.scene.position.y+=u[1],t.scene.position.z+=u[2]),t})}}class va extends ls{parse(e){const t=new DataView(e),s=gt(t);console.assert(s==="i3dm");const n=t.getUint32(4,!0);console.assert(n===1);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),c=t.getUint32(20,!0),l=t.getUint32(24,!0),u=t.getUint32(28,!0),h=32,d=e.slice(h,h+i+o),f=new cs(d,0,i,o),p=h+i+o,m=e.slice(p,p+c+l),g=new sn(m,f.getData("INSTANCES_LENGTH"),0,c,l),y=p+c+l,_=new Uint8Array(e,y,r-y);let C=null,k=null,A=null;if(u)C=_,k=Promise.resolve();else{const L=this.resolveExternalURL(ei(_)),I=L.split(/[\\/]/g);I.pop(),A=I.join("/"),k=fetch(L,this.fetchOptions).then(O=>{if(!O.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${L}" with status ${O.status} : ${O.statusText}`);return O.arrayBuffer()}).then(O=>{C=new Uint8Array(O)})}return k.then(()=>({version:n,featureTable:f,batchTable:g,glbBytes:C,gltfWorkingPath:A}))}}new S;function Ea(a){const{x:e,y:t,z:s}=a;a.x=s,a.y=e,a.z=t}function Sa(a){return-a+Math.PI/2}const Mn=new po,je=new S,ve=new S,xs=new S,We=new Z,Le=new Z,As=new Ys,_e=new jr,Cn=new S,kn=new S,Rn=new S,bt=new S,Ln=new nt,Pa=1e-12,Ma=.1,vs=0,On=1,In=2;class nn{constructor(e=1,t=1,s=1){this.name="",this.radius=new S(e,t,s)}intersectRay(e,t){return We.makeScale(...this.radius).invert(),As.center.set(0,0,0),As.radius=1,Ln.copy(e).applyMatrix4(We),Ln.intersectSphere(As,t)?(We.makeScale(...this.radius),t.applyMatrix4(We),t):null}getEastNorthUpFrame(e,t,s){return this.getEastNorthUpAxes(e,t,Cn,kn,Rn,bt),s.makeBasis(Cn,kn,Rn).setPosition(bt)}getEastNorthUpAxes(e,t,s,n,r,i=bt){this.getCartographicToPosition(e,t,0,i),this.getCartographicToNormal(e,t,r),s.set(-i.y,i.x,0).normalize(),n.crossVectors(r,s).normalize()}getAzElRollFromRotationMatrix(e,t,s,n,r=vs){return r===On?(_e.set(-Math.PI/2,0,0,"XYZ"),Le.makeRotationFromEuler(_e).premultiply(s)):r===In?(_e.set(-Math.PI/2,0,Math.PI,"XYZ"),Le.makeRotationFromEuler(_e).premultiply(s)):Le.copy(s),this.getEastNorthUpFrame(e,t,We).invert(),Le.premultiply(We),_e.setFromRotationMatrix(Le,"ZXY"),n.azimuth=-_e.z,n.elevation=_e.x,n.roll=_e.y,n}getRotationMatrixFromAzElRoll(e,t,s,n,r,i,o=vs){return this.getEastNorthUpFrame(e,t,We),_e.set(n,r,-s,"ZXY"),i.makeRotationFromEuler(_e).premultiply(We).setPosition(0,0,0),o===On?(_e.set(Math.PI/2,0,0,"XYZ"),Le.makeRotationFromEuler(_e),i.multiply(Le)):o===In&&(_e.set(-Math.PI/2,0,Math.PI,"XYZ"),Le.makeRotationFromEuler(_e),i.multiply(Le)),i}getFrame(e,t,s,n,r,i,o,c=vs){return this.getRotationMatrixFromAzElRoll(e,t,s,n,r,o,c),this.getCartographicToPosition(e,t,i,bt),o.setPosition(bt),o}getCartographicToPosition(e,t,s,n){this.getCartographicToNormal(e,t,je);const r=this.radius;ve.copy(je),ve.x*=r.x**2,ve.y*=r.y**2,ve.z*=r.z**2;const i=Math.sqrt(je.dot(ve));return ve.divideScalar(i),n.copy(ve).addScaledVector(je,s)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,ve),this.getPositionToNormal(e,je);const s=xs.subVectors(e,ve);return t.lon=Math.atan2(je.y,je.x),t.lat=Math.asin(je.z),t.height=Math.sign(s.dot(e))*s.length(),t}getCartographicToNormal(e,t,s){return Mn.set(1,Sa(e),t),s.setFromSpherical(Mn).normalize(),Ea(s),s}getPositionToNormal(e,t){const s=this.radius;return t.copy(e),t.x/=s.x**2,t.y/=s.y**2,t.z/=s.z**2,t.normalize(),t}getPositionToSurfacePoint(e,t){const s=this.radius,n=1/s.x**2,r=1/s.y**2,i=1/s.z**2,o=e.x*e.x*n,c=e.y*e.y*r,l=e.z*e.z*i,u=o+c+l,h=Math.sqrt(1/u),d=ve.copy(e).multiplyScalar(h);if(u<Ma)return isFinite(h)?t.copy(d):null;const f=xs.set(d.x*n*2,d.y*r*2,d.z*i*2);let p=(1-h)*e.length()/(.5*f.length()),m=0,g,y,_,C,k,A,L,I,O,R,V;do{p-=m,_=1/(1+p*n),C=1/(1+p*r),k=1/(1+p*i),A=_*_,L=C*C,I=k*k,O=A*_,R=L*C,V=I*k,g=o*A+c*L+l*I-1,y=o*O*n+c*R*r+l*V*i;const ie=-2*y;m=g/ie}while(Math.abs(g)>Pa);return t.set(e.x*_,e.y*C,e.z*k)}calculateHorizonDistance(e,t){const s=this.calculateEffectiveRadius(e);return Math.sqrt(2*s*t+t**2)}calculateEffectiveRadius(e){const t=this.radius.x,n=1-this.radius.z**2/t**2,r=e*Q.DEG2RAD,i=Math.sin(r)**2;return t/Math.sqrt(1-n*i)}getPositionElevation(e){this.getPositionToSurfacePoint(e,ve);const t=xs.subVectors(e,ve);return Math.sign(t.dot(e))*t.length()}copy(e){return this.radius.copy(e.radius),this}clone(){return new this.constructor().copy(this)}}const hs=new nn(bn,bn,Oo);hs.name="WGS84 Earth";const Dn=new S,Es=new S,Ss=new S,Ps=new S,Ms=new Re,Ht=new S,qt=new Z,Nn=new Z,Fn=new S,Un=new Z,Cs=new Re,ks={};class oi extends va{constructor(e=as){super(),this.manager=e,this.adjustmentTransform=new Z,this.ellipsoid=hs.clone()}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then(t=>{const{featureTable:s,batchTable:n}=t,r=t.glbBytes.slice().buffer;return new Promise((i,o)=>{const c=this.fetchOptions,l=this.manager,u=l.getHandler("path.gltf")||new us(l);c.credentials==="include"&&c.mode==="cors"&&u.setCrossOrigin("use-credentials"),"credentials"in c&&u.setWithCredentials(c.credentials==="include"),c.headers&&u.setRequestHeader(c.headers);let h=t.gltfWorkingPath??this.workingPath;/[\\/]$/.test(h)||(h+="/");const d=this.adjustmentTransform;u.parse(r,h,f=>{const p=s.getData("INSTANCES_LENGTH"),m=s.getData("POSITION",p,"FLOAT","VEC3"),g=s.getData("NORMAL_UP",p,"FLOAT","VEC3"),y=s.getData("NORMAL_RIGHT",p,"FLOAT","VEC3"),_=s.getData("SCALE_NON_UNIFORM",p,"FLOAT","VEC3"),C=s.getData("SCALE",p,"FLOAT","SCALAR"),k=s.getData("RTC_CENTER"),A=s.getData("EAST_NORTH_UP");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach(R=>{R in s.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${R}" detected.`)});const L=new S;for(let R=0;R<p;R++)L.x+=m[R*3+0]/p,L.y+=m[R*3+1]/p,L.z+=m[R*3+2]/p;const I=[],O=[];f.scene.updateMatrixWorld(),f.scene.traverse(R=>{if(R.isMesh){O.push(R);const{geometry:V,material:ie}=R,de=new Lr(V,ie,p);de.position.copy(L),k&&(de.position.x+=k[0],de.position.y+=k[1],de.position.z+=k[2]),I.push(de)}});for(let R=0;R<p;R++){Ps.set(m[R*3+0]-L.x,m[R*3+1]-L.y,m[R*3+2]-L.z),Ms.identity(),g&&(Es.set(g[R*3+0],g[R*3+1],g[R*3+2]),Ss.set(y[R*3+0],y[R*3+1],y[R*3+2]),Dn.crossVectors(Ss,Es).normalize(),qt.makeBasis(Ss,Es,Dn),Ms.setFromRotationMatrix(qt)),Ht.set(1,1,1),_&&Ht.set(_[R*3+0],_[R*3+1],_[R*3+2]),C&&Ht.multiplyScalar(C[R]);for(let V=0,ie=I.length;V<ie;V++){const de=I[V];Cs.copy(Ms),A&&(de.updateMatrixWorld(),Fn.copy(Ps).applyMatrix4(de.matrixWorld),this.ellipsoid.getPositionToCartographic(Fn,ks),this.ellipsoid.getEastNorthUpFrame(ks.lat,ks.lon,Un),Cs.setFromRotationMatrix(Un)),qt.compose(Ps,Cs,Ht).multiply(d);const yt=O[V];Nn.multiplyMatrices(qt,yt.matrixWorld),de.setMatrixAt(R,Nn)}}f.scene.clear(),f.scene.add(...I),f.batchTable=n,f.featureTable=s,f.scene.batchTable=n,f.scene.featureTable=s,i(f)},o)})})}}class Ca extends ls{parse(e){const t=new DataView(e),s=gt(t);console.assert(s==="cmpt",'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(n===1,'CMPTLoader: The version listed in the header is "1".');const r=t.getUint32(8,!0);console.assert(r===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const i=t.getUint32(12,!0),o=[];let c=16;for(let l=0;l<i;l++){const u=new DataView(e,c,12),h=gt(u),d=u.getUint32(4,!0),f=u.getUint32(8,!0),p=new Uint8Array(e,c,f);o.push({type:h,buffer:p,version:d}),c+=f}return{version:n,tiles:o}}}class ka extends Ca{constructor(e=as){super(),this.manager=e,this.adjustmentTransform=new Z,this.ellipsoid=hs.clone()}parse(e){const t=super.parse(e),{manager:s,ellipsoid:n,adjustmentTransform:r}=this,i=[];for(const o in t.tiles){const{type:c,buffer:l}=t.tiles[o];switch(c){case"b3dm":{const u=l.slice(),h=new ri(s);h.workingPath=this.workingPath,h.fetchOptions=this.fetchOptions,h.adjustmentTransform.copy(r);const d=h.parse(u.buffer);i.push(d);break}case"pnts":{const u=l.slice(),h=new ii(s);h.workingPath=this.workingPath,h.fetchOptions=this.fetchOptions;const d=h.parse(u.buffer);i.push(d);break}case"i3dm":{const u=l.slice(),h=new oi(s);h.workingPath=this.workingPath,h.fetchOptions=this.fetchOptions,h.ellipsoid.copy(n),h.adjustmentTransform.copy(r);const d=h.parse(u.buffer);i.push(d);break}}}return Promise.all(i).then(o=>{const c=new pt;return o.forEach(l=>{c.add(l.scene)}),{tiles:o,scene:c}})}}const wt=new Z;class Ra extends pt{constructor(e){super(),this.isTilesGroup=!0,this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e,this.matrixWorldInverse=new Z}raycast(e,t){return this.tilesRenderer.optimizeRaycast?(this.tilesRenderer.raycast(e,t),!1):!0}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){this.parent===null?wt.copy(this.matrix):wt.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=wt.elements,s=this.matrixWorld.elements;let n=!1;for(let r=0;r<16;r++){const i=t[r],o=s[r];if(Math.abs(i-o)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(wt),this.matrixWorldInverse.copy(wt).invert();const r=this.children;for(let i=0,o=r.length;i<o;i++)r[i].updateMatrixWorld()}}}}const ai=new nt,Rs=new S,Kt=[];function ci(a,e){return a.distance-e.distance}function li(a,e,t,s){const{scene:n}=a.cached;t.invokeOnePlugin(i=>i.raycastTile&&i.raycastTile(a,n,e,s))||e.intersectObject(n,!0,s)}function La(a,e,t){li(a,e,t,Kt),Kt.sort(ci);const s=Kt[0]||null;return Kt.length=0,s}function ui(a){return"__used"in a}function hi(a,e,t,s=null){const{group:n,activeTiles:r}=a;s===null&&(s=ai,s.copy(t.ray).applyMatrix4(n.matrixWorldInverse));const i=[],o=e.children;for(let u=0,h=o.length;u<h;u++){const d=o[u];if(!ui(d)||!d.__used)continue;d.cached.boundingVolume.intersectRay(s,Rs)!==null&&(Rs.applyMatrix4(n.matrixWorld),i.push({distance:Rs.distanceToSquared(t.ray.origin),tile:d}))}i.sort(ci);let c=null,l=1/0;if(r.has(e)){const u=La(e,t,a);u&&(c=u,l=u.distance*u.distance)}for(let u=0,h=i.length;u<h;u++){const d=i[u],f=d.distance,p=d.tile;if(f>l)break;const m=hi(a,p,t,s);if(m){const g=m.distance*m.distance;g<l&&(c=m,l=g)}}return c}function di(a,e,t,s,n=null){if(!ui(e))return;const{group:r,activeTiles:i}=a,{boundingVolume:o}=e.cached;if(n===null&&(n=ai,n.copy(t.ray).applyMatrix4(r.matrixWorldInverse)),!e.__used||!o.intersectsRay(n))return;i.has(e)&&li(e,t,a,s);const c=e.children;for(let l=0,u=c.length;l<u;l++)di(a,c[l],t,s,n)}const $t=new S,Xt=new S,be=new S,Qt=new nt;class Bn{constructor(e=new zr,t=new Z){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new Z,this.points=new Array(8).fill().map(()=>new S),this.planes=new Array(6).fill().map(()=>new Js)}copy(e){return this.box.copy(e.box),this.transform.copy(e.transform),this.update(),this}clone(){return new this.constructor().copy(this)}clampPoint(e,t){return t.copy(e).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(e){return this.clampPoint(e,be).distanceTo(e)}containsPoint(e){return be.copy(e).applyMatrix4(this.inverseTransform),this.box.containsPoint(be)}intersectsRay(e){return Qt.copy(e).applyMatrix4(this.inverseTransform),Qt.intersectsBox(this.box)}intersectRay(e,t){return Qt.copy(e).applyMatrix4(this.inverseTransform),Qt.intersectBox(this.box,t)?(t.applyMatrix4(this.transform),t):null}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:r,max:i}=n;let o=0;for(let c=-1;c<=1;c+=2)for(let l=-1;l<=1;l+=2)for(let u=-1;u<=1;u+=2)e[o].set(c<0?r.x:i.x,l<0?r.y:i.y,u<0?r.z:i.z).applyMatrix4(s),o++;this.updatePlanes()}updatePlanes(){$t.copy(this.box.min).applyMatrix4(this.transform),Xt.copy(this.box.max).applyMatrix4(this.transform),be.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(be,$t),this.planes[1].setFromNormalAndCoplanarPoint(be,Xt).negate(),be.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(be,$t),this.planes[3].setFromNormalAndCoplanarPoint(be,Xt).negate(),be.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(be,$t),this.planes[5].setFromNormalAndCoplanarPoint(be,Xt).negate()}intersectsSphere(e){return this.clampPoint(e.center,be),be.distanceToSquared(e.center)<=e.radius*e.radius}intersectsFrustum(e){return this._intersectsPlaneShape(e.planes,e.points)}intersectsOBB(e){return this._intersectsPlaneShape(e.planes,e.points)}_intersectsPlaneShape(e,t){const s=this.points,n=this.planes;for(let r=0;r<6;r++){const i=e[r];let o=-1/0;for(let c=0;c<8;c++){const l=s[c],u=i.distanceToPoint(l);o=o<u?u:o}if(o<0)return!1}for(let r=0;r<6;r++){const i=n[r];let o=-1/0;for(let c=0;c<8;c++){const l=t[c],u=i.distanceToPoint(l);o=o<u?u:o}if(o<0)return!1}return!0}}const qe=Math.PI,Zt=qe/2,xt=new S,it=new S,ot=new S,Vn=new Z;let Lt=0;const Ls=[];function Oa(a=!1){return a?(Ls[Lt]||(Ls[Lt]=new S),Lt++,Ls[Lt-1]):new S}function zn(){Lt=0}class Ia extends nn{constructor(e,t,s,n=-Zt,r=Zt,i=0,o=2*qe,c=0,l=0){super(e,t,s),this.latStart=n,this.latEnd=r,this.lonStart=i,this.lonEnd=o,this.heightStart=c,this.heightEnd=l}_getPoints(e=!1){const{latStart:t,latEnd:s,lonStart:n,lonEnd:r,heightStart:i,heightEnd:o}=this,c=Q.mapLinear(.5,0,1,t,s),l=Q.mapLinear(.5,0,1,n,r),u=Math.floor(n/Zt)*Zt,h=[[-qe/2,0],[qe/2,0],[0,u],[0,u+qe/2],[0,u+qe],[0,u+3*qe/2],[t,r],[s,r],[t,n],[s,n],[0,n],[0,r],[c,l],[t,l],[s,l],[c,n],[c,r]],d=[],f=h.length;for(let p=0;p<=1;p++){const m=Q.mapLinear(p,0,1,i,o);for(let g=0,y=f;g<y;g++){const[_,C]=h[g];if(_>=t&&_<=s&&C>=n&&C<=r){const k=Oa(e);d.push(k),this.getCartographicToPosition(_,C,m,k)}}}return d}getBoundingBox(e,t){zn();const{latStart:s,latEnd:n,lonStart:r,lonEnd:i}=this;if(n-s<qe/2){const l=Q.mapLinear(.5,0,1,s,n),u=Q.mapLinear(.5,0,1,r,i);this.getCartographicToNormal(l,u,ot),it.set(0,0,1),xt.crossVectors(it,ot),it.crossVectors(xt,ot),t.makeBasis(xt,it,ot)}else xt.set(1,0,0),it.set(0,1,0),ot.set(0,0,1),t.makeBasis(xt,it,ot);Vn.copy(t).invert();const c=this._getPoints(!0);for(let l=0,u=c.length;l<u;l++)c[l].applyMatrix4(Vn);e.makeEmpty(),e.setFromPoints(c)}getBoundingSphere(e,t){zn();const s=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(s,t)}}const Oe=new S,Ie=new S,De=new S,jn=new S,Wn=new S;class Da{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t)||s&&!s.intersectsRay(e))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let r=-1/0,i=-1/0;s&&e.intersectSphere(s,jn)&&(r=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(jn)),n&&n.intersectRay(e,Wn)&&(i=n.containsPoint(e.origin)?0:e.origin.distanceToSquared(Wn));const o=Math.max(r,i);return o===-1/0?null:(e.at(Math.sqrt(o),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,r=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(r=s.distanceToPoint(e)),n>r?n:r}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsFrustum(e)?!1:!!(s||t)}intersectsSphere(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!s.intersectsSphere(e)||t&&!t.intersectsSphere(e)?!1:!!(s||t)}intersectsOBB(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsOBB(e)?!1:!!(s||t)}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new Bn;Oe.set(e[3],e[4],e[5]),Ie.set(e[6],e[7],e[8]),De.set(e[9],e[10],e[11]);const n=Oe.length(),r=Ie.length(),i=De.length();Oe.normalize(),Ie.normalize(),De.normalize(),n===0&&Oe.crossVectors(Ie,De),r===0&&Ie.crossVectors(Oe,De),i===0&&De.crossVectors(Oe,Ie),s.transform.set(Oe.x,Ie.x,De.x,e[0],Oe.y,Ie.y,De.y,e[1],Oe.z,Ie.z,De.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-r,-i),s.box.max.set(n,r,i),s.update(),this.obb=s}setSphereData(e,t,s,n,r){const i=new Ys;i.center.set(e,t,s),i.radius=n,i.applyMatrix4(r),this.sphere=i}setRegionData(e,t,s,n,r,i,o){const c=new Ia(...e.radius,s,r,t,n,i,o),l=new Bn;c.getBoundingBox(l.box,l.transform),l.update(),this.region=c,this.regionObb=l}}const Na=new Wr;function Fa(a,e,t,s){const n=Na.set(a.normal.x,a.normal.y,a.normal.z,e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z);return s.set(-a.constant,-e.constant,-t.constant),s.applyMatrix3(n.invert()),s}class Ua extends mo{constructor(){super(),this.points=Array(8).fill().map(()=>new S)}setFromProjectionMatrix(e,t){return super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints(),this}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach((n,r)=>{Fa(n[0],n[1],n[2],t[r])})}}function Ba(a){const{TextureUtils:e}=go;if(!e)return 0;const t=new Set;let s=0;return a.traverse(n=>{if(n.geometry&&!t.has(n.geometry)&&(s+=Vo(n.geometry),t.add(n.geometry)),n.material){const r=n.material;for(const i in r){const o=r[i];if(o&&o.isTexture&&!t.has(o)){const{format:c,type:l,image:u}=o,{width:h,height:d}=u,f=e.getByteLength(h,d,c,l);s+=o.generateMipmaps?f*4/3:f,t.add(o)}}}}),s}const Gn=new Z,Hn=new jr,fi=Symbol("INITIAL_FRUSTUM_CULLED"),Yt=new Z,At=new S,Os=new Y,Jt={inView:!1,error:1/0},Va=new S(1,0,0),za=new S(0,1,0);function qn(a,e){a.traverse(t=>{t.frustumCulled=t[fi]&&e})}class ja extends No{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel(t=>{qn(t,!e)}))}get optimizeRaycast(){return this._optimizeRaycast}set optimizeRaycast(e){console.warn('TilesRenderer: The "optimizeRaycast" option has been deprecated.'),this._optimizeRaycast=e}constructor(...e){super(...e),this.group=new Ra(this),this.ellipsoid=hs.clone(),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this._optimizeRaycast=!0,this._upRotationMatrix=new Z,this.lruCache.computeMemoryUsageCallback=s=>s.cached.bytesUsed??null,this._autoDisableRendererCulling=!0;const t=new yo;t.setURLModifier(s=>this.preprocessURL?this.preprocessURL(s):s),this.manager=t,this._listeners={}}addEventListener(...e){Rt.prototype.addEventListener.call(this,...e)}hasEventListener(...e){Rt.prototype.hasEventListener.call(this,...e)}removeEventListener(...e){Rt.prototype.removeEventListener.call(this,...e)}dispatchEvent(...e){Rt.prototype.dispatchEvent.call(this,...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getAABB(e),!0):!1}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return s?(s.getOBB(e,t),!0):!1}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getSphere(e),!0):!1}forEachLoadedModel(e){this.traverse(t=>{const s=t.cached&&t.cached.scene;s&&e(s,t)},null,!1)}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=hi(this,this.root,e);s&&t.push(s)}else di(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return s.has(e)?!1:(s.set(e,new Y),t.push(e),this.dispatchEvent({type:"add-camera",camera:e}),!0)}setResolution(e,t,s){const n=this.cameraMap;if(!n.has(e))return!1;const r=t.isVector2?t.x:t,i=t.isVector2?t.y:s,o=n.get(e);return(o.width!==r||o.height!==i)&&(o.set(r,i),this.dispatchEvent({type:"camera-resolution-change"})),!0}setResolutionFromRenderer(e,t){return t.getSize(Os).multiplyScalar(t.getPixelRatio()),this.setResolution(e,Os.x,Os.y)}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),this.dispatchEvent({type:"delete-camera",camera:e}),!0}return!1}loadRootTileSet(...e){return super.loadRootTileSet(...e).then(t=>{const{asset:s,extensions:n={}}=t;switch((s&&s.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(za,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(Va,Math.PI/2);break}if("3DTILES_ellipsoid"in n){const i=n["3DTILES_ellipsoid"],{ellipsoid:o}=this;o.name=i.body,i.radii?o.radius.set(...i.radii):o.radius.set(1,1,1)}return t})}update(){let e=null;if(this.invokeAllPlugins(i=>{if(i.doTilesNeedUpdate){const o=i.doTilesNeedUpdate();e===null?e=o:e=!!(e||o)}}),e===!1){this.dispatchEvent({type:"update-before"}),this.dispatchEvent({type:"update-after"});return}this.dispatchEvent({type:"update-before"});const t=this.group,s=this.cameras,n=this.cameraMap,r=this.cameraInfo;if(s.length===0){let i=!1;if(this.invokeAllPlugins(o=>i=i||!!(o!==this&&o.calculateTileViewError)),i===!1){console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");return}}for(;r.length>s.length;)r.pop();for(;r.length<s.length;)r.push({frustum:new Ua,isOrthographic:!1,sseDenominator:-1,position:new S,invScale:-1,pixelSize:0});At.setFromMatrixScale(t.matrixWorldInverse),Math.abs(Math.max(At.x-At.y,At.x-At.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let i=0,o=r.length;i<o;i++){const c=s[i],l=r[i],u=l.frustum,h=l.position,d=n.get(c);(d.width===0||d.height===0)&&console.warn("TilesRenderer: resolution for camera error calculation is not set.");const f=c.projectionMatrix.elements;if(l.isOrthographic=f[15]===1,l.isOrthographic){const p=2/f[0],m=2/f[5];l.pixelSize=Math.max(m/d.height,p/d.width)}else l.sseDenominator=2/f[5]/d.height;Yt.copy(t.matrixWorld),Yt.premultiply(c.matrixWorldInverse),Yt.premultiply(c.projectionMatrix),u.setFromProjectionMatrix(Yt),h.set(0,0,0),h.applyMatrix4(c.matrixWorld),h.applyMatrix4(t.matrixWorldInverse)}super.update(),this.dispatchEvent({type:"update-after"})}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new Z;if(e.transform){const o=e.transform;for(let c=0;c<16;c++)n.elements[c]=o[c]}s&&n.premultiply(s.cached.transform);const r=new Z().copy(n).invert(),i=new Da;"sphere"in e.boundingVolume&&i.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&i.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&i.setRegionData(this.ellipsoid,...e.boundingVolume.region),e.cached={transform:n,transformInverse:r,active:!1,boundingVolume:i,metadata:null,scene:null,geometry:null,materials:null,textures:null}}async parseTile(e,t,s,n,r){const i=t.cached,o=n.split(/[\\/]/g);o.pop();const c=o.join("/"),l=this.fetchOptions,u=this.manager;let h=null;const d=i.transform,f=this._upRotationMatrix,p=(gt(e)||s).toLowerCase();switch(p){case"b3dm":{const A=new ri(u);A.workingPath=c,A.fetchOptions=l,A.adjustmentTransform.copy(f),h=A.parse(e);break}case"pnts":{const A=new ii(u);A.workingPath=c,A.fetchOptions=l,h=A.parse(e);break}case"i3dm":{const A=new oi(u);A.workingPath=c,A.fetchOptions=l,A.adjustmentTransform.copy(f),A.ellipsoid.copy(this.ellipsoid),h=A.parse(e);break}case"cmpt":{const A=new ka(u);A.workingPath=c,A.fetchOptions=l,A.adjustmentTransform.copy(f),A.ellipsoid.copy(this.ellipsoid),h=A.parse(e).then(L=>L.scene);break}case"gltf":case"glb":{const A=u.getHandler("path.gltf")||u.getHandler("path.glb")||new us(u);A.setWithCredentials(l.credentials==="include"),A.setRequestHeader(l.headers||{}),l.credentials==="include"&&l.mode==="cors"&&A.setCrossOrigin("use-credentials");let L=A.resourcePath||A.path||c;!/[\\/]$/.test(L)&&L.length&&(L+="/"),h=A.parseAsync(e,L).then(I=>{I.scene=I.scene||new pt;const{scene:O}=I;return O.updateMatrix(),O.matrix.multiply(f).decompose(O.position,O.quaternion,O.scale),I});break}default:{h=this.invokeOnePlugin(A=>A.parseToMesh&&A.parseToMesh(e,t,s,n,r));break}}const m=await h;if(m===null)throw new Error(`TilesRenderer: Content type "${p}" not supported.`);let g,y;m.isObject3D?(g=m,y=null):(g=m.scene,y=m),await this.invokeAllPlugins(A=>A.processTileModel&&A.processTileModel(g,t)),g.updateMatrix(),g.matrix.premultiply(d),g.matrix.decompose(g.position,g.quaternion,g.scale),g.traverse(A=>{A[fi]=A.frustumCulled}),qn(g,!this.autoDisableRendererCulling);const _=[],C=[],k=[];if(g.traverse(A=>{if(A.geometry&&C.push(A.geometry),A.material){const L=A.material;_.push(A.material);for(const I in L){const O=L[I];O&&O.isTexture&&k.push(O)}}}),r.aborted){for(let A=0,L=k.length;A<L;A++){const I=k[A];I.image instanceof ImageBitmap&&I.image.close(),I.dispose()}return}i.materials=_,i.geometry=C,i.textures=k,i.scene=g,i.metadata=y,i.bytesUsed=Ba(g)}disposeTile(e){super.disposeTile(e);const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,r=t.textures,i=t.scene.parent;t.scene.traverse(o=>{o.userData.meshFeatures&&o.userData.meshFeatures.dispose(),o.userData.structuralMetadata&&o.userData.structuralMetadata.dispose()});for(let o=0,c=n.length;o<c;o++)n[o].dispose();for(let o=0,c=s.length;o<c;o++)s[o].dispose();for(let o=0,c=r.length;o<c;o++){const l=r[o];l.image instanceof ImageBitmap&&l.image.close(),l.dispose()}i&&i.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}}setTileVisible(e,t){const s=e.cached.scene,n=this.group;t?s&&(n.add(s),s.updateMatrixWorld(!0)):s&&n.remove(s),super.setTileVisible(e,t),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t})}calculateTileViewError(e,t){const s=e.cached,n=this.cameras,r=this.cameraInfo,i=s.boundingVolume;let o=!1,c=-1/0,l=1/0,u=-1/0,h=1/0;for(let d=0,f=n.length;d<f;d++){const p=r[d];let m,g;if(p.isOrthographic){const _=p.pixelSize;m=e.geometricError/_,g=1/0}else{const _=p.sseDenominator;g=i.distanceToPoint(p.position),m=e.geometricError/(g*_)}const y=r[d].frustum;i.intersectsFrustum(y)&&(o=!0,c=Math.max(c,m),l=Math.min(l,g)),u=Math.max(u,m),h=Math.min(h,g)}this.invokeAllPlugins(d=>{d!==this&&d.calculateTileViewError&&(d.calculateTileViewError(e,Jt),Jt.inView&&(o=!0,c=Math.max(c,Jt.error)),u=Math.max(u,Jt.error))}),o?(t.inView=!0,t.error=c,t.distanceToCamera=l):(t.inView=!1,t.error=u,t.distanceToCamera=h)}setLatLonToYUp(e,t){console.warn("TilesRenderer: setLatLonToYUp is deprecated. Use the ReorientationPlugin, instead.");const{ellipsoid:s,group:n}=this;Hn.set(Math.PI/2,Math.PI/2,0),Gn.makeRotationFromEuler(Hn),s.getEastNorthUpFrame(e,t,n.matrix).multiply(Gn).invert().decompose(n.position,n.quaternion,n.scale),n.updateMatrixWorld(!0)}dispose(){super.dispose(),this.group.removeFromParent()}}class Wa extends os{constructor(){super(new To(0,0),new Ga),this.renderOrder=1/0}onBeforeRender(e){const t=this.material.uniforms;e.getSize(t.resolution.value)}updateMatrixWorld(){this.matrixWorld.makeTranslation(this.position)}dispose(){this.geometry.dispose(),this.material.dispose()}}class Ga extends Gr{constructor(){super({depthWrite:!1,depthTest:!1,transparent:!0,uniforms:{resolution:{value:new Y},size:{value:15},thickness:{value:2},opacity:{value:1}},vertexShader:`

				uniform float pixelRatio;
				uniform float size;
				uniform float thickness;
				uniform vec2 resolution;
				varying vec2 vUv;

				void main() {

					vUv = uv;

					float aspect = resolution.x / resolution.y;
					vec2 offset = uv * 2.0 - vec2( 1.0 );
					offset.y *= aspect;

					vec4 screenPoint = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
					screenPoint.xy += offset * ( size + thickness ) * screenPoint.w / resolution.x;

					gl_Position = screenPoint;

				}
			`,fragmentShader:`

				uniform float size;
				uniform float thickness;
				uniform float opacity;

				varying vec2 vUv;
				void main() {

					float ht = 0.5 * thickness;
					float planeDim = size + thickness;
					float offset = ( planeDim - ht - 2.0 ) / planeDim;
					float texelThickness = ht / planeDim;

					vec2 vec = vUv * 2.0 - vec2( 1.0 );
					float dist = abs( length( vec ) - offset );
					float fw = fwidth( dist ) * 0.5;
					float a = smoothstep( texelThickness - fw, texelThickness + fw, dist );

					gl_FragColor = vec4( 1, 1, 1, opacity * ( 1.0 - a ) );

				}
			`})}}const Kn=new Y,$n=new Y;class Ha{constructor(){this.domElement=null,this.buttons=0,this.pointerType=null,this.pointerOrder=[],this.previousPositions={},this.pointerPositions={},this.startPositions={},this.pointerSetThisFrame={},this.hoverPosition=new Y,this.hoverSet=!1}reset(){this.buttons=0,this.pointerType=null,this.pointerOrder=[],this.previousPositions={},this.pointerPositions={},this.startPositions={},this.pointerSetThisFrame={},this.hoverPosition=new Y,this.hoverSet=!1}updateFrame(){const{previousPositions:e,pointerPositions:t}=this;for(const s in t)e[s].copy(t[s])}setHoverEvent(e){(e.pointerType==="mouse"||e.type==="wheel")&&(this.getAdjustedPointer(e,this.hoverPosition),this.hoverSet=!0)}getLatestPoint(e){return this.pointerType!==null?(this.getCenterPoint(e),e):this.hoverSet?(e.copy(this.hoverPosition),e):null}getAdjustedPointer(e,t){const n=(this.domElement?this.domElement:e.target).getBoundingClientRect(),r=e.clientX-n.left,i=e.clientY-n.top;t.set(r,i)}addPointer(e){const t=e.pointerId,s=new Y;this.getAdjustedPointer(e,s),this.pointerOrder.push(t),this.pointerPositions[t]=s,this.previousPositions[t]=s.clone(),this.startPositions[t]=s.clone(),this.getPointerCount()===1&&(this.pointerType=e.pointerType,this.buttons=e.buttons)}updatePointer(e){const t=e.pointerId;return t in this.pointerPositions?(this.getAdjustedPointer(e,this.pointerPositions[t]),!0):!1}deletePointer(e){const t=e.pointerId,s=this.pointerOrder;s.splice(s.indexOf(t),1),delete this.pointerPositions[t],delete this.previousPositions[t],delete this.startPositions[t],this.getPointerCount.length===0&&(this.buttons=0,this.pointerType=null)}getPointerCount(){return this.pointerOrder.length}getCenterPoint(e,t=this.pointerPositions){const s=this.pointerOrder;if(this.getPointerCount()===1||this.getPointerType()==="mouse"){const n=s[0];return e.copy(t[n]),e}else if(this.getPointerCount()===2){const n=this.pointerOrder[0],r=this.pointerOrder[1],i=t[n],o=t[r];return e.addVectors(i,o).multiplyScalar(.5),e}return null}getPreviousCenterPoint(e){return this.getCenterPoint(e,this.previousPositions)}getStartCenterPoint(e){return this.getCenterPoint(e,this.startPositions)}getMoveDistance(){return this.getCenterPoint(Kn),this.getPreviousCenterPoint($n),Kn.sub($n).length()}getTouchPointerDistance(e=this.pointerPositions){if(this.getPointerCount()<=1||this.getPointerType()==="mouse")return 0;const{pointerOrder:t}=this,s=t[0],n=t[1],r=e[s],i=e[n];return r.distanceTo(i)}getPreviousTouchPointerDistance(){return this.getTouchPointerDistance(this.previousPositions)}getStartTouchPointerDistance(){return this.getTouchPointerDistance(this.startPositions)}getPointerType(){return this.pointerType}isPointerTouch(){return this.getPointerType()==="touch"}getPointerButtons(){return this.buttons}isLeftClicked(){return!!(this.buttons&1)}isRightClicked(){return!!(this.buttons&2)}}const Ke=new Z,Xn=new nt,Qs=new S;function st(a,e,t){return t.makeTranslation(-a.x,-a.y,-a.z),Ke.makeRotationFromQuaternion(e),t.premultiply(Ke),Ke.makeTranslation(a.x,a.y,a.z),t.premultiply(Ke),t}function ut(a,e,t,s){s.x=(a-t.offsetLeft)/t.clientWidth*2-1,s.y=-((e-t.offsetTop)/t.clientHeight)*2+1,s.isVector3&&(s.z=0)}function Is(a,e,t){return e.intersectRay(a,t)?t:(Ke.makeScale(...e.radius).invert(),Xn.copy(a).applyMatrix4(Ke),Qs.set(0,0,0),Xn.closestPointToPoint(Qs,t).normalize(),Ke.makeScale(...e.radius),t.applyMatrix4(Ke))}function qa(a,e,t){const s=a.origin.length(),n=Math.acos(e/s);t.copy(a.origin).multiplyScalar(-1).normalize();const r=Qs.crossVectors(t,a.direction).normalize();t.multiplyScalar(-1).applyAxisAngle(r,-n).normalize().multiplyScalar(e)}function Pe(a,e,t){const s=a instanceof nt?a:a.ray,{origin:n,direction:r}=s;n.set(e.x,e.y,-1).unproject(t),r.set(e.x,e.y,1).unproject(t).sub(n),a.isRay||(a.near=0,a.far=r.length(),a.camera=t),r.normalize()}const Ce=0,tt=1,Je=2,ht=3,Ds=4,Ns=.05,Fs=.025,Ge=new Z,we=new S,ee=new S,vt=new S,Qn=new S,at=new S,He=new Re,Zn=new Js,me=new S,es=new S,Us=new S,Ka=new Re,te=new nt,Et=new Y,ce=new Y,Yn=new Y,St=new Y,Bs=new Y,Jn=new Y,er={type:"change"},tr={type:"start"},sr={type:"end"};class $a extends Rt{get enabled(){return this._enabled}set enabled(e){e!==this.enabled&&(this._enabled=e,this.resetState(),this.pointerTracker.reset(),this.enabled||(this.dragInertia.set(0,0,0),this.rotationInertia.set(0,0)))}constructor(e=null,t=null,s=null,n=null){super(),this.isEnvironmentControls=!0,this.domElement=null,this.camera=null,this.scene=null,this.tilesRenderer=null,this._enabled=!0,this.cameraRadius=5,this.rotationSpeed=1,this.minAltitude=0,this.maxAltitude=.45*Math.PI,this.minDistance=10,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.zoomSpeed=1,this.adjustHeight=!0,this.enableDamping=!1,this.dampingFactor=.15,this.reorientOnDrag=!0,this.scaleZoomOrientationAtEdges=!1,this.state=Ce,this.pointerTracker=new Ha,this.needsUpdate=!1,this.actionHeightOffset=0,this.pivotPoint=new S,this.zoomDirectionSet=!1,this.zoomPointSet=!1,this.zoomDirection=new S,this.zoomPoint=new S,this.zoomDelta=0,this.rotationInertiaPivot=new S,this.rotationInertia=new Y,this.dragInertia=new S,this.inertiaTargetDistance=1/0,this.inertiaStableFrames=0,this.pivotMesh=new Wa,this.pivotMesh.raycast=()=>{},this.pivotMesh.scale.setScalar(.25),this.raycaster=new _o,this.raycaster.firstHitOnly=!0,this.up=new S(0,1,0),this.clock=new bo,this.fallbackPlane=new Js(new S(0,1,0),0),this.useFallbackPlane=!0,this._detachCallback=null,this._upInitialized=!1,this._lastUsedState=Ce,this._zoomPointWasSet=!1,this._tilesOnChangeCallback=()=>this.zoomPointSet=!1,s&&this.attach(s),t&&this.setCamera(t),e&&this.setScene(e),n&&this.setTilesRenderer(n)}setScene(e){this.scene=e}setCamera(e){this.camera=e,this._upInitialized=!1,this.zoomDirectionSet=!1,this.zoomPointSet=!1,this.needsUpdate=!0,this.raycaster.camera=e,this.resetState()}setTilesRenderer(e){this.tilesRenderer&&this.tilesRenderer.removeEventListener("tile-visibility-change",this._tilesOnChangeCallback),this.tilesRenderer=e,this.tilesRenderer!==null&&(this.tilesRenderer.addEventListener("tile-visibility-change",this._tilesOnChangeCallback),this.scene===null&&this.setScene(this.tilesRenderer.group))}attach(e){if(this.domElement)throw new Error("EnvironmentControls: Controls already attached to element");this.domElement=e,this.pointerTracker.domElement=e,e.style.touchAction="none";const t=l=>{l.preventDefault()},s=l=>{l.preventDefault();const{camera:u,raycaster:h,domElement:d,up:f,pivotMesh:p,pointerTracker:m,scene:g,pivotPoint:y,enabled:_}=this;if(m.addPointer(l),this.needsUpdate=!0,m.isPointerTouch()){if(p.visible=!1,m.getPointerCount()===0)d.setPointerCapture(l.pointerId);else if(m.getPointerCount()>2){this.resetState();return}}m.getCenterPoint(ce),ut(ce.x,ce.y,d,ce),Pe(h,ce,u);const C=Math.abs(h.ray.direction.dot(f));if(C<Ns||C<Fs)return;const k=this._raycast(h);k&&(m.getPointerCount()===2||m.isRightClicked()||m.isLeftClicked()&&l.shiftKey?(this.setState(m.isPointerTouch()?Ds:Je),y.copy(k.point),p.position.copy(k.point),p.visible=m.isPointerTouch()?!1:_,p.updateMatrixWorld(),g.add(p)):m.isLeftClicked()&&(this.setState(tt),y.copy(k.point),p.position.copy(k.point),p.updateMatrixWorld(),g.add(p)))};let n=!1;const r=l=>{l.preventDefault();const{pivotMesh:u,enabled:h}=this;this.zoomDirectionSet=!1,this.zoomPointSet=!1,this.state!==Ce&&(this.needsUpdate=!0);const{pointerTracker:d}=this;d.setHoverEvent(l),d.updatePointer(l)&&(d.isPointerTouch()&&d.getPointerCount()===2&&(n||(n=!0,queueMicrotask(()=>{n=!1,d.getCenterPoint(Bs);const f=d.getStartTouchPointerDistance(),p=d.getTouchPointerDistance(),m=p-f;if(this.state===Ce||this.state===Ds){d.getCenterPoint(Bs),d.getStartCenterPoint(Jn);const g=2*window.devicePixelRatio,y=Bs.distanceTo(Jn);(Math.abs(m)>g||y>g)&&(Math.abs(m)>y?(this.setState(ht),this.zoomDirectionSet=!1):this.setState(Je))}if(this.state===ht){const g=d.getPreviousTouchPointerDistance();this.zoomDelta+=p-g,u.visible=!1}else this.state===Je&&(u.visible=h)}))),this.dispatchEvent(er))},i=l=>{const{pointerTracker:u}=this;u.deletePointer(l),u.getPointerType()==="touch"&&u.getPointerCount()===0&&e.releasePointerCapture(l.pointerId),this.resetState(),this.needsUpdate=!0},o=l=>{l.preventDefault();const{pointerTracker:u}=this;u.setHoverEvent(l),u.updatePointer(l),this.dispatchEvent(tr);let h;switch(l.deltaMode){case 2:h=l.deltaY*800;break;case 1:h=l.deltaY*40;break;case 0:h=l.deltaY;break}const d=Math.sign(h),f=Math.abs(h);this.zoomDelta-=.25*d*f,this.needsUpdate=!0,this._lastUsedState=ht,this.dispatchEvent(sr)},c=l=>{const{pointerTracker:u}=this;l.buttons!==u.getPointerButtons()&&(u.deletePointer(l),this.resetState())};e.addEventListener("contextmenu",t),e.addEventListener("pointerdown",s),e.addEventListener("pointermove",r),e.addEventListener("pointerup",i),e.addEventListener("wheel",o,{passive:!1}),e.addEventListener("pointerenter",c),this._detachCallback=()=>{e.removeEventListener("contextmenu",t),e.removeEventListener("pointerdown",s),e.removeEventListener("pointermove",r),e.removeEventListener("pointerup",i),e.removeEventListener("wheel",o),e.removeEventListener("pointerenter",c)}}getUpDirection(e,t){t.copy(this.up)}getCameraUpDirection(e){this.getUpDirection(this.camera.position,e)}getPivotPoint(e){let t=null;this._lastUsedState===ht?this._zoomPointWasSet&&(t=e.copy(this.zoomPoint)):(this._lastUsedState===Je||this._lastUsedState===tt)&&(t=e.copy(this.pivotPoint));const{camera:s,raycaster:n}=this;t!==null&&(ee.copy(t).project(s),(ee.x<-1||ee.x>1||ee.y<-1||ee.y>1)&&(t=null)),Pe(n,{x:0,y:0},s);const r=this._raycast(n);return r&&(t===null||r.distance<t.distanceTo(n.ray.origin))&&(t=e.copy(r.point)),t}detach(){this.domElement=null,this._detachCallback&&(this._detachCallback(),this._detachCallback=null,this.pointerTracker.reset())}resetState(){this.state!==Ce&&this.dispatchEvent(sr),this.state=Ce,this.pivotMesh.removeFromParent(),this.pivotMesh.visible=this.enabled,this.actionHeightOffset=0}setState(e=this.state,t=!0){this.state!==e&&(this.state===Ce&&t&&this.dispatchEvent(tr),this.pivotMesh.visible=this.enabled,this.dragInertia.set(0,0,0),this.rotationInertia.set(0,0),this.inertiaStableFrames=0,this.state=e,e!==Ce&&e!==Ds&&(this._lastUsedState=e))}update(e=Math.min(this.clock.getDelta(),64/1e3)){if(!this.enabled||!this.camera||e===0)return;const{camera:t,cameraRadius:s,pivotPoint:n,up:r,state:i,adjustHeight:o}=this;t.updateMatrixWorld(),this.getCameraUpDirection(me),this._upInitialized||(this._upInitialized=!0,this.up.copy(me));const c=this._inertiaNeedsUpdate();if(this.needsUpdate||c){const h=this.zoomDelta;this._updateZoom(),this._updatePosition(e),this._updateRotation(e),i===tt||i===Je?(vt.set(0,0,-1).transformDirection(t.matrixWorld),this.inertiaTargetDistance=ee.copy(this.pivotPoint).sub(t.position).dot(vt)):i===Ce&&this._updateInertia(e),(i!==Ce||h!==0||c)&&this.dispatchEvent(er),this.needsUpdate=!1}const l=t.isOrthographicCamera?null:o&&this._getPointBelowCamera()||null,u=t.isOrthographicCamera?n:l&&l.point||null;if(this.getCameraUpDirection(me),this._setFrame(me,u),(this.state===tt||this.state===Je)&&this.actionHeightOffset!==0){const{actionHeightOffset:h}=this;t.position.addScaledVector(r,-h),n.addScaledVector(r,-h),l&&(l.distance-=h)}if(this.actionHeightOffset=0,l){const h=l.distance;if(h<s){const d=s-h;t.position.addScaledVector(r,d),n.addScaledVector(r,d),this.actionHeightOffset=d}}this.pointerTracker.updateFrame()}adjustCamera(e){const{adjustHeight:t,cameraRadius:s}=this;if(e.isPerspectiveCamera){this.getUpDirection(e.position,me);const n=t&&this._getPointBelowCamera(e.position,me)||null;if(n){const r=n.distance;r<s&&e.position.addScaledVector(me,s-r)}}}dispose(){this.detach()}_updateInertia(e){const{rotationInertia:t,pivotPoint:s,dragInertia:n,enableDamping:r,dampingFactor:i,camera:o,cameraRadius:c,minDistance:l,inertiaTargetDistance:u}=this;if(!this.enableDamping||this.inertiaStableFrames>1){n.set(0,0,0),t.set(0,0,0);return}const h=Math.pow(2,-e/i),d=Math.max(o.near,c,l,u),m=.25*(2/(2*1e3));if(t.lengthSq()>0){Pe(te,ee.set(0,0,-1),o),te.applyMatrix4(o.matrixWorldInverse),te.direction.normalize(),te.recast(-te.direction.dot(te.origin)).at(d/te.direction.z,ee),ee.applyMatrix4(o.matrixWorld),Pe(te,we.set(m,m,-1),o),te.applyMatrix4(o.matrixWorldInverse),te.direction.normalize(),te.recast(-te.direction.dot(te.origin)).at(d/te.direction.z,we),we.applyMatrix4(o.matrixWorld),ee.sub(s).normalize(),we.sub(s).normalize();const g=ee.angleTo(we)/e;t.multiplyScalar(h),(t.lengthSq()<g**2||!r)&&t.set(0,0)}if(n.lengthSq()>0){Pe(te,ee.set(0,0,-1),o),te.applyMatrix4(o.matrixWorldInverse),te.direction.normalize(),te.recast(-te.direction.dot(te.origin)).at(d/te.direction.z,ee),ee.applyMatrix4(o.matrixWorld),Pe(te,we.set(m,m,-1),o),te.applyMatrix4(o.matrixWorldInverse),te.direction.normalize(),te.recast(-te.direction.dot(te.origin)).at(d/te.direction.z,we),we.applyMatrix4(o.matrixWorld);const g=ee.distanceTo(we)/e;n.multiplyScalar(h),(n.lengthSq()<g**2||!r)&&n.set(0,0,0)}t.lengthSq()>0&&this._applyRotation(t.x*e,t.y*e,s),n.lengthSq()>0&&(o.position.addScaledVector(n,e),o.updateMatrixWorld())}_inertiaNeedsUpdate(){const{rotationInertia:e,dragInertia:t}=this;return e.lengthSq()!==0||t.lengthSq()!==0}_updateZoom(){const{zoomPoint:e,zoomDirection:t,camera:s,minDistance:n,maxDistance:r,pointerTracker:i,domElement:o,minZoom:c,maxZoom:l,zoomSpeed:u,state:h}=this;let d=this.zoomDelta;if(this.zoomDelta=0,!(!i.getLatestPoint(ce)||d===0&&h!==ht))if(this.rotationInertia.set(0,0),this.dragInertia.set(0,0,0),s.isOrthographicCamera){this._updateZoomDirection();const f=this.zoomPointSet||this._updateZoomPoint();es.unproject(s);const p=Math.pow(.95,Math.abs(d*.05));let m=d>0?1/Math.abs(p):p;m*=u,m>1?l<s.zoom*m&&(m=1):c>s.zoom*m&&(m=1),s.zoom*=m,s.updateProjectionMatrix(),f&&(ut(ce.x,ce.y,o,Us),Us.unproject(s),s.position.sub(Us).add(es),s.updateMatrixWorld())}else{this._updateZoomDirection();const f=ee.copy(t);if(this.zoomPointSet||this._updateZoomPoint()){const p=e.distanceTo(s.position);if(d<0){const m=Math.min(0,p-r);d=d*p*u*.0025,d=Math.max(d,m)}else{const m=Math.max(0,p-n);d=d*Math.max(p-n,0)*u*.0025,d=Math.min(d,m)}s.position.addScaledVector(t,d),s.updateMatrixWorld()}else{const p=this._getPointBelowCamera();if(p){const m=p.distance;f.set(0,0,-1).transformDirection(s.matrixWorld),s.position.addScaledVector(f,d*m*.01),s.updateMatrixWorld()}}}}_updateZoomDirection(){if(this.zoomDirectionSet)return;const{domElement:e,raycaster:t,camera:s,zoomDirection:n,pointerTracker:r}=this;r.getLatestPoint(ce),ut(ce.x,ce.y,e,es),Pe(t,es,s),n.copy(t.ray.direction).normalize(),this.zoomDirectionSet=!0}_updateZoomPoint(){const{camera:e,zoomDirectionSet:t,zoomDirection:s,raycaster:n,zoomPoint:r,pointerTracker:i,domElement:o}=this;if(this._zoomPointWasSet=!1,!t)return!1;e.isOrthographicCamera&&i.getLatestPoint(Et)?(ut(Et.x,Et.y,o,Et),Pe(n,Et,e)):(n.ray.origin.copy(e.position),n.ray.direction.copy(s),n.near=0,n.far=1/0);const c=this._raycast(n);return c?(r.copy(c.point),this.zoomPointSet=!0,this._zoomPointWasSet=!0,!0):!1}_getPointBelowCamera(e=this.camera.position,t=this.up){const{raycaster:s}=this;s.ray.direction.copy(t).multiplyScalar(-1),s.ray.origin.copy(e).addScaledVector(t,1e5),s.near=0,s.far=1/0;const n=this._raycast(s);return n&&(n.distance-=1e5),n}_updatePosition(e){const{raycaster:t,camera:s,pivotPoint:n,up:r,pointerTracker:i,domElement:o,state:c,dragInertia:l}=this;if(c===tt){if(i.getCenterPoint(ce),ut(ce.x,ce.y,o,ce),Zn.setFromNormalAndCoplanarPoint(r,n),Pe(t,ce,s),Math.abs(t.ray.direction.dot(r))<Ns){const u=Math.acos(Ns);at.crossVectors(t.ray.direction,r).normalize(),t.ray.direction.copy(r).applyAxisAngle(at,u).multiplyScalar(-1)}if(this.getUpDirection(n,me),Math.abs(t.ray.direction.dot(me))<Fs){const u=Math.acos(Fs);at.crossVectors(t.ray.direction,me).normalize(),t.ray.direction.copy(me).applyAxisAngle(at,u).multiplyScalar(-1)}t.ray.intersectPlane(Zn,ee)&&(we.subVectors(n,ee),s.position.add(we),s.updateMatrixWorld(),we.multiplyScalar(1/e),i.getMoveDistance()/e<2*window.devicePixelRatio?this.inertiaStableFrames++:(l.copy(we),this.inertiaStableFrames=0))}}_updateRotation(e){const{pivotPoint:t,pointerTracker:s,domElement:n,state:r,rotationInertia:i}=this;r===Je&&(s.getCenterPoint(ce),s.getPreviousCenterPoint(Yn),St.subVectors(ce,Yn).multiplyScalar(2*Math.PI/n.clientHeight),this._applyRotation(St.x,St.y,t),St.multiplyScalar(1/e),s.getMoveDistance()/e<2*window.devicePixelRatio?this.inertiaStableFrames++:(i.copy(St),this.inertiaStableFrames=0))}_applyRotation(e,t,s){if(e===0&&t===0)return;const{camera:n,minAltitude:r,maxAltitude:i,rotationSpeed:o}=this,c=-e*o;let l=t*o;vt.set(0,0,1).transformDirection(n.matrixWorld),this.getUpDirection(s,me),ee.crossVectors(me,vt).normalize(),Qn.set(1,0,0).transformDirection(n.matrixWorld).normalize();const h=Math.sign(ee.dot(Qn))*me.angleTo(vt);l>0?(l=Math.min(h-r-.01,l),l=Math.max(0,l)):(l=Math.max(h-i,l),l=Math.min(0,l)),He.setFromAxisAngle(me,c),st(s,He,Ge),n.matrixWorld.premultiply(Ge),at.set(-1,0,0).transformDirection(n.matrixWorld),He.setFromAxisAngle(at,l),st(s,He,Ge),n.matrixWorld.premultiply(Ge),n.matrixWorld.decompose(n.position,n.quaternion,ee)}_setFrame(e,t){const{up:s,camera:n,state:r,zoomPoint:i,zoomDirectionSet:o,zoomPointSet:c,reorientOnDrag:l,scaleZoomOrientationAtEdges:u}=this;n.updateMatrixWorld(),He.setFromUnitVectors(s,e);const h=r;if(o&&(c||this._updateZoomPoint())){if(this.getUpDirection(i,ee),u){let d=Math.max(ee.dot(s)-.6,0)/.4;d=Q.mapLinear(d,0,.5,0,1),d=Math.min(d,1),n.isOrthographicCamera&&(d*=.1),He.slerp(Ka,1-d)}st(i,He,Ge),n.matrixWorld.premultiply(Ge),n.matrixWorld.decompose(n.position,n.quaternion,ee),this.zoomDirectionSet=!1,this._updateZoomDirection()}else h===tt&&l&&t&&(st(t,He,Ge),n.matrixWorld.premultiply(Ge),n.matrixWorld.decompose(n.position,n.quaternion,ee));s.copy(e),n.updateMatrixWorld()}_raycast(e){const{scene:t,useFallbackPlane:s,fallbackPlane:n}=this,r=e.intersectObject(t)[0]||null;if(r)return r;if(s){const i=n;if(e.ray.intersectPlane(i,ee))return{point:ee.clone(),distance:e.ray.origin.distanceTo(ee)}}return null}}const nr=new Z,ct=new Z,Ee=new S,K=new S,Ne=new S,he=new S,Vs=new S,ts=new S,rr=new S,Me=new Re,ir=new S,et=new S,ne=new nt,zs=new nn,or={},Pt=new Y,Xa=400;class Qa extends $a{get ellipsoid(){return this.tilesRenderer?this.tilesRenderer.ellipsoid:null}get tilesGroup(){return this.tilesRenderer?this.tilesRenderer.group:null}constructor(e=null,t=null,s=null,n=null){super(e,t,s),this.isGlobeControls=!0,this._dragMode=0,this._rotationMode=0,this.maxZoom=.01,this.nearMargin=.25,this.farMargin=0,this.useFallbackPlane=!1,this.reorientOnDrag=!1,this.globeInertia=new Re,this.globeInertiaFactor=0,this.setTilesRenderer(n)}setScene(e){e===null&&this.tilesRenderer!==null?super.setScene(this.tilesRenderer.group):super.setScene(e)}getPivotPoint(e){const{camera:t,tilesGroup:s,ellipsoid:n}=this;return he.set(0,0,-1).transformDirection(t.matrixWorld),ne.origin.copy(t.position),ne.direction.copy(he),ne.applyMatrix4(s.matrixWorldInverse),Is(ne,n,K),K.applyMatrix4(s.matrixWorld),(super.getPivotPoint(e)===null||e.distanceTo(ne.origin)>K.distanceTo(ne.origin))&&e.copy(K),e}getVectorToCenter(e){const{tilesGroup:t,camera:s}=this;return e.setFromMatrixPosition(t.matrixWorld).sub(s.position)}getDistanceToCenter(){return this.getVectorToCenter(K).length()}getUpDirection(e,t){const{tilesGroup:s,ellipsoid:n}=this;K.copy(e).applyMatrix4(s.matrixWorldInverse),n.getPositionToNormal(K,t),t.transformDirection(s.matrixWorld)}getCameraUpDirection(e){const{tilesGroup:t,ellipsoid:s,camera:n}=this;n.isOrthographicCamera?(this._getVirtualOrthoCameraPosition(K),K.applyMatrix4(t.matrixWorldInverse),s.getPositionToNormal(K,e),e.transformDirection(t.matrixWorld)):this.getUpDirection(n.position,e)}update(e=Math.min(this.clock.getDelta(),64/1e3)){if(!this.enabled||!this.tilesGroup||!this.camera||e===0)return;const{camera:t,pivotMesh:s}=this;this._isNearControls()?this.scaleZoomOrientationAtEdges=this.zoomDelta<0:(this.state!==Ce&&this._dragMode!==1&&this._rotationMode!==1&&(s.visible=!1),this.scaleZoomOrientationAtEdges=!1),super.update(e),this.adjustCamera(t)}adjustCamera(e){super.adjustCamera(e);const{tilesGroup:t,ellipsoid:s,nearMargin:n,farMargin:r}=this,i=Math.max(...s.radius);if(e.isPerspectiveCamera){const o=K.setFromMatrixPosition(t.matrixWorld).sub(e.position).length(),c=n*i,l=Q.clamp((o-i)/c,0,1),u=Q.lerp(1,1e3,l);e.near=Math.max(u,o-i-c),Ee.copy(e.position).applyMatrix4(t.matrixWorldInverse),s.getPositionToCartographic(Ee,or);const h=Math.max(s.getPositionElevation(Ee),Xa),d=s.calculateHorizonDistance(or.lat,h);e.far=d*2.5+.1+i*r,e.updateProjectionMatrix()}else{this._getVirtualOrthoCameraPosition(e.position,e),e.updateMatrixWorld(),nr.copy(e.matrixWorld).invert(),K.setFromMatrixPosition(t.matrixWorld).applyMatrix4(nr);const o=-K.z;e.near=o-i*(1+n),e.far=o+.1+i*r,e.position.addScaledVector(he,e.near),e.far-=e.near,e.near=0,e.updateProjectionMatrix(),e.updateMatrixWorld()}}resetState(){super.resetState(),this._dragMode=0,this._rotationMode=0}_updateInertia(e){super._updateInertia(e);const{globeInertia:t,enableDamping:s,dampingFactor:n,camera:r,cameraRadius:i,minDistance:o,inertiaTargetDistance:c,tilesGroup:l}=this;if(!this.enableDamping||this.inertiaStableFrames>1){this.globeInertiaFactor=0,this.globeInertia.identity();return}const u=Math.pow(2,-e/n),h=Math.max(r.near,i,o,c),p=.25*(2/(2*1e3));if(Ne.setFromMatrixPosition(l.matrixWorld),this.globeInertiaFactor!==0){Pe(ne,K.set(0,0,-1),r),ne.applyMatrix4(r.matrixWorldInverse),ne.direction.normalize(),ne.recast(-ne.direction.dot(ne.origin)).at(h/ne.direction.z,K),K.applyMatrix4(r.matrixWorld),Pe(ne,Ee.set(p,p,-1),r),ne.applyMatrix4(r.matrixWorldInverse),ne.direction.normalize(),ne.recast(-ne.direction.dot(ne.origin)).at(h/ne.direction.z,Ee),Ee.applyMatrix4(r.matrixWorld),K.sub(Ne).normalize(),Ee.sub(Ne).normalize(),this.globeInertiaFactor*=u;const m=K.angleTo(Ee)/e;(2*Math.acos(t.w)*this.globeInertiaFactor<m||!s)&&(this.globeInertiaFactor=0,t.identity())}this.globeInertiaFactor!==0&&(t.w===1&&(t.x!==0||t.y!==0||t.z!==0)&&(t.w=Math.min(t.w,1-1e-9)),Ne.setFromMatrixPosition(l.matrixWorld),Me.identity().slerp(t,this.globeInertiaFactor*e),st(Ne,Me,ct),r.matrixWorld.premultiply(ct),r.matrixWorld.decompose(r.position,r.quaternion,K))}_inertiaNeedsUpdate(){return super._inertiaNeedsUpdate()||this.globeInertiaFactor!==0}_updatePosition(e){if(this.state===tt){this._dragMode===0&&(this._dragMode=this._isNearControls()?1:-1);const{raycaster:t,camera:s,pivotPoint:n,pointerTracker:r,domElement:i,tilesGroup:o}=this,c=Ee,l=ts;r.getCenterPoint(Pt),ut(Pt.x,Pt.y,i,Pt),Pe(t,Pt,s),t.ray.applyMatrix4(o.matrixWorldInverse);const u=K.copy(n).applyMatrix4(o.matrixWorldInverse).length();zs.radius.setScalar(u),s.isPerspectiveCamera?zs.intersectRay(t.ray,K)||qa(t.ray,u,K):Is(t.ray,zs,K),K.applyMatrix4(o.matrixWorld),Ne.setFromMatrixPosition(o.matrixWorld),c.subVectors(n,Ne).normalize(),l.subVectors(K,Ne).normalize(),Me.setFromUnitVectors(l,c),st(Ne,Me,ct),s.matrixWorld.premultiply(ct),s.matrixWorld.decompose(s.position,s.quaternion,K),r.getMoveDistance()/e<2*window.devicePixelRatio?this.inertiaStableFrames++:(this.globeInertia.copy(Me),this.globeInertiaFactor=1/e,this.inertiaStableFrames=0)}this._alignCameraUp(this.up)}_updateRotation(...e){this._rotationMode===1||this._isNearControls()?(this._rotationMode=1,super._updateRotation(...e)):(this.pivotMesh.visible=!1,this._rotationMode=-1),this._alignCameraUp(this.up)}_updateZoom(){const{zoomDelta:e,ellipsoid:t,zoomSpeed:s,zoomPoint:n,camera:r,maxZoom:i,state:o}=this;if(o!==ht&&e===0)return;this.rotationInertia.set(0,0),this.dragInertia.set(0,0,0),this.globeInertia.identity(),this.globeInertiaFactor=0;const c=Q.clamp(Q.mapLinear(Math.abs(e),0,20,0,1),0,1);if(this._isNearControls()||e>0){if(this._updateZoomDirection(),e<0&&(this.zoomPointSet||this._updateZoomPoint())){he.set(0,0,-1).transformDirection(r.matrixWorld).normalize(),et.copy(this.up).multiplyScalar(-1),this.getUpDirection(n,ir);const l=Q.clamp(Q.mapLinear(-ir.dot(et),1,.95,0,1),0,1),u=1-he.dot(et),h=r.isOrthographicCamera?.05:1,d=Q.clamp(c*3,0,1),f=Math.min(l*u*h*d,.1);et.lerpVectors(he,et,f).normalize(),Me.setFromUnitVectors(he,et),st(n,Me,ct),r.matrixWorld.premultiply(ct),r.matrixWorld.decompose(r.position,r.quaternion,et),this.zoomDirection.subVectors(n,r.position).normalize()}super._updateZoom()}else if(r.isPerspectiveCamera){const l=this._getPerspectiveTransitionDistance(),u=this._getMaxPerspectiveDistance(),h=Q.mapLinear(this.getDistanceToCenter(),l,u,0,1);this._tiltTowardsCenter(Q.lerp(0,.4,h*c)),this._alignCameraUpToNorth(Q.lerp(0,.2,h*c));const d=this.getDistanceToCenter()-t.radius.x,f=e*d*s*.0025,p=Math.max(f,Math.min(this.getDistanceToCenter()-u,0));this.getVectorToCenter(K).normalize(),this.camera.position.addScaledVector(K,p),this.camera.updateMatrixWorld(),this.zoomDelta=0}else{const l=this._getOrthographicTransitionZoom(),u=this._getMinOrthographicZoom(),h=Q.mapLinear(r.zoom,l,u,0,1);this._tiltTowardsCenter(Q.lerp(0,.4,h*c)),this._alignCameraUpToNorth(Q.lerp(0,.2,h*c));const d=this.zoomDelta,f=Math.pow(.95,Math.abs(d*.05)),p=d>0?1/Math.abs(f):f,m=u/r.zoom,g=Math.max(p*s,Math.min(m,1));r.zoom=Math.min(i,r.zoom*g),r.updateProjectionMatrix(),this.zoomDelta=0,this.zoomDirectionSet=!1}}_alignCameraUpToNorth(e){const{tilesGroup:t}=this;rr.set(0,0,1).transformDirection(t.matrixWorld),this._alignCameraUp(rr,e)}_alignCameraUp(e,t=null){const{camera:s}=this;he.set(0,0,-1).transformDirection(s.matrixWorld),Vs.set(-1,0,0).transformDirection(s.matrixWorld),ts.crossVectors(e,he),t===null&&(t=1-Math.abs(he.dot(e)),t=Q.mapLinear(t,0,1,-.01,1),t=Q.clamp(t,0,1)**2),ts.lerp(Vs,1-t).normalize(),Me.setFromUnitVectors(Vs,ts),s.quaternion.premultiply(Me),s.updateMatrixWorld()}_tiltTowardsCenter(e){const{camera:t,tilesGroup:s}=this;he.set(0,0,-1).transformDirection(t.matrixWorld).normalize(),K.setFromMatrixPosition(s.matrixWorld).sub(t.position).normalize(),K.lerp(he,1-e).normalize(),Me.setFromUnitVectors(he,K),t.quaternion.premultiply(Me),t.updateMatrixWorld()}_getPerspectiveTransitionDistance(){const{camera:e,ellipsoid:t}=this;if(!e.isPerspectiveCamera)throw new Error;const s=Math.max(...t.radius),n=2*Math.atan(Math.tan(Q.DEG2RAD*e.fov*.5)*e.aspect),r=s/Math.tan(Q.DEG2RAD*e.fov*.5),i=s/Math.tan(n*.5);return Math.max(r,i)}_getMaxPerspectiveDistance(){const{camera:e,ellipsoid:t}=this;if(!e.isPerspectiveCamera)throw new Error;const s=Math.max(...t.radius),n=2*Math.atan(Math.tan(Q.DEG2RAD*e.fov*.5)*e.aspect),r=s/Math.tan(Q.DEG2RAD*e.fov*.5),i=s/Math.tan(n*.5);return 2*Math.max(r,i)}_getOrthographicTransitionZoom(){const{camera:e,ellipsoid:t}=this;if(!e.isOrthographicCamera)throw new Error;const s=e.top-e.bottom,n=e.right-e.left,r=Math.max(s,n),o=2*Math.max(...t.radius);return 2*r/o}_getMinOrthographicZoom(){const{camera:e,ellipsoid:t}=this;if(!e.isOrthographicCamera)throw new Error;const s=e.top-e.bottom,n=e.right-e.left,r=Math.min(s,n),o=2*Math.max(...t.radius);return .7*r/o}_getVirtualOrthoCameraPosition(e,t=this.camera){const{tilesGroup:s,ellipsoid:n}=this;if(!t.isOrthographicCamera)throw new Error;ne.origin.copy(t.position),ne.direction.set(0,0,-1).transformDirection(t.matrixWorld),ne.applyMatrix4(s.matrixWorldInverse),Is(ne,n,Ee),Ee.applyMatrix4(s.matrixWorld);const r=t.top-t.bottom,i=t.right-t.left,o=Math.max(r,i)/t.zoom;he.set(0,0,-1).transformDirection(t.matrixWorld);const c=Ee.sub(t.position).dot(he);e.copy(t.position).addScaledVector(he,c-o*4)}_isNearControls(){const{camera:e}=this;return e.isPerspectiveCamera?this.getDistanceToCenter()<this._getPerspectiveTransitionDistance():e.zoom>this._getOrthographicTransitionZoom()}_raycast(e){const t=super._raycast(e);if(t===null){const{ellipsoid:s,tilesGroup:n}=this;ne.copy(e.ray).applyMatrix4(n.matrixWorldInverse);const r=s.intersectRay(ne,K);return r!==null?{point:r.clone().applyMatrix4(n.matrixWorld)}:null}else return t}}class Za{constructor(){this.creditsCount={}}_adjustAttributions(e,t){const s=this.creditsCount,n=e.split(/;/g);for(let r=0,i=n.length;r<i;r++){const o=n[r];o in s||(s[o]=0),s[o]+=t?1:-1,s[o]<=0&&delete s[o]}}addAttributions(e){this._adjustAttributions(e,!0)}removeAttributions(e){this._adjustAttributions(e,!1)}toString(){return Object.entries(this.creditsCount).sort((t,s)=>{const n=t[1];return s[1]-n}).map(t=>t[0]).join("; ")}}function ar(a){let e=null;return Xr(a,t=>{if(t.content&&t.content.uri){const[,s]=t.content.uri.split("?");return e=new URLSearchParams(s).get("session"),!0}return!1}),e}class Ya{constructor({apiToken:e,autoRefreshToken:t=!1,logoUrl:s=null,useRecommendedSettings:n=!0}){this.name="GOOGLE_CLOUD_AUTH_PLUGIN",this.priority=-1/0,this.apiToken=e,this.autoRefreshToken=t,this.useRecommendedSettings=n,this.logoUrl=s,this.sessionToken=null,this.tiles=null,this._onLoadCallback=null,this._visibilityChangeCallback=null,this._tokenRefreshPromise=null,this._attributionsManager=new Za,this._logoAttribution={value:"",type:"image",collapsible:!1},this._attribution={value:"",type:"string",collapsible:!0}}init(e){e!=null&&(e.resetFailedTiles(),e.rootURL==null&&(e.rootURL="https://tile.googleapis.com/v1/3dtiles/root.json"),this.useRecommendedSettings&&(e.parseQueue.maxJobs=10,e.downloadQueue.maxJobs=30,e.errorTarget=40),this.tiles=e,this._onLoadCallback=({tileSet:t})=>{this.sessionToken=ar(t.root),e.removeEventListener("load-tile-set",this._onLoadCallback)},this._visibilityChangeCallback=({tile:t,visible:s})=>{const n=t.cached.metadata.asset.copyright||"";s?this._attributionsManager.addAttributions(n):this._attributionsManager.removeAttributions(n)},e.addEventListener("load-tile-set",this._onLoadCallback),e.addEventListener("tile-visibility-change",this._visibilityChangeCallback))}getAttributions(e){this.tiles.visibleTiles.size>0&&(this.logoUrl&&(this._logoAttribution.value=this.logoUrl,e.push(this._logoAttribution)),this._attribution.value=this._attributionsManager.toString(),e.push(this._attribution))}preprocessURL(e){return e=new URL(e),/^http/.test(e.protocol)&&(e.searchParams.append("key",this.apiToken),this.sessionToken!==null&&e.searchParams.append("session",this.sessionToken)),e.toString()}dispose(){const{tiles:e}=this;e.removeEventListener("load-tile-set",this._onLoadCallback),e.removeEventListener("tile-visibility-change",this._visibilityChangeCallback)}async fetchData(e,t){this._tokenRefreshPromise!==null&&(await this._tokenRefreshPromise,e=this.preprocessURL(e));const s=await fetch(e,t);return s.status>=400&&s.status<=499&&this.autoRefreshToken?(await this._refreshToken(t),fetch(this.preprocessURL(e),t)):s}_refreshToken(e){if(this._tokenRefreshPromise===null){const t=new URL(this.tiles.rootURL);t.searchParams.append("key",this.apiToken),this._tokenRefreshPromise=fetch(t,e).then(s=>s.json()).then(s=>{this.sessionToken=ar(s.root),this._tokenRefreshPromise=null}),this._tokenRefreshPromise.catch(s=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:s,rootURL:t})})}return this._tokenRefreshPromise}}const js=new Z;class Ja{constructor(){this.name="UPDATE_ON_CHANGE_PLUGIN",this.tiles=null,this.needsUpdate=!1,this.cameraMatrices=new Map}init(e){this.tiles=e,this._needsUpdateCallback=()=>{this.needsUpdate=!0},this._onCameraAdd=({camera:t})=>{this.needsUpdate=!0,this.cameraMatrices.set(t,new Z)},this._onCameraDelete=({camera:t})=>{this.needsUpdate=!0,this.cameraMatrices.delete(t)},e.addEventListener("camera-resolution-change",this._needsUpdateCallback),e.addEventListener("load-content",this._needsUpdateCallback),e.addEventListener("add-camera",this._onCameraAdd),e.addEventListener("delete-camera",this._onCameraDelete),e.cameras.forEach(t=>{this._onCameraAdd({camera:t})})}doTilesNeedUpdate(){const e=this.tiles;let t=!1;this.cameraMatrices.forEach((n,r)=>{js.copy(e.group.matrixWorld).premultiply(r.matrixWorldInverse).premultiply(r.projectionMatrixInverse),t=t||!js.equals(n),n.copy(js)});const s=this.needsUpdate;return this.needsUpdate=!1,s||t}preprocessNode(){this.needsUpdate=!0}dispose(){const e=this.tiles;e.removeEventListener("camera-resolution-change",this._needsUpdateCallback),e.removeEventListener("load-content",this._needsUpdateCallback),e.removeEventListener("camera-add",this._onCameraAdd),e.removeEventListener("camera-delete",this._onCameraDelete)}}const cr=new S;function Mt(a,e){if(a.isInterleavedBufferAttribute||a.array instanceof e)return a;const s=e===Int8Array||e===Int16Array||e===Int32Array?-1:0,n=new e(a.count*a.itemSize),r=new ge(n,a.itemSize,!0),i=a.itemSize,o=a.count;for(let c=0;c<o;c++)for(let l=0;l<i;l++){const u=Q.clamp(a.getComponent(c,l),s,1);r.setComponent(c,l,u)}return r}function ec(a,e=Int16Array){const t=a.geometry,s=t.attributes,n=s.position;if(n.isInterleavedBufferAttribute||n.array instanceof e)return n;const r=new e(n.count*n.itemSize),i=new ge(r,n.itemSize,!1),o=n.itemSize,c=n.count;t.computeBoundingBox();const l=t.boundingBox,{min:u,max:h}=l,d=2**(8*e.BYTES_PER_ELEMENT-1)-1,f=-d;for(let p=0;p<c;p++)for(let m=0;m<o;m++){const g=m===0?"x":m===1?"y":"z",y=u[g],_=h[g],C=Q.mapLinear(n.getComponent(p,m),y,_,f,d);i.setComponent(p,m,C)}l.getCenter(cr),a.position.add(cr),a.scale.x*=.5*(h.x-u.x)/d,a.scale.y*=.5*(h.y-u.y)/d,a.scale.z*=.5*(h.z-u.z)/d,s.position=i,a.geometry.boundingBox=null,a.geometry.boundingSphere=null,a.updateMatrixWorld()}class tc{constructor(e){this._options={generateNormals:!1,disableMipmaps:!0,compressIndex:!0,compressNormals:!1,compressUvs:!1,compressPosition:!1,uvType:Int8Array,normalType:Int8Array,positionType:Int16Array,...e},this.name="TILES_COMPRESSION_PLUGIN",this.priority=-100}processTileModel(e,t){const{generateNormals:s,disableMipmaps:n,compressIndex:r,compressUvs:i,compressNormals:o,compressPosition:c,uvType:l,normalType:u,positionType:h}=this._options;e.traverse(d=>{if(d.material&&n){const f=d.material;for(const p in f){const m=f[p];m&&m.isTexture&&m.generateMipmaps&&(m.generateMipmaps=!1,m.minFilter=ss)}}if(d.geometry){const f=d.geometry,p=f.attributes;if(i){const{uv:m,uv1:g,uv2:y,uv3:_}=p;m&&(p.uv=Mt(m,l)),g&&(p.uv1=Mt(g,l)),y&&(p.uv2=Mt(y,l)),_&&(p.uv3=Mt(_,l))}if(s&&!p.normals&&f.computeVertexNormals(),o&&p.normals&&(p.normals=Mt(p.normals,u)),c&&ec(d,h),r&&f.index){const m=p.position.count,g=f.index,y=m>65535?Uint32Array:m>255?Uint16Array:Uint8Array;if(!(g.array instanceof y)){const _=new y(f.index.count);_.set(g.array);const C=new ge(_,1);f.setIndex(C)}}}})}}function le(a,e,t){return a&&e in a?a[e]:t}function pi(a){return a!=="BOOLEAN"&&a!=="STRING"&&a!=="ENUM"}function sc(a){return/^FLOAT/.test(a)}function Vt(a){return/^VEC/.test(a)}function zt(a){return/^MAT/.test(a)}function mi(a,e,t,s=null){return zt(t)||Vt(t)?s.fromArray(a,e):a[e]}function Zs(a){const{type:e,componentType:t}=a;switch(e){case"SCALAR":return t==="INT64"?0n:0;case"VEC2":return new Y;case"VEC3":return new S;case"VEC4":return new xo;case"MAT2":return new wo;case"MAT3":return new Wr;case"MAT4":return new Z;case"BOOLEAN":return!1;case"STRING":return"";case"ENUM":return 0}}function lr(a,e){if(e==null)return!1;switch(a){case"SCALAR":return typeof e=="number"||typeof e=="bigint";case"VEC2":return e.isVector2;case"VEC3":return e.isVector3;case"VEC4":return e.isVector4;case"MAT2":return e.isMatrix2;case"MAT3":return e.isMatrix3;case"MAT4":return e.isMatrix4;case"BOOLEAN":return typeof e=="boolean";case"STRING":return typeof e=="string";case"ENUM":return typeof e=="number"||typeof e=="bigint"}throw new Error("ClassProperty: invalid type.")}function Ut(a,e=null){switch(a){case"INT8":return Int8Array;case"INT16":return Int16Array;case"INT32":return Int32Array;case"INT64":return BigInt64Array;case"UINT8":return Uint8Array;case"UINT16":return Uint16Array;case"UINT32":return Uint32Array;case"UINT64":return BigUint64Array;case"FLOAT32":return Float32Array;case"FLOAT64":return Float64Array}switch(e){case"BOOLEAN":return Uint8Array;case"STRING":return Uint8Array}throw new Error("ClassProperty: invalid type.")}function nc(a,e=null){if(a.array){e=e&&Array.isArray(e)?e:[],e.length=a.count;for(let s=0,n=e.length;s<n;s++)e[s]=ns(a,e[s])}else e=ns(a,e);return e}function ns(a,e=null){const t=a.default,s=a.type;if(e=e||Zs(a),t===null){switch(s){case"SCALAR":return 0;case"VEC2":return e.set(0,0);case"VEC3":return e.set(0,0,0);case"VEC4":return e.set(0,0,0,0);case"MAT2":return e.identity();case"MAT3":return e.identity();case"MAT4":return e.identity();case"BOOLEAN":return!1;case"STRING":return"";case"ENUM":return""}throw new Error("ClassProperty: invalid type.")}else if(zt(s))e.fromArray(t);else if(Vt(s))e.fromArray(t);else return t}function rc(a,e){if(a.noData===null)return e;const t=a.noData,s=a.type;if(Array.isArray(e))for(let i=0,o=e.length;i<o;i++)e[i]=n(e[i]);else e=n(e);return e;function n(i){return r(i)&&(i=ns(a,i)),i}function r(i){if(zt(s)){const o=i.elements;for(let c=0,l=t.length;c<l;c++)if(t[c]!==o[c])return!1;return!0}else if(Vt(s)){for(let o=0,c=t.length;o<c;o++)if(t[o]!==i.getComponent(o))return!1;return!0}else return t===i}}function ic(a,e){switch(a){case"INT8":return Math.max(e/127,-1);case"INT16":return Math.max(e,32767,-1);case"INT32":return Math.max(e/2147483647,-1);case"INT64":return Math.max(Number(e)/9223372036854776e3,-1);case"UINT8":return e/255;case"UINT16":return e/65535;case"UINT32":return e/4294967295;case"UINT64":return Number(e)/18446744073709552e3}}function oc(a,e){const{type:t,componentType:s,scale:n,offset:r,normalized:i}=a;if(Array.isArray(e))for(let h=0,d=e.length;h<d;h++)e[h]=o(e[h]);else e=o(e);return e;function o(h){return zt(t)?h=l(h):Vt(t)?h=c(h):h=u(h),h}function c(h){return h.x=u(h.x),h.y=u(h.y),"z"in h&&(h.z=u(h.z)),"w"in h&&(h.w=u(h.w)),h}function l(h){const d=h.elements;for(let f=0,p=d.length;f<p;f++)d[f]=u(d[f]);return h}function u(h){return i&&(h=ic(s,h)),(i||sc(s))&&(h=h*n+r),h}}function rn(a,e,t=null){if(a.array){Array.isArray(e)||(e=new Array(a.count||0)),e.length=t!==null?t:a.count;for(let s=0,n=e.length;s<n;s++)lr(a.type,e[s])||(e[s]=Zs(a))}else lr(a.type,e)||(e=Zs(a));return e}function rs(a,e){for(const t in e)t in a||delete e[t];for(const t in a){const s=a[t];e[t]=rn(s,e[t])}}function ac(a){switch(a){case"ENUM":return 1;case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;case"BOOLEAN":return-1;case"STRING":return-1;default:return-1}}class ds{constructor(e,t,s=null){this.name=t.name||null,this.description=t.description||null,this.type=t.type,this.componentType=t.componentType||null,this.enumType=t.enumType||null,this.array=t.array||!1,this.count=t.count||0,this.normalized=t.normalized||!1,this.offset=t.offset||0,this.scale=le(t,"scale",1),this.max=le(t,"max",1/0),this.min=le(t,"min",-1/0),this.required=t.required||!1,this.noData=le(t,"noData",null),this.default=le(t,"default",null),this.semantic=le(t,"semantic",null),this.enumSet=null,this.accessorProperty=s,s&&(this.offset=le(s,"offset",this.offset),this.scale=le(s,"scale",this.scale),this.max=le(s,"max",this.max),this.min=le(s,"min",this.min)),t.type==="ENUM"&&(this.enumSet=e[this.enumType],this.componentType===null&&(this.componentType=le(this.enumSet,"valueType","UINT16")))}shapeToProperty(e,t=null){return rn(this,e,t)}resolveDefaultElement(e){return ns(this,e)}resolveDefault(e){return nc(this,e)}resolveNoData(e){return rc(this,e)}resolveEnumsToStrings(e){const t=this.enumSet;if(this.type==="ENUM")if(Array.isArray(e))for(let n=0,r=e.length;n<r;n++)e[n]=s(e[n]);else e=s(e);return e;function s(n){const r=t.values.find(i=>i.value===n);return r===null?"":r.name}}adjustValueScaleOffset(e){return pi(this.type)?oc(this,e):e}}class on{constructor(e,t={},s={},n=null){this.definition=e,this.class=t[e.class],this.className=e.class,this.enums=s,this.data=n,this.name="name"in e?e.name:null,this.properties=null}getPropertyNames(){return Object.keys(this.class.properties)}includesData(e){return!!this.definition.properties[e]}dispose(){}_initProperties(e=ds){const t={};for(const s in this.class.properties)t[s]=new e(this.enums,this.class.properties[s],this.definition.properties[s]);this.properties=t}}class cc extends ds{constructor(e,t,s=null){super(e,t,s),this.attribute=s.attribute}}class lc extends on{constructor(...e){super(...e),this.isPropertyAttributeAccessor=!0,this._initProperties(cc)}getData(e,t,s={}){const n=this.properties;rs(n,s);for(const r in n)s[r]=this.getPropertyValue(r,e,t,s[r]);return s}getPropertyValue(e,t,s,n=null){if(t>=this.count)throw new Error("PropertyAttributeAccessor: Requested index is outside the range of the buffer.");const r=this.properties[e],i=r.type;if(r){if(!this.definition.properties[e])return r.resolveDefault(n)}else throw new Error("PropertyAttributeAccessor: Requested class property does not exist.");n=r.shapeToProperty(n);const o=s.getAttribute(r.attribute.toLowerCase());if(zt(i)){const c=n.elements;for(let l=0,u=c.length;l<u;l<u)c[l]=o.getComponent(t,l)}else if(Vt(i))n.fromBufferAttribute(o,t);else if(i==="SCALAR"||i==="ENUM")n=o.getX(t);else throw new Error("StructuredMetadata.PropertyAttributeAccessor: BOOLEAN and STRING types are not supported by property attributes.");return n=r.adjustValueScaleOffset(n),n=r.resolveEnumsToStrings(n),n=r.resolveNoData(n),n}}class uc extends ds{constructor(e,t,s=null){super(e,t,s),this.values=s.values,this.valueLength=ac(this.type),this.arrayOffsets=le(s,"arrayOffsets",null),this.stringOffsets=le(s,"stringOffsets",null),this.arrayOffsetType=le(s,"arrayOffsetType","UINT32"),this.stringOffsetType=le(s,"stringOffsetType","UINT32")}getArrayLengthFromId(e,t){let s=this.count;if(this.arrayOffsets!==null){const{arrayOffsets:n,arrayOffsetType:r}=this,i=Ut(r),o=new i(e[n]);s=o[t+1]-o[t]}return s}getIndexOffsetFromId(e,t){let s=t;if(this.arrayOffsets){const{arrayOffsets:n,arrayOffsetType:r}=this,i=Ut(r);s=new i(e[n])[s]}else this.array&&(s*=this.count);return s}}class hc extends on{constructor(...e){super(...e),this.isPropertyTableAccessor=!0,this.count=this.definition.count,this._initProperties(uc)}getData(e,t={}){const s=this.properties;rs(s,t);for(const n in s)t[n]=this.getPropertyValue(n,e,t[n]);return t}_readValueAtIndex(e,t,s,n=null){const r=this.properties[e],{componentType:i,type:o}=r,c=this.data,l=c[r.values],u=Ut(i,o),h=new u(l),d=r.getIndexOffsetFromId(c,t);if(pi(o)||o==="ENUM")return mi(h,(d+s)*r.valueLength,o,n);if(o==="STRING"){let f=d+s,p=0;if(r.stringOffsets!==null){const{stringOffsets:g,stringOffsetType:y}=r,_=Ut(y),C=new _(c[g]);p=C[f+1]-C[f],f=C[f]}const m=new Uint8Array(h.buffer,f,p);n=new TextDecoder().decode(m)}else if(o==="BOOLEAN"){const f=d+s,p=Math.floor(f/8),m=f%8;n=(h[p]>>m&1)===1}return n}getPropertyValue(e,t,s=null){if(t>=this.count)throw new Error("PropertyTableAccessor: Requested index is outside the range of the table.");const n=this.properties[e];if(n){if(!this.definition.properties[e])return n.resolveDefault(s)}else throw new Error("PropertyTableAccessor: Requested property does not exist.");const r=n.array,i=this.data,o=n.getArrayLengthFromId(i,t);if(s=n.shapeToProperty(s,o),r)for(let c=0,l=s.length;c<l;c++)s[c]=this._readValueAtIndex(e,t,c,s[c]);else s=this._readValueAtIndex(e,t,0,s);return s=n.adjustValueScaleOffset(s),s=n.resolveEnumsToStrings(s),s=n.resolveNoData(s),s}}const dc=new Br(-1,1,1,-1,0,1);class fc extends Bt{constructor(){super(),this.setAttribute("position",new gn([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new gn([0,2,0,0,2,0],2))}}const pc=new fc;class mc{constructor(e){this._mesh=new os(pc,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,dc)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}const Ct=new Po;class ur{constructor(){this._renderer=new Ao,this._target=new yn(1,1),this._texTarget=new yn,this._quad=new mc(new Gr({blending:So,blendDst:Eo,blendSrc:vo,uniforms:{map:{value:null},pixel:{value:new Y}},vertexShader:`
				void main() {

					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

				}
			`,fragmentShader:`
				uniform sampler2D map;
				uniform ivec2 pixel;

				void main() {

					gl_FragColor = texelFetch( map, pixel, 0 );

				}
			`}))}increaseSizeTo(e){this._target.setSize(Math.max(this._target.width,e),1)}readDataAsync(e){const{_renderer:t,_target:s}=this;return t.readRenderTargetPixelsAsync(s,0,0,e.length/4,1,e)}readData(e){const{_renderer:t,_target:s}=this;t.readRenderTargetPixels(s,0,0,e.length/4,1,e)}renderPixelToTarget(e,t,s){const{_renderer:n,_target:r}=this;Ct.min.copy(t),Ct.max.copy(t),Ct.max.x+=1,Ct.max.y+=1,n.initRenderTarget(r),n.copyTextureToTexture(e,r.texture,Ct,s,0)}}const $e=new class{constructor(){let a=null;Object.getOwnPropertyNames(ur.prototype).forEach(e=>{e!=="constructor"&&(this[e]=(...t)=>(a=a||new ur,a[e](...t)))})}},hr=new Y,dr=new Y,fr=new Y;function gc(a,e){return e===0?a.getAttribute("uv"):a.getAttribute(`uv${e}`)}function gi(a,e,t=new Array(3)){let s=3*e,n=3*e+1,r=3*e+2;return a.index&&(s=a.index.getX(s),n=a.index.getX(n),r=a.index.getX(r)),t[0]=s,t[1]=n,t[2]=r,t}function yi(a,e,t,s,n){const[r,i,o]=s,c=gc(a,e);hr.fromBufferAttribute(c,r),dr.fromBufferAttribute(c,i),fr.fromBufferAttribute(c,o),n.set(0,0,0).addScaledVector(hr,t.x).addScaledVector(dr,t.y).addScaledVector(fr,t.z)}function Ti(a,e,t,s){const n=a.x-Math.floor(a.x),r=a.y-Math.floor(a.y),i=Math.floor(n*e%e),o=Math.floor(r*t%t);return s.set(i,o),s}const pr=new Y,mr=new Y,gr=new Y;class yc extends ds{constructor(e,t,s=null){super(e,t,s),this.channels=le(s,"channels",[0]),this.index=le(s,"index",null),this.texCoord=le(s,"texCoord",null),this.valueLength=parseInt(this.type.replace(/[^0-9]/g,""))||1}readDataFromBuffer(e,t,s=null){const n=this.type;if(n==="BOOLEAN"||n==="STRING")throw new Error("PropertyTextureAccessor: BOOLEAN and STRING types not supported.");return mi(e,t*this.valueLength,n,s)}}class Tc extends on{constructor(...e){super(...e),this.isPropertyTextureAccessor=!0,this._asyncRead=!1,this._initProperties(yc)}getData(e,t,s,n={}){const r=this.properties;rs(r,n);const i=Object.keys(r),o=i.map(c=>n[c]);return this.getPropertyValuesAtTexel(i,e,t,s,o),i.forEach((c,l)=>n[c]=o[l]),n}async getDataAsync(e,t,s,n={}){const r=this.properties;rs(r,n);const i=Object.keys(r),o=i.map(c=>n[c]);return await this.getPropertyValuesAtTexelAsync(i,e,t,s,o),i.forEach((c,l)=>n[c]=o[l]),n}getPropertyValuesAtTexelAsync(...e){this._asyncRead=!0;const t=this.getPropertyValuesAtTexel(...e);return this._asyncRead=!1,t}getPropertyValuesAtTexel(e,t,s,n,r=[]){for(;r.length<e.length;)r.push(null);r.length=e.length,$e.increaseSizeTo(r.length);const i=this.data,o=this.definition.properties,c=this.properties,l=gi(n,t);for(let d=0,f=e.length;d<f;d++){const p=e[d];if(!o[p])continue;const m=c[p],g=i[m.index];yi(n,m.texCoord,s,l,pr),Ti(pr,g.image.width,g.image.height,mr),gr.set(d,0),$e.renderPixelToTarget(g,mr,gr)}const u=new Uint8Array(e.length*4);if(this._asyncRead)return $e.readDataAsync(u).then(()=>(h.call(this),r));return $e.readData(u),h.call(this),r;function h(){for(let d=0,f=e.length;d<f;d++){const p=e[d],m=c[p],g=m.type;if(r[d]=rn(m,r[d]),m){if(!o[p]){r[d]=m.resolveDefault(r);continue}}else throw new Error("PropertyTextureAccessor: Requested property does not exist.");const y=m.valueLength*(m.count||1),_=m.channels.map(L=>u[4*d+L]),C=m.componentType,k=Ut(C,g),A=new k(y);if(new Uint8Array(A.buffer).set(_),m.array){const L=r[d];for(let I=0,O=L.length;I<O;I++)L[I]=m.readDataFromBuffer(A,I,L[I])}else r[d]=m.readDataFromBuffer(A,0,r[d]);r[d]=m.adjustValueScaleOffset(r[d]),r[d]=m.resolveEnumsToStrings(r[d]),r[d]=m.resolveNoData(r[d])}}}dispose(){this.data.forEach(e=>{e&&(e.dispose(),e.image instanceof ImageBitmap&&e.image.close())})}}class yr{constructor(e,t,s,n=null,r=null){const{schema:i,propertyTables:o=[],propertyTextures:c=[],propertyAttributes:l=[]}=e,{enums:u,classes:h}=i,d=o.map(m=>new hc(m,h,u,s));let f=[],p=[];n&&(n.propertyTextures&&(f=n.propertyTextures.map(m=>new Tc(c[m],h,u,t))),n.propertyAttributes&&(p=n.propertyAttributes.map(m=>new lc(l[m],h,u)))),this.schema=i,this.tableAccessors=d,this.textureAccessors=f,this.attributeAccessors=p,this.object=r,this.textures=t,this.nodeMetadata=n}getPropertyTableData(e,t,s=null){if(!Array.isArray(e)||!Array.isArray(t))s=s||{},s=this.tableAccessors[e].getData(t,s);else{s=s||[];const n=Math.min(e.length,t.length);s.length=n;for(let r=0;r<n;r++){const i=this.tableAccessors[e[r]];s[r]=i.getData(t[r],s[r])}}return s}getPropertyTableInfo(e=null){if(e===null&&(e=this.tableAccessors.map((t,s)=>s)),Array.isArray(e))return e.map(t=>{const s=this.tableAccessors[t];return{name:s.name,className:s.definition.class}});{const t=this.tableAccessors[e];return{name:t.name,className:t.definition.class}}}getPropertyTextureData(e,t,s=[]){const n=this.textureAccessors;s.length=n.length;for(let r=0;r<n.length;r++){const i=n[r];s[r]=i.getData(e,t,this.object.geometry,s[r])}return s}async getPropertyTextureDataAsync(e,t,s=[]){const n=this.textureAccessors;s.length=n.length;const r=[];for(let i=0;i<n.length;i++){const c=n[i].getDataAsync(e,t,this.object.geometry,s[i]).then(l=>{s[i]=l});r.push(c)}return await Promise.all(r),s}getPropertyTextureInfo(){return this.textureAccessors}getPropertyAttributeData(e,t=[]){const s=this.attributeAccessors;t.length=s.length;for(let n=0;n<s.length;n++){const r=s[n];t[n]=r.getData(e,this.object.geometry,t[n])}return t}getPropertyAttributeInfo(){return this.attributeAccessors.map(e=>({name:e.name,className:e.definition.class}))}dispose(){this.textureAccessors.forEach(e=>e.dispose()),this.tableAccessors.forEach(e=>e.dispose()),this.attributeAccessors.forEach(e=>e.dispose())}}const kt="EXT_structural_metadata";function _c(a,e=[]){var n;const t=((n=a.json.textures)==null?void 0:n.length)||0,s=new Array(t).fill(null);return e.forEach(({properties:r})=>{for(const i in r){const{index:o}=r[i];s[o]===null&&(s[o]=a.loadTexture(o))}}),Promise.all(s)}function bc(a,e=[]){var n;const t=((n=a.json.bufferViews)==null?void 0:n.length)||0,s=new Array(t).fill(null);return e.forEach(({properties:r})=>{for(const i in r){const{values:o,arrayOffsets:c,stringOffsets:l}=r[i];s[o]===null&&(s[o]=a.loadBufferView(o)),s[c]===null&&(s[c]=a.loadBufferView(c)),s[l]===null&&(s[l]=a.loadBufferView(l))}}),Promise.all(s)}class wc{constructor(e){this.parser=e,this.name=kt}async afterRoot({scene:e,parser:t}){const s=t.json.extensionsUsed;if(!s||!s.includes(kt))return;let n=null,r=t.json.extensions[kt];if(r.schemaUri){const{manager:l,path:u,requestHeader:h,crossOrigin:d}=t.options,f=new URL(r.schemaUri,u).toString(),p=new Dt(l);p.setCrossOrigin(d),p.setResponseType("json"),p.setRequestHeader(h),n=p.loadAsync(f).then(m=>{r={...r,schema:m}})}const[i,o]=await Promise.all([_c(t,r.propertyTextures),bc(t,r.propertyTables),n]),c=new yr(r,i,o);e.userData.structuralMetadata=c,e.traverse(l=>{var u;if(t.associations.has(l)){const{meshes:h,primitives:d}=t.associations.get(l),f=(u=t.json.meshes[h])==null?void 0:u.primitives[d];if(f&&f.extensions&&f.extensions[kt]){const p=f.extensions[kt];l.userData.structuralMetadata=new yr(r,i,o,p,l)}else l.userData.structuralMetadata=c}})}}const Tr=new Y,_r=new Y,br=new Y;function xc(a){return a.x>a.y&&a.x>a.z?0:a.y>a.z?1:2}class Ac{constructor(e,t,s){this.geometry=e,this.textures=t,this.data=s,this._asyncRead=!1,this.featureIds=s.featureIds.map(n=>{const{texture:r,...i}=n,o={label:null,propertyTable:null,nullFeatureId:null,...i};return r&&(o.texture={texCoord:0,channels:[0],...r}),o})}getTextures(){return this.textures}getFeatureInfo(){return this.featureIds}getFeaturesAsync(...e){this._asyncRead=!0;const t=this.getFeatures(...e);return this._asyncRead=!1,t}getFeatures(e,t){const{geometry:s,textures:n,featureIds:r}=this,i=new Array(r.length).fill(null),o=r.length;$e.increaseSizeTo(o);const c=gi(s,e),l=c[xc(t)];for(let d=0,f=r.length;d<f;d++){const p=r[d],m="nullFeatureId"in p?p.nullFeatureId:null;if("texture"in p){const g=n[p.texture.index];yi(s,p.texture.texCoord,t,c,Tr),Ti(Tr,g.image.width,g.image.height,_r),br.set(d,0),$e.renderPixelToTarget(n[p.texture.index],_r,br)}else if("attribute"in p){const y=s.getAttribute(`_feature_id_${p.attribute}`).getX(l);y!==m&&(i[d]=y)}else{const g=l;g!==m&&(i[d]=g)}}const u=new Uint8Array(o*4);if(this._asyncRead)return $e.readDataAsync(u).then(()=>(h(),i));return $e.readData(u),h(),i;function h(){const d=new Uint32Array(1);for(let f=0,p=r.length;f<p;f++){const m=r[f],g="nullFeatureId"in m?m.nullFeatureId:null;if("texture"in m){const{channels:y}=m.texture,_=y.map(k=>u[4*f+k]);new Uint8Array(d.buffer).set(_);const C=d[0];C!==g&&(i[f]=C)}}}}dispose(){this.textures.forEach(e=>{e&&(e.dispose(),e.image instanceof ImageBitmap&&e.image.close())})}}const is="EXT_mesh_features";function wr(a,e,t){a.traverse(s=>{var n;if(e.associations.has(s)){const{meshes:r,primitives:i}=e.associations.get(s),o=(n=e.json.meshes[r])==null?void 0:n.primitives[i];o&&o.extensions&&o.extensions[is]&&t(s,o.extensions[is])}})}class vc{constructor(e){this.parser=e,this.name=is}async afterRoot({scene:e,parser:t}){var o;const s=t.json.extensionsUsed;if(!s||!s.includes(is))return;const n=((o=t.json.textures)==null?void 0:o.length)||0,r=new Array(n).fill(null);wr(e,t,(c,{featureIds:l})=>{l.forEach(u=>{if(u.texture&&r[u.texture.index]===null){const h=u.texture.index;r[h]=t.loadTexture(h)}})});const i=await Promise.all(r);wr(e,t,(c,l)=>{c.userData.meshFeatures=new Ac(c.geometry,i,l)})}}class Ec{constructor(){this.name="CESIUM_RTC"}afterRoot(e){if(e.parser.json.extensions&&e.parser.json.extensions.CESIUM_RTC){const{center:t}=e.parser.json.extensions.CESIUM_RTC;t&&(e.scene.position.x+=t[0],e.scene.position.y+=t[1],e.scene.position.z+=t[2])}}}class Sc{constructor(e){e={metadata:!0,rtc:!0,plugins:[],dracoLoader:null,ktxLoader:null,meshoptDecoder:null,autoDispose:!0,...e},this.tiles=null,this.metadata=e.metadata,this.rtc=e.rtc,this.plugins=e.plugins,this.dracoLoader=e.dracoLoader,this.ktxLoader=e.ktxLoader,this.meshoptDecoder=e.meshoptDecoder,this._gltfRegex=/\.(gltf|glb)$/g,this._dracoRegex=/\.drc$/g,this._loader=null}init(e){const t=new us(e.manager);this.dracoLoader&&(t.setDRACOLoader(this.dracoLoader),e.manager.addHandler(this._dracoRegex,this.dracoLoader)),this.ktxLoader&&t.setKTX2Loader(this.ktxLoader),this.meshoptDecoder&&t.setMeshoptDecoder(this.meshoptDecoder),this.rtc&&t.register(()=>new Ec),this.metadata&&(t.register(()=>new wc),t.register(()=>new vc)),this.plugins.forEach(s=>t.register(s)),e.manager.addHandler(this._gltfRegex,t),this.tiles=e,this._loader=t}dispose(){this.tiles.manager.removeHandler(this._gltfRegex),this.tiles.manager.removeHandler(this._dracoRegex),this.autoDispose&&(this.ktxLoader.dispose(),this.dracoLoader.dispose())}}class Pc{set delay(e){this.deferCallbacks.delay=e}get delay(){return this.deferCallbacks.delay}set bytesTarget(e){this.lruCache.minBytesSize=e}get bytesTarget(){return this.lruCache.minBytesSize}get estimatedGpuBytes(){return this.lruCache.cachedBytes}constructor(e={}){const{delay:t=0,bytesTarget:s=0}=e;this.name="UNLOAD_TILES_PLUGIN",this.tiles=null,this.lruCache=new Hr,this.deferCallbacks=new Mc,this.delay=t,this.bytesTarget=s}init(e){this.tiles=e;const{lruCache:t,deferCallbacks:s}=this;s.callback=r=>{t.markUnused(r),t.scheduleUnload(!1)};const n=r=>{const i=r.cached.scene;e.visibleTiles.has(r)||e.invokeOnePlugin(c=>c.unloadTileFromGPU&&c.unloadTileFromGPU(i,r))};this._onUpdateBefore=()=>{t.unloadPriorityCallback=e.lruCache.unloadPriorityCallback,t.computeMemoryUsageCallback=e.lruCache.computeMemoryUsageCallback,t.minSize=1/0,t.maxSize=1/0,t.maxBytesSize=1/0,t.unloadPercent=1,t.autoMarkUnused=!1},this._onVisibilityChangeCallback=({tile:r,visible:i})=>{i?(t.add(r,n),e.markTileUsed(r),s.cancel(r)):s.run(r)},e.forEachLoadedModel((r,i)=>{const o=e.visibleTiles.has(i);this._onVisibilityChangeCallback({scene:r,visible:o})}),e.addEventListener("tile-visibility-change",this._onVisibilityChangeCallback),e.addEventListener("update-before",this._onUpdateBefore)}unloadTileFromGPU(e,t){e&&e.traverse(s=>{if(s.material){const n=s.material;n.dispose();for(const r in n){const i=n[r];i&&i.isTexture&&i.dispose()}}s.geometry&&s.geometry.dispose()})}dispose(){this.tiles.removeEventListener("tile-visibility-change",this._onVisibilityChangeCallback),this.tiles.removeEventListener("update-before",this._onUpdateBefore),this.deferCallbacks.cancelAll()}}class Mc{constructor(e=()=>{}){this.map=new Map,this.callback=e,this.delay=0}run(e){const{map:t,delay:s}=this;if(t.has(e))throw new Error("DeferCallbackManager: Callback already initialized.");s===0?this.callback(e):t.set(e,setTimeout(()=>this.callback(e),s))}cancel(e){const{map:t}=this;t.has(e)&&(clearTimeout(t.get(e)),t.delete(e))}cancelAll(){this.map.forEach((e,t)=>{this.cancel(t)})}}const{clamp:Ws}=Q;class Cc{constructor(){this.duration=250,this.fadeCount=0,this._lastTick=-1,this._fadeState=new Map,this.onFadeComplete=null,this.onFadeStart=null,this.onFadeSetComplete=null,this.onFadeSetStart=null}deleteObject(e){e&&this.completeFade(e)}guaranteeState(e){const t=this._fadeState;if(t.has(e))return!1;const s={fadeInTarget:0,fadeOutTarget:0,fadeIn:0,fadeOut:0};return t.set(e,s),!0}completeFade(e){const t=this._fadeState;if(!t.has(e))return;const s=t.get(e).fadeOutTarget===0;t.delete(e),this.fadeCount--,this.onFadeComplete&&this.onFadeComplete(e,s),this.fadeCount===0&&this.onFadeSetComplete&&this.onFadeSetComplete()}completeAllFades(){this._fadeState.forEach((e,t)=>{this.completeFade(t)})}forEachObject(e){this._fadeState.forEach((t,s)=>{e(s,t)})}fadeIn(e){const t=this.guaranteeState(e),s=this._fadeState.get(e);s.fadeInTarget=1,s.fadeOutTarget=0,s.fadeOut=0,t&&(this.fadeCount++,this.fadeCount===1&&this.onFadeSetStart&&this.onFadeSetStart(),this.onFadeStart&&this.onFadeStart(e))}fadeOut(e){const t=this.guaranteeState(e),s=this._fadeState.get(e);s.fadeOutTarget=1,t&&(s.fadeInTarget=1,s.fadeIn=1,this.fadeCount++,this.fadeCount===1&&this.onFadeSetStart&&this.onFadeSetStart(),this.onFadeStart&&this.onFadeStart(e))}isFading(e){return this._fadeState.has(e)}isFadingOut(e){const t=this._fadeState.get(e);return t&&t.fadeOutTarget===1}update(){const e=window.performance.now();this._lastTick===-1&&(this._lastTick=e);const t=Ws((e-this._lastTick)/this.duration,0,1);this._lastTick=e,this._fadeState.forEach((n,r)=>{const{fadeOutTarget:i,fadeInTarget:o}=n;let{fadeOut:c,fadeIn:l}=n;const u=Math.sign(o-l);l=Ws(l+u*t,0,1);const h=Math.sign(i-c);c=Ws(c+h*t,0,1),n.fadeIn=l,n.fadeOut=c,((c===1||c===0)&&(l===1||l===0)||c>=l)&&this.completeFade(r)})}}function _i(a,e){const t={fadeIn:{value:0},fadeOut:{value:0},fadeTexture:{value:null}};return a.defines={...a.defines||{},FEATURE_FADE:0},a.onBeforeCompile=s=>{e&&e(s),s.uniforms={...s.uniforms,...t},s.vertexShader=s.vertexShader.replace(/void\s+main\(\)\s+{/,n=>`
					#ifdef USE_BATCHING_FRAG

					varying float vBatchId;

					#endif

					${n}

						#ifdef USE_BATCHING_FRAG

						// add 0.5 to the value to avoid floating error that may cause flickering
						vBatchId = getIndirectIndex( gl_DrawID ) + 0.5;

						#endif
				`),s.fragmentShader=s.fragmentShader.replace(/void main\(/,n=>`
				#if FEATURE_FADE

				// adapted from https://www.shadertoy.com/view/Mlt3z8
				float bayerDither2x2( vec2 v ) {

					return mod( 3.0 * v.y + 2.0 * v.x, 4.0 );

				}

				float bayerDither4x4( vec2 v ) {

					vec2 P1 = mod( v, 2.0 );
					vec2 P2 = floor( 0.5 * mod( v, 4.0 ) );
					return 4.0 * bayerDither2x2( P1 ) + bayerDither2x2( P2 );

				}

				// the USE_BATCHING define is not available in fragment shaders
				#ifdef USE_BATCHING_FRAG

				// functions for reading the fade state of a given batch id
				uniform sampler2D fadeTexture;
				varying float vBatchId;
				vec2 getFadeValues( const in float i ) {

					int size = textureSize( fadeTexture, 0 ).x;
					int j = int( i );
					int x = j % size;
					int y = j / size;
					return texelFetch( fadeTexture, ivec2( x, y ), 0 ).rg;

				}

				#else

				uniform float fadeIn;
				uniform float fadeOut;

				#endif

				#endif

				${n}
			`).replace(/#include <dithering_fragment>/,n=>`

				${n}

				#if FEATURE_FADE

				#ifdef USE_BATCHING_FRAG

				vec2 fadeValues = getFadeValues( vBatchId );
				float fadeIn = fadeValues.r;
				float fadeOut = fadeValues.g;

				#endif

				float bayerValue = bayerDither4x4( floor( mod( gl_FragCoord.xy, 4.0 ) ) );
				float bayerBins = 16.0;
				float dither = ( 0.5 + bayerValue ) / bayerBins;
				if ( dither >= fadeIn ) {

					discard;

				}

				if ( dither < fadeOut ) {

					discard;

				}

				#endif

			`)},t}class kc{constructor(){this._fadeParams=new WeakMap,this.fading=0}setFade(e,t,s){if(!e)return;const n=this._fadeParams;e.traverse(r=>{const i=r.material;if(i){const o=n.get(i);o.fadeIn.value=t,o.fadeOut.value=s;const u=+(!(t===0||t===1)||!(s===0||s===1));i.defines.FEATURE_FADE!==u&&(this.fading+=u===1?1:-1,i.defines.FEATURE_FADE=u,i.needsUpdate=!0)}})}prepareScene(e){e.traverse(t=>{t.material&&this.prepareMaterial(t.material)})}deleteScene(e){if(!e)return;const t=this._fadeParams;e.traverse(s=>{const n=s.material;n&&(t.delete(n),n.onBeforeCompile=()=>{},n.needsUpdate=!0)})}prepareMaterial(e){const t=this._fadeParams;t.has(e)||t.set(e,_i(e))}}class Rc{constructor(e,t=new dt){this.other=e,this.material=t,this.visible=!0,this.parent=null,this._instanceInfo=[],this._visibilityChanged=!0;const s=new Proxy(this,{get(n,r){if(r in n)return n[r];{const i=e[r];return i instanceof Function?(...o)=>(n.syncInstances(),i.call(s,...o)):e[r]}},set(n,r,i){return r in n?n[r]=i:e[r]=i,!0},deleteProperty(n,r){return r in n?delete n[r]:delete e[r]}});return s}syncInstances(){const e=this._instanceInfo,t=this.other._instanceInfo;for(;t.length>e.length;){const s=e.length;e.push(new Proxy({visible:!1},{get(n,r){return r in n?n[r]:t[s][r]},set(n,r,i){return r in n?n[r]=i:t[s][r]=i,!0}}))}}}class Lc extends Rc{constructor(...e){super(...e);const t=this.material,s=_i(t,t.onBeforeCompile);t.defines.FEATURE_FADE=1,t.defines.USE_BATCHING_FRAG=1,t.needsUpdate=!0,this.fadeTexture=null,this._fadeParams=s}setFadeAt(e,t,s){this._initFadeTexture(),this.fadeTexture.setValueAt(e,t*255,s*255)}_initFadeTexture(){let e=Math.sqrt(this._maxInstanceCount);e=Math.ceil(e);const t=e*e*2,s=this.fadeTexture;if(!s||s.image.data.length!==t){const n=new Uint8Array(t),r=new Oc(n,e,e,Mo,Co);if(s){s.dispose();const i=s.image.data,o=this.fadeTexture.image.data,c=Math.min(i.length,o.length);o.set(new i.constructor(i.buffer,0,c))}this.fadeTexture=r,this._fadeParams.fadeTexture.value=r,r.needsUpdate=!0}}dispose(){this.fadeTexture&&this.fadeTexture.dispose()}}class Oc extends ko{setValueAt(e,...t){const{data:s,width:n,height:r}=this.image,i=Math.floor(s.length/(n*r));let o=!1;for(let c=0;c<i;c++){const l=e*i+c,u=s[l],h=t[c]||0;u!==h&&(s[l]=h,o=!0)}o&&(this.needsUpdate=!0)}}const xr=Symbol("HAS_POPPED_IN"),Ar=new S,vr=new S,Er=new Re,Sr=new Re,Pr=new S;function Ic(){const a=this._fadeManager,e=this.tiles;this._fadingBefore=a.fadeCount,this._displayActiveTiles=e.displayActiveTiles,e.displayActiveTiles=!0}function Dc(){const a=this._fadeManager,e=this._fadeMaterialManager,t=this._displayActiveTiles,s=this._fadingBefore,n=this._prevCameraTransforms,{tiles:r,maximumFadeOutTiles:i,batchedMesh:o}=this,{cameras:c}=r;r.displayActiveTiles=t,a.update();const l=a.fadeCount;if(s!==0&&l!==0&&(r.dispatchEvent({type:"fade-change"}),r.dispatchEvent({type:"force-rerender"})),t||r.visibleTiles.forEach(u=>{const h=u.cached.scene;h&&(h.visible=u.__inFrustum),this.forEachBatchIds(u,(d,f,p)=>{f.setVisibleAt(d,u.__inFrustum),p.batchedMesh.setVisibleAt(d,u.__inFrustum)})}),i<this._fadingOutCount){let u=!0;c.forEach(h=>{if(!n.has(h))return;const d=h.matrixWorld,f=n.get(h);d.decompose(vr,Sr,Pr),f.decompose(Ar,Er,Pr);const p=Sr.angleTo(Er),m=vr.distanceTo(Ar);u=u&&(p>.25||m>.1)}),u&&a.completeAllFades()}if(c.forEach(u=>{n.get(u).copy(u.matrixWorld)}),a.forEachObject((u,{fadeIn:h,fadeOut:d})=>{const f=u.cached.scene,p=a.isFadingOut(u);r.markTileUsed(u),f&&(e.setFade(f,h,d),p&&(f.visible=!0)),this.forEachBatchIds(u,(m,g,y)=>{g.setFadeAt(m,h,d),g.setVisibleAt(m,!0),y.batchedMesh.setVisibleAt(m,!1)})}),o){const u=r.getPluginByName("BATCHED_TILES_PLUGIN").batchedMesh.material;o.material.map=u.map}}class Nc{get fadeDuration(){return this._fadeManager.duration}set fadeDuration(e){this._fadeManager.duration=Number(e)}get fadingTiles(){return this._fadeManager.fadeCount}constructor(e){e={maximumFadeOutTiles:50,fadeRootTiles:!1,fadeDuration:250,...e},this.name="FADE_TILES_PLUGIN",this.priority=-2,this.tiles=null,this.batchedMesh=null,this._fadeManager=new Cc,this._fadeMaterialManager=new kc,this._prevCameraTransforms=null,this._fadingOutCount=0,this.maximumFadeOutTiles=e.maximumFadeOutTiles,this.fadeRootTiles=e.fadeRootTiles,this.fadeDuration=e.fadeDuration}init(e){this._onLoadModel=({scene:n})=>{this._fadeMaterialManager.prepareScene(n)},this._onDisposeModel=({tile:n,scene:r})=>{this._fadeManager.deleteObject(n),this._fadeMaterialManager.deleteScene(r)},this._onAddCamera=({camera:n})=>{this._prevCameraTransforms.set(n,new Z)},this._onDeleteCamera=({camera:n})=>{this._prevCameraTransforms.delete(n)},this._onTileVisibilityChange=({tile:n,visible:r})=>{const i=n.cached.scene;i&&(i.visible=!0),this.forEachBatchIds(n,(o,c,l)=>{c.setFadeAt(o,0,0),c.setVisibleAt(o,!1),l.batchedMesh.setVisibleAt(o,!1)})},this._onUpdateBefore=()=>{Ic.call(this)},this._onUpdateAfter=()=>{Dc.call(this)},e.addEventListener("load-model",this._onLoadModel),e.addEventListener("dispose-model",this._onDisposeModel),e.addEventListener("add-camera",this._onAddCamera),e.addEventListener("delete-camera",this._onDeleteCamera),e.addEventListener("update-before",this._onUpdateBefore),e.addEventListener("update-after",this._onUpdateAfter),e.addEventListener("tile-visibility-change",this._onTileVisibilityChange);const t=this._fadeManager;t.onFadeSetStart=()=>{e.dispatchEvent({type:"fade-start"}),e.dispatchEvent({type:"force-rerender"})},t.onFadeSetComplete=()=>{e.dispatchEvent({type:"fade-end"}),e.dispatchEvent({type:"force-rerender"})},t.onFadeComplete=(n,r)=>{this._fadeMaterialManager.setFade(n.cached.scene,0,0),this.forEachBatchIds(n,(i,o,c)=>{o.setFadeAt(i,0,0),o.setVisibleAt(i,!1),c.batchedMesh.setVisibleAt(i,r)}),r||(e.invokeOnePlugin(i=>i!==this&&i.setTileVisible&&i.setTileVisible(n,!1)),this._fadingOutCount--)};const s=new Map;e.cameras.forEach(n=>{s.set(n,new Z)}),e.forEachLoadedModel((n,r)=>{this._onLoadModel({scene:n})}),this.tiles=e,this._fadeManager=t,this._prevCameraTransforms=s}initBatchedMesh(){var t;const e=(t=this.tiles.getPluginByName("BATCHED_TILES_PLUGIN"))==null?void 0:t.batchedMesh;if(e){if(this.batchedMesh===null){this._onBatchedMeshDispose=()=>{this.batchedMesh.dispose(),this.batchedMesh.removeFromParent(),this.batchedMesh=null,e.removeEventListener("dispose",this._onBatchedMeshDispose)};const s=e.material.clone();s.onBeforeCompile=e.material.onBeforeCompile,this.batchedMesh=new Lc(e,s),this.tiles.group.add(this.batchedMesh)}}else this.batchedMesh!==null&&(this._onBatchedMeshDispose(),this._onBatchedMeshDispose=null)}setTileVisible(e,t){const s=this._fadeManager,n=s.isFading(e);if(s.isFadingOut(e)&&this._fadingOutCount--,t?e.__depthFromRenderedParent===1?((e[xr]||this.fadeRootTiles)&&this._fadeManager.fadeIn(e),e[xr]=!0):this._fadeManager.fadeIn(e):(this._fadingOutCount++,s.fadeOut(e)),n)return!0;const r=this._fadeManager.isFading(e);return!!(!t&&r)}dispose(){const e=this.tiles;this._fadeManager.completeAllFades(),this.batchedMesh!==null&&this._onBatchedMeshDispose(),e.removeEventListener("load-model",this._onLoadModel),e.removeEventListener("dispose-model",this._onDisposeModel),e.removeEventListener("add-camera",this._onAddCamera),e.removeEventListener("delete-camera",this._onDeleteCamera),e.removeEventListener("update-before",this._onUpdateBefore),e.removeEventListener("update-after",this._onUpdateAfter),e.removeEventListener("tile-visibility-change",this._onTileVisibilityChange),e.forEachLoadedModel((t,s)=>{this._fadeManager.deleteObject(s),t&&(t.visible=!0)})}forEachBatchIds(e,t){if(this.initBatchedMesh(),this.batchedMesh){const s=this.tiles.getPluginByName("BATCHED_TILES_PLUGIN"),n=s.getTileBatchIds(e);n&&n.forEach(r=>{t(r,this.batchedMesh,s)})}}}const Gs=new WeakMap;class Fc extends Rr{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,s,n){const r=new Dt(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,i=>{const o={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(i,o).then(t).catch(n)},s,n)}decodeDracoFile(e,t,s,n){const r={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!s};this.decodeGeometry(e,r).then(t)}decodeGeometry(e,t){for(const c in t.attributeTypes){const l=t.attributeTypes[c];l.BYTES_PER_ELEMENT!==void 0&&(t.attributeTypes[c]=l.name)}const s=JSON.stringify(t);if(Gs.has(e)){const c=Gs.get(e);if(c.key===s)return c.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const r=this.workerNextTaskID++,i=e.byteLength,o=this._getWorker(r,i).then(c=>(n=c,new Promise((l,u)=>{n._callbacks[r]={resolve:l,reject:u},n.postMessage({type:"decode",id:r,taskConfig:t,buffer:e},[e])}))).then(c=>this._createGeometry(c.geometry));return o.catch(()=>!0).then(()=>{n&&r&&this._releaseTask(n,r)}),Gs.set(e,{key:s,promise:o}),o}_createGeometry(e){const t=new Bt;e.index&&t.setIndex(new ge(e.index.array,1));for(let s=0;s<e.attributes.length;s++){const n=e.attributes[s],r=n.name,i=n.array,o=n.itemSize;t.setAttribute(r,new ge(i,o))}return t}_loadLibrary(e,t){const s=new Dt(this.manager);return s.setPath(this.decoderPath),s.setResponseType(t),s.setWithCredentials(this.withCredentials),new Promise((n,r)=>{s.load(e,n,void 0,r)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(s=>{const n=s[0];e||(this.decoderConfig.wasmBinary=s[1]);const r=Uc.toString(),i=["/* draco decoder */",n,"","/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([i]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const n=new Worker(this.workerSourceURL);n._callbacks={},n._taskCosts={},n._taskLoad=0,n.postMessage({type:"init",decoderConfig:this.decoderConfig}),n.onmessage=function(r){const i=r.data;switch(i.type){case"decode":n._callbacks[i.id].resolve(i);break;case"error":n._callbacks[i.id].reject(i);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+i.type+'"')}},this.workerPool.push(n)}else this.workerPool.sort(function(n,r){return n._taskLoad>r._taskLoad?-1:1});const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[e]=t,s._taskLoad+=t,s})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}function Uc(){let a,e;onmessage=function(i){const o=i.data;switch(o.type){case"init":a=o.decoderConfig,e=new Promise(function(u){a.onModuleLoaded=function(h){u({draco:h})},DracoDecoderModule(a)});break;case"decode":const c=o.buffer,l=o.taskConfig;e.then(u=>{const h=u.draco,d=new h.Decoder,f=new h.DecoderBuffer;f.Init(new Int8Array(c),c.byteLength);try{const p=t(h,d,f,l),m=p.attributes.map(g=>g.array.buffer);p.index&&m.push(p.index.array.buffer),self.postMessage({type:"decode",id:o.id,geometry:p},m)}catch(p){console.error(p),self.postMessage({type:"error",id:o.id,error:p.message})}finally{h.destroy(f),h.destroy(d)}});break}};function t(i,o,c,l){const u=l.attributeIDs,h=l.attributeTypes;let d,f;const p=o.GetEncodedGeometryType(c);if(p===i.TRIANGULAR_MESH)d=new i.Mesh,f=o.DecodeBufferToMesh(c,d);else if(p===i.POINT_CLOUD)d=new i.PointCloud,f=o.DecodeBufferToPointCloud(c,d);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!f.ok()||d.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+f.error_msg());const m={index:null,attributes:[]};for(const g in u){const y=self[h[g]];let _,C;if(l.useUniqueIDs)C=u[g],_=o.GetAttributeByUniqueId(d,C);else{if(C=o.GetAttributeId(d,i[u[g]]),C===-1)continue;_=o.GetAttribute(d,C)}m.attributes.push(n(i,o,d,g,y,_))}return p===i.TRIANGULAR_MESH&&(m.index=s(i,o,d)),i.destroy(d),m}function s(i,o,c){const u=c.num_faces()*3,h=u*4,d=i._malloc(h);o.GetTrianglesUInt32Array(c,h,d);const f=new Uint32Array(i.HEAPF32.buffer,d,u).slice();return i._free(d),{array:f,itemSize:1}}function n(i,o,c,l,u,h){const d=h.num_components(),p=c.num_points()*d,m=p*u.BYTES_PER_ELEMENT,g=r(i,u),y=i._malloc(m);o.GetAttributeDataArrayForAllPoints(c,h,g,m,y);const _=new u(i.HEAPF32.buffer,y,p).slice();return i._free(y),{name:l,array:_,itemSize:d}}function r(i,o){switch(o){case Float32Array:return i.DT_FLOAT32;case Int8Array:return i.DT_INT8;case Int16Array:return i.DT_INT16;case Int32Array:return i.DT_INT32;case Uint8Array:return i.DT_UINT8;case Uint16Array:return i.DT_UINT16;case Uint32Array:return i.DT_UINT32}}}function Bc(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}function Vc(a){if(Object.prototype.hasOwnProperty.call(a,"__esModule"))return a;var e=a.default;if(typeof e=="function"){var t=function s(){return this instanceof s?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(a).forEach(function(s){var n=Object.getOwnPropertyDescriptor(a,s);Object.defineProperty(t,s,n.get?n:{enumerable:!0,get:function(){return a[s]}})}),t}var Ot={exports:{}};const zc={},jc=Object.freeze(Object.defineProperty({__proto__:null,default:zc},Symbol.toStringTag,{value:"Module"})),lt=Vc(jc);/**
 * workerpool.js
 * https://github.com/josdejong/workerpool
 *
 * Offload tasks to a pool of workers on node.js and in the browser.
 *
 * @version 9.2.0
 * @date    2024-10-11
 *
 * @license
 * Copyright (C) 2014-2022 Jos de Jong <wjosdejong@gmail.com>
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy
 * of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */var Wc=Ot.exports,Mr;function Gc(){return Mr||(Mr=1,function(a,e){(function(t,s){s(e)})(Wc,function(t){var s={},n={exports:{}};(function(w){var P=function(N){return typeof N<"u"&&N.versions!=null&&N.versions.node!=null&&N+""=="[object process]"};w.exports.isNode=P,w.exports.platform=typeof process<"u"&&P(process)?"node":"browser";var E=w.exports.platform==="node"&&lt;w.exports.isMainThread=w.exports.platform==="node"?(!E||E.isMainThread)&&!process.connected:typeof Window<"u",w.exports.cpus=w.exports.platform==="browser"?self.navigator.hardwareConcurrency:lt.cpus().length})(n);var r=n.exports,i={},o;function c(){if(o)return i;o=1;function w(N,J){var T=this;if(!(this instanceof w))throw new SyntaxError("Constructor must be called with the new operator");if(typeof N!="function")throw new SyntaxError("Function parameter handler(resolve, reject) missing");var re=[],$=[];this.resolved=!1,this.rejected=!1,this.pending=!0;var ae=function(b,D){re.push(b),$.push(D)};this.then=function(v,b){return new w(function(D,U){var q=v?P(v,D,U):D,fe=b?P(b,D,U):U;ae(q,fe)},T)};var ue=function(b){return T.resolved=!0,T.rejected=!1,T.pending=!1,re.forEach(function(D){D(b)}),ae=function(U,q){U(b)},ue=M=function(){},T},M=function(b){return T.resolved=!1,T.rejected=!0,T.pending=!1,$.forEach(function(D){D(b)}),ae=function(U,q){q(b)},ue=M=function(){},T};this.cancel=function(){return J?J.cancel():M(new E),T},this.timeout=function(v){if(J)J.timeout(v);else{var b=setTimeout(function(){M(new j("Promise timed out after "+v+" ms"))},v);T.always(function(){clearTimeout(b)})}return T},N(function(v){ue(v)},function(v){M(v)})}function P(N,J,T){return function(re){try{var $=N(re);$&&typeof $.then=="function"&&typeof $.catch=="function"?$.then(J,T):J($)}catch(ae){T(ae)}}}w.prototype.catch=function(N){return this.then(null,N)},w.prototype.always=function(N){return this.then(N,N)},w.prototype.finally=function(N){var J=this,T=function(){return new w(function($){return $()}).then(N).then(function(){return J})};return this.then(T,T)},w.all=function(N){return new w(function(J,T){var re=N.length,$=[];re?N.forEach(function(ae,ue){ae.then(function(M){$[ue]=M,re--,re==0&&J($)},function(M){re=0,T(M)})}):J($)})},w.defer=function(){var N={};return N.promise=new w(function(J,T){N.resolve=J,N.reject=T}),N};function E(N){this.message=N||"promise cancelled",this.stack=new Error().stack}E.prototype=new Error,E.prototype.constructor=Error,E.prototype.name="CancellationError",w.CancellationError=E;function j(N){this.message=N||"timeout exceeded",this.stack=new Error().stack}return j.prototype=new Error,j.prototype.constructor=Error,j.prototype.name="TimeoutError",w.TimeoutError=j,i.Promise=w,i}function l(w,P){(P==null||P>w.length)&&(P=w.length);for(var E=0,j=Array(P);E<P;E++)j[E]=w[E];return j}function u(w,P){var E=typeof Symbol<"u"&&w[Symbol.iterator]||w["@@iterator"];if(!E){if(Array.isArray(w)||(E=y(w))||P){E&&(w=E);var j=0,N=function(){};return{s:N,n:function(){return j>=w.length?{done:!0}:{done:!1,value:w[j++]}},e:function($){throw $},f:N}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var J,T=!0,re=!1;return{s:function(){E=E.call(w)},n:function(){var $=E.next();return T=$.done,$},e:function($){re=!0,J=$},f:function(){try{T||E.return==null||E.return()}finally{if(re)throw J}}}}function h(w,P,E){return(P=m(P))in w?Object.defineProperty(w,P,{value:E,enumerable:!0,configurable:!0,writable:!0}):w[P]=E,w}function d(w,P){var E=Object.keys(w);if(Object.getOwnPropertySymbols){var j=Object.getOwnPropertySymbols(w);P&&(j=j.filter(function(N){return Object.getOwnPropertyDescriptor(w,N).enumerable})),E.push.apply(E,j)}return E}function f(w){for(var P=1;P<arguments.length;P++){var E=arguments[P]!=null?arguments[P]:{};P%2?d(Object(E),!0).forEach(function(j){h(w,j,E[j])}):Object.getOwnPropertyDescriptors?Object.defineProperties(w,Object.getOwnPropertyDescriptors(E)):d(Object(E)).forEach(function(j){Object.defineProperty(w,j,Object.getOwnPropertyDescriptor(E,j))})}return w}function p(w,P){if(typeof w!="object"||!w)return w;var E=w[Symbol.toPrimitive];if(E!==void 0){var j=E.call(w,P);if(typeof j!="object")return j;throw new TypeError("@@toPrimitive must return a primitive value.")}return(P==="string"?String:Number)(w)}function m(w){var P=p(w,"string");return typeof P=="symbol"?P:P+""}function g(w){"@babel/helpers - typeof";return g=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(P){return typeof P}:function(P){return P&&typeof Symbol=="function"&&P.constructor===Symbol&&P!==Symbol.prototype?"symbol":typeof P},g(w)}function y(w,P){if(w){if(typeof w=="string")return l(w,P);var E={}.toString.call(w).slice(8,-1);return E==="Object"&&w.constructor&&(E=w.constructor.name),E==="Map"||E==="Set"?Array.from(w):E==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(E)?l(w,P):void 0}}var _={exports:{}},C={},k;function A(){return k||(k=1,C.validateOptions=function(P,E,j){if(P){var N=P?Object.keys(P):[],J=N.find(function(re){return!E.includes(re)});if(J)throw new Error('Object "'+j+'" contains an unknown option "'+J+'"');var T=E.find(function(re){return Object.prototype[re]&&!N.includes(re)});if(T)throw new Error('Object "'+j+'" contains an inherited option "'+T+'" which is not defined in the object itself but in its prototype. Only plain objects are allowed. Please remove the option from the prototype or override it with a value "undefined".');return P}},C.workerOptsNames=["credentials","name","type"],C.forkOptsNames=["cwd","detached","env","execPath","execArgv","gid","serialization","signal","killSignal","silent","stdio","uid","windowsVerbatimArguments","timeout"],C.workerThreadOptsNames=["argv","env","eval","execArgv","stdin","stdout","stderr","workerData","trackUnmanagedFds","transferList","resourceLimits","name"]),C}var L,I;function O(){return I||(I=1,L=`!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e="undefined"!=typeof globalThis?globalThis:e||self).worker=n()}(this,(function(){"use strict";function e(n){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(n)}function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var t={};var r=function(e,n){this.message=e,this.transfer=n},o={};function i(e,n){var t=this;if(!(this instanceof i))throw new SyntaxError("Constructor must be called with the new operator");if("function"!=typeof e)throw new SyntaxError("Function parameter handler(resolve, reject) missing");var r=[],o=[];this.resolved=!1,this.rejected=!1,this.pending=!0;var a=function(e,n){r.push(e),o.push(n)};this.then=function(e,n){return new i((function(t,r){var o=e?u(e,t,r):t,i=n?u(n,t,r):r;a(o,i)}),t)};var f=function(e){return t.resolved=!0,t.rejected=!1,t.pending=!1,r.forEach((function(n){n(e)})),a=function(n,t){n(e)},f=d=function(){},t},d=function(e){return t.resolved=!1,t.rejected=!0,t.pending=!1,o.forEach((function(n){n(e)})),a=function(n,t){t(e)},f=d=function(){},t};this.cancel=function(){return n?n.cancel():d(new s),t},this.timeout=function(e){if(n)n.timeout(e);else{var r=setTimeout((function(){d(new c("Promise timed out after "+e+" ms"))}),e);t.always((function(){clearTimeout(r)}))}return t},e((function(e){f(e)}),(function(e){d(e)}))}function u(e,n,t){return function(r){try{var o=e(r);o&&"function"==typeof o.then&&"function"==typeof o.catch?o.then(n,t):n(o)}catch(e){t(e)}}}function s(e){this.message=e||"promise cancelled",this.stack=(new Error).stack}function c(e){this.message=e||"timeout exceeded",this.stack=(new Error).stack}return i.prototype.catch=function(e){return this.then(null,e)},i.prototype.always=function(e){return this.then(e,e)},i.prototype.finally=function(e){var n=this,t=function(){return new i((function(e){return e()})).then(e).then((function(){return n}))};return this.then(t,t)},i.all=function(e){return new i((function(n,t){var r=e.length,o=[];r?e.forEach((function(e,i){e.then((function(e){o[i]=e,0==--r&&n(o)}),(function(e){r=0,t(e)}))})):n(o)}))},i.defer=function(){var e={};return e.promise=new i((function(n,t){e.resolve=n,e.reject=t})),e},s.prototype=new Error,s.prototype.constructor=Error,s.prototype.name="CancellationError",i.CancellationError=s,c.prototype=new Error,c.prototype.constructor=Error,c.prototype.name="TimeoutError",i.TimeoutError=c,o.Promise=i,function(n){var t=r,i=o.Promise,u="__workerpool-cleanup__",s={exit:function(){}},c={addAbortListener:function(e){s.abortListeners.push(e)},emit:s.emit};if("undefined"!=typeof self&&"function"==typeof postMessage&&"function"==typeof addEventListener)s.on=function(e,n){addEventListener(e,(function(e){n(e.data)}))},s.send=function(e,n){n?postMessage(e,n):postMessage(e)};else{if("undefined"==typeof process)throw new Error("Script must be executed as a worker");var a;try{a=require("worker_threads")}catch(n){if("object"!==e(n)||null===n||"MODULE_NOT_FOUND"!==n.code)throw n}if(a&&null!==a.parentPort){var f=a.parentPort;s.send=f.postMessage.bind(f),s.on=f.on.bind(f),s.exit=process.exit.bind(process)}else s.on=process.on.bind(process),s.send=function(e){process.send(e)},s.on("disconnect",(function(){process.exit(1)})),s.exit=process.exit.bind(process)}function d(e){return Object.getOwnPropertyNames(e).reduce((function(n,t){return Object.defineProperty(n,t,{value:e[t],enumerable:!0})}),{})}function l(e){return e&&"function"==typeof e.then&&"function"==typeof e.catch}s.methods={},s.methods.run=function(e,n){var t=new Function("return ("+e+").apply(this, arguments);");return t.worker=c,t.apply(t,n)},s.methods.methods=function(){return Object.keys(s.methods)},s.terminationHandler=void 0,s.abortListenerTimeout=1e3,s.abortListeners=[],s.terminateAndExit=function(e){var n=function(){s.exit(e)};if(!s.terminationHandler)return n();var t=s.terminationHandler(e);return l(t)?(t.then(n,n),t):(n(),new i((function(e,n){n(new Error("Worker terminating"))})))},s.cleanup=function(e){if(!s.abortListeners.length)return s.send({id:e,method:u,error:d(new Error("Worker terminating"))}),new i((function(e){e()}));var n,t=s.abortListeners.map((function(e){return e()})),r=new i((function(e,t){n=setTimeout((function(){t(new Error("Timeout occured waiting for abort handler, killing worker"))}),s.abortListenerTimeout)})),o=i.all(t).then((function(){clearTimeout(n),s.abortListeners.length||(s.abortListeners=[])}),(function(){clearTimeout(n),s.exit()}));return i.all([o,r]).then((function(){s.send({id:e,method:u,error:null})}),(function(n){s.send({id:e,method:u,error:n?d(n):null})}))};var p=null;s.on("message",(function(e){if("__workerpool-terminate__"===e)return s.terminateAndExit(0);if(e.method===u)return s.cleanup(e.id);try{var n=s.methods[e.method];if(!n)throw new Error('Unknown method "'+e.method+'"');p=e.id;var r=n.apply(n,e.params);l(r)?r.then((function(n){n instanceof t?s.send({id:e.id,result:n.message,error:null},n.transfer):s.send({id:e.id,result:n,error:null}),p=null})).catch((function(n){s.send({id:e.id,result:null,error:d(n)}),p=null})):(r instanceof t?s.send({id:e.id,result:r.message,error:null},r.transfer):s.send({id:e.id,result:r,error:null}),p=null)}catch(n){s.send({id:e.id,result:null,error:d(n)})}})),s.register=function(e,n){if(e)for(var t in e)e.hasOwnProperty(t)&&(s.methods[t]=e[t],s.methods[t].worker=c);n&&(s.terminationHandler=n.onTerminate,s.abortListenerTimeout=n.abortListenerTimeout||1e3),s.send("ready")},s.emit=function(e){if(p){if(e instanceof t)return void s.send({id:p,isEvent:!0,payload:e.message},e.transfer);s.send({id:p,isEvent:!0,payload:e})}},n.add=s.register,n.emit=s.emit}(t),n(t)}));
//# sourceMappingURL=worker.min.js.map
`),L}var R;function V(){if(R)return _.exports;R=1;var w=c(),P=w.Promise,E=r,j=A(),N=j.validateOptions,J=j.forkOptsNames,T=j.workerThreadOptsNames,re=j.workerOptsNames,$="__workerpool-terminate__",ae="__workerpool-cleanup__";function ue(){var F=v();if(!F)throw new Error("WorkerPool: workerType = 'thread' is not supported, Node >= 11.7.0 required");return F}function M(){if(typeof Worker!="function"&&((typeof Worker>"u"?"undefined":g(Worker))!=="object"||typeof Worker.prototype.constructor!="function"))throw new Error("WorkerPool: Web Workers not supported")}function v(){try{return lt}catch(F){if(g(F)==="object"&&F!==null&&F.code==="MODULE_NOT_FOUND")return null;throw F}}function b(){if(E.platform==="browser"){if(typeof Blob>"u")throw new Error("Blob not supported by the browser");if(!window.URL||typeof window.URL.createObjectURL!="function")throw new Error("URL.createObjectURL not supported by the browser");var F=new Blob([O()],{type:"text/javascript"});return window.URL.createObjectURL(F)}else return __dirname+"/worker.js"}function D(F,z){if(z.workerType==="web")return M(),U(F,z.workerOpts,Worker);if(z.workerType==="thread")return x=ue(),q(F,x,z);if(z.workerType==="process"||!z.workerType)return fe(F,ye(z),lt);if(E.platform==="browser")return M(),U(F,z.workerOpts,Worker);var x=v();return x?q(F,x,z):fe(F,ye(z),lt)}function U(F,z,x){N(z,re,"workerOpts");var B=new x(F,z);return B.isBrowserWorker=!0,B.on=function(W,X){this.addEventListener(W,function(se){X(se.data)})},B.send=function(W,X){this.postMessage(W,X)},B}function q(F,z,x){var B,W;N(x==null?void 0:x.workerThreadOpts,T,"workerThreadOpts");var X=new z.Worker(F,f({stdout:(B=x==null?void 0:x.emitStdStreams)!==null&&B!==void 0?B:!1,stderr:(W=x==null?void 0:x.emitStdStreams)!==null&&W!==void 0?W:!1},x==null?void 0:x.workerThreadOpts));return X.isWorkerThread=!0,X.send=function(se,H){this.postMessage(se,H)},X.kill=function(){return this.terminate(),!0},X.disconnect=function(){this.terminate()},x!=null&&x.emitStdStreams&&(X.stdout.on("data",function(se){return X.emit("stdout",se)}),X.stderr.on("data",function(se){return X.emit("stderr",se)})),X}function fe(F,z,x){N(z.forkOpts,J,"forkOpts");var B=x.fork(F,z.forkArgs,z.forkOpts),W=B.send;return B.send=function(X){return W.call(B,X)},z.emitStdStreams&&(B.stdout.on("data",function(X){return B.emit("stdout",X)}),B.stderr.on("data",function(X){return B.emit("stderr",X)})),B.isChildProcess=!0,B}function ye(F){F=F||{};var z=process.execArgv.join(" "),x=z.indexOf("--inspect")!==-1,B=z.indexOf("--debug-brk")!==-1,W=[];return x&&(W.push("--inspect="+F.debugPort),B&&W.push("--debug-brk")),process.execArgv.forEach(function(X){X.indexOf("--max-old-space-size")>-1&&W.push(X)}),Object.assign({},F,{forkArgs:F.forkArgs,forkOpts:Object.assign({},F.forkOpts,{execArgv:(F.forkOpts&&F.forkOpts.execArgv||[]).concat(W),stdio:F.emitStdStreams?"pipe":void 0})})}function xe(F){for(var z=new Error(""),x=Object.keys(F),B=0;B<x.length;B++)z[x[B]]=F[x[B]];return z}function Ae(F,z){if(Object.keys(F.processing).length===1){var x=Object.values(F.processing)[0];x.options&&typeof x.options.on=="function"&&x.options.on(z)}}function Ve(F,z){var x=this,B=z||{};this.script=F||b(),this.worker=D(this.script,B),this.debugPort=B.debugPort,this.forkOpts=B.forkOpts,this.forkArgs=B.forkArgs,this.workerOpts=B.workerOpts,this.workerThreadOpts=B.workerThreadOpts,this.workerTerminateTimeout=B.workerTerminateTimeout,F||(this.worker.ready=!0),this.requestQueue=[],this.worker.on("stdout",function(H){Ae(x,{stdout:H.toString()})}),this.worker.on("stderr",function(H){Ae(x,{stderr:H.toString()})}),this.worker.on("message",function(H){if(!x.terminated)if(typeof H=="string"&&H==="ready")x.worker.ready=!0,X();else{var pe=H.id,oe=x.processing[pe];if(oe!==void 0&&(H.isEvent?oe.options&&typeof oe.options.on=="function"&&oe.options.on(H.payload):(delete x.processing[pe],x.terminating===!0&&x.terminate(),H.error?oe.resolver.reject(xe(H.error)):oe.resolver.resolve(H.result))),H.method===ae){var Te=x.tracking[H.id];Te!==void 0&&(H.error?(clearTimeout(Te.timeoutId),Te.resolver.reject(xe(H.error))):(x.tracking&&clearTimeout(Te.timeoutId),Te.resolver.resolve(Te.result))),delete x.tracking[pe]}}});function W(H){x.terminated=!0;for(var pe in x.processing)x.processing[pe]!==void 0&&x.processing[pe].resolver.reject(H);x.processing=Object.create(null)}function X(){var H=u(x.requestQueue.splice(0)),pe;try{for(H.s();!(pe=H.n()).done;){var oe=pe.value;x.worker.send(oe.message,oe.transfer)}}catch(Te){H.e(Te)}finally{H.f()}}var se=this.worker;this.worker.on("error",W),this.worker.on("exit",function(H,pe){var oe=`Workerpool Worker terminated Unexpectedly
`;oe+="    exitCode: `"+H+"`\n",oe+="    signalCode: `"+pe+"`\n",oe+="    workerpool.script: `"+x.script+"`\n",oe+="    spawnArgs: `"+se.spawnargs+"`\n",oe+="    spawnfile: `"+se.spawnfile+"`\n",oe+="    stdout: `"+se.stdout+"`\n",oe+="    stderr: `"+se.stderr+"`\n",W(new Error(oe))}),this.processing=Object.create(null),this.tracking=Object.create(null),this.terminating=!1,this.terminated=!1,this.cleaning=!1,this.terminationHandler=null,this.lastId=0}return Ve.prototype.methods=function(){return this.exec("methods")},Ve.prototype.exec=function(F,z,x,B){x||(x=P.defer());var W=++this.lastId;this.processing[W]={id:W,resolver:x,options:B};var X={message:{id:W,method:F,params:z},transfer:B&&B.transfer};this.terminated?x.reject(new Error("Worker is terminated")):this.worker.ready?this.worker.send(X.message,X.transfer):this.requestQueue.push(X);var se=this;return x.promise.catch(function(H){if(H instanceof P.CancellationError||H instanceof P.TimeoutError)return se.tracking[W]={id:W,resolver:P.defer()},delete se.processing[W],se.tracking[W].resolver.promise=se.tracking[W].resolver.promise.catch(function(pe){delete se.tracking[W];var oe=se.terminateAndNotify(!0).then(function(){throw pe},function(Te){throw Te});return oe}),se.worker.send({id:W,method:ae}),se.tracking[W].timeoutId=setTimeout(function(){se.tracking[W].resolver.reject(H)},se.workerTerminateTimeout),se.tracking[W].resolver.promise;throw H})},Ve.prototype.busy=function(){return this.cleaning||Object.keys(this.processing).length>0},Ve.prototype.terminate=function(F,z){var x=this;if(F){for(var B in this.processing)this.processing[B]!==void 0&&this.processing[B].resolver.reject(new Error("Worker terminated"));this.processing=Object.create(null)}for(var W=0,X=Object.values(x.tracking);W<X.length;W++){var se=X[W];clearTimeout(se.timeoutId),se.resolver.reject(new Error("Worker Terminating"))}if(x.tracking=Object.create(null),typeof z=="function"&&(this.terminationHandler=z),this.busy())this.terminating=!0;else{var H=function(Te){if(x.terminated=!0,x.cleaning=!1,x.worker!=null&&x.worker.removeAllListeners&&x.worker.removeAllListeners("message"),x.worker=null,x.terminating=!1,x.terminationHandler)x.terminationHandler(Te,x);else if(Te)throw Te};if(this.worker)if(typeof this.worker.kill=="function"){if(this.worker.killed){H(new Error("worker already killed!"));return}var pe=setTimeout(function(){x.worker&&x.worker.kill()},this.workerTerminateTimeout);this.worker.once("exit",function(){clearTimeout(pe),x.worker&&(x.worker.killed=!0),H()}),this.worker.ready?this.worker.send($):this.requestQueue.push({message:$}),this.cleaning=!0;return}else if(typeof this.worker.terminate=="function")this.worker.terminate(),this.worker.killed=!0;else throw new Error("Failed to terminate worker");H()}},Ve.prototype.terminateAndNotify=function(F,z){var x=P.defer();return z&&x.promise.timeout(z),this.terminate(F,function(B,W){B?x.reject(B):x.resolve(W)}),x.promise},_.exports=Ve,_.exports._tryRequireWorkerThreads=v,_.exports._setupProcessWorker=fe,_.exports._setupBrowserWorker=U,_.exports._setupWorkerThreadWorker=q,_.exports.ensureWorkerThreads=ue,_.exports}var ie,de;function yt(){if(de)return ie;de=1;var w=65535;ie=P;function P(){this.ports=Object.create(null),this.length=0}return P.prototype.nextAvailableStartingAt=function(E){for(;this.ports[E]===!0;)E++;if(E>=w)throw new Error("WorkerPool debug port limit reached: "+E+">= "+w);return this.ports[E]=!0,this.length++,E},P.prototype.releasePort=function(E){delete this.ports[E],this.length--},ie}var rt,jt;function bi(){if(jt)return rt;jt=1;var w=c(),P=w.Promise,E=V(),j=r,N=yt(),J=new N;function T(M,v){typeof M=="string"?this.script=M||null:(this.script=null,v=M),this.workers=[],this.tasks=[],v=v||{},this.forkArgs=Object.freeze(v.forkArgs||[]),this.forkOpts=Object.freeze(v.forkOpts||{}),this.workerOpts=Object.freeze(v.workerOpts||{}),this.workerThreadOpts=Object.freeze(v.workerThreadOpts||{}),this.debugPortStart=v.debugPortStart||43210,this.nodeWorker=v.nodeWorker,this.workerType=v.workerType||v.nodeWorker||"auto",this.maxQueueSize=v.maxQueueSize||1/0,this.workerTerminateTimeout=v.workerTerminateTimeout||1e3,this.onCreateWorker=v.onCreateWorker||function(){return null},this.onTerminateWorker=v.onTerminateWorker||function(){return null},this.emitStdStreams=v.emitStdStreams||!1,v&&"maxWorkers"in v?(re(v.maxWorkers),this.maxWorkers=v.maxWorkers):this.maxWorkers=Math.max((j.cpus||4)-1,1),v&&"minWorkers"in v&&(v.minWorkers==="max"?this.minWorkers=this.maxWorkers:($(v.minWorkers),this.minWorkers=v.minWorkers,this.maxWorkers=Math.max(this.minWorkers,this.maxWorkers)),this._ensureMinWorkers()),this._boundNext=this._next.bind(this),this.workerType==="thread"&&E.ensureWorkerThreads()}T.prototype.exec=function(M,v,b){if(v&&!Array.isArray(v))throw new TypeError('Array expected as argument "params"');if(typeof M=="string"){var D=P.defer();if(this.tasks.length>=this.maxQueueSize)throw new Error("Max queue size of "+this.maxQueueSize+" reached");var U=this.tasks,q={method:M,params:v,resolver:D,timeout:null,options:b};U.push(q);var fe=D.promise.timeout;return D.promise.timeout=function(xe){return U.indexOf(q)!==-1?(q.timeout=xe,D.promise):fe.call(D.promise,xe)},this._next(),D.promise}else{if(typeof M=="function")return this.exec("run",[String(M),v],b);throw new TypeError('Function or string expected as argument "method"')}},T.prototype.proxy=function(){if(arguments.length>0)throw new Error("No arguments expected");var M=this;return this.exec("methods").then(function(v){var b={};return v.forEach(function(D){b[D]=function(){return M.exec(D,Array.prototype.slice.call(arguments))}}),b})},T.prototype._next=function(){if(this.tasks.length>0){var M=this._getWorker();if(M){var v=this,b=this.tasks.shift();if(b.resolver.promise.pending){var D=M.exec(b.method,b.params,b.resolver,b.options).then(v._boundNext).catch(function(){if(M.terminated)return v._removeWorker(M)}).then(function(){v._next()});typeof b.timeout=="number"&&D.timeout(b.timeout)}else v._next()}}},T.prototype._getWorker=function(){for(var M=this.workers,v=0;v<M.length;v++){var b=M[v];if(b.busy()===!1)return b}return M.length<this.maxWorkers?(b=this._createWorkerHandler(),M.push(b),b):null},T.prototype._removeWorker=function(M){var v=this;return J.releasePort(M.debugPort),this._removeWorkerFromList(M),this._ensureMinWorkers(),new P(function(b,D){M.terminate(!1,function(U){v.onTerminateWorker({forkArgs:M.forkArgs,forkOpts:M.forkOpts,workerThreadOpts:M.workerThreadOpts,script:M.script}),U?D(U):b(M)})})},T.prototype._removeWorkerFromList=function(M){var v=this.workers.indexOf(M);v!==-1&&this.workers.splice(v,1)},T.prototype.terminate=function(M,v){var b=this;this.tasks.forEach(function(ye){ye.resolver.reject(new Error("Pool terminated"))}),this.tasks.length=0;var D=function(xe){J.releasePort(xe.debugPort),this._removeWorkerFromList(xe)},U=D.bind(this),q=[],fe=this.workers.slice();return fe.forEach(function(ye){var xe=ye.terminateAndNotify(M,v).then(U).always(function(){b.onTerminateWorker({forkArgs:ye.forkArgs,forkOpts:ye.forkOpts,workerThreadOpts:ye.workerThreadOpts,script:ye.script})});q.push(xe)}),P.all(q)},T.prototype.stats=function(){var M=this.workers.length,v=this.workers.filter(function(b){return b.busy()}).length;return{totalWorkers:M,busyWorkers:v,idleWorkers:M-v,pendingTasks:this.tasks.length,activeTasks:v}},T.prototype._ensureMinWorkers=function(){if(this.minWorkers)for(var M=this.workers.length;M<this.minWorkers;M++)this.workers.push(this._createWorkerHandler())},T.prototype._createWorkerHandler=function(){var M=this.onCreateWorker({forkArgs:this.forkArgs,forkOpts:this.forkOpts,workerOpts:this.workerOpts,workerThreadOpts:this.workerThreadOpts,script:this.script})||{};return new E(M.script||this.script,{forkArgs:M.forkArgs||this.forkArgs,forkOpts:M.forkOpts||this.forkOpts,workerOpts:M.workerOpts||this.workerOpts,workerThreadOpts:M.workerThreadOpts||this.workerThreadOpts,debugPort:J.nextAvailableStartingAt(this.debugPortStart),workerType:this.workerType,workerTerminateTimeout:this.workerTerminateTimeout,emitStdStreams:this.emitStdStreams})};function re(M){if(!ae(M)||!ue(M)||M<1)throw new TypeError("Option maxWorkers must be an integer number >= 1")}function $(M){if(!ae(M)||!ue(M)||M<0)throw new TypeError("Option minWorkers must be an integer number >= 0")}function ae(M){return typeof M=="number"}function ue(M){return Math.round(M)==M}return rt=T,rt}var fs={},ps,an;function cn(){if(an)return ps;an=1;function w(P,E){this.message=P,this.transfer=E}return ps=w,ps}var ln;function un(){return ln||(ln=1,function(w){var P=cn(),E=c().Promise,j="__workerpool-terminate__",N="__workerpool-cleanup__",J=1e3,T={exit:function(){}},re={addAbortListener:function(D){T.abortListeners.push(D)},emit:T.emit};if(typeof self<"u"&&typeof postMessage=="function"&&typeof addEventListener=="function")T.on=function(b,D){addEventListener(b,function(U){D(U.data)})},T.send=function(b,D){D?postMessage(b,D):postMessage(b)};else if(typeof process<"u"){var $;try{$=lt}catch(b){if(!(g(b)==="object"&&b!==null&&b.code==="MODULE_NOT_FOUND"))throw b}if($&&$.parentPort!==null){var ae=$.parentPort;T.send=ae.postMessage.bind(ae),T.on=ae.on.bind(ae),T.exit=process.exit.bind(process)}else T.on=process.on.bind(process),T.send=function(b){process.send(b)},T.on("disconnect",function(){process.exit(1)}),T.exit=process.exit.bind(process)}else throw new Error("Script must be executed as a worker");function ue(b){return Object.getOwnPropertyNames(b).reduce(function(D,U){return Object.defineProperty(D,U,{value:b[U],enumerable:!0})},{})}function M(b){return b&&typeof b.then=="function"&&typeof b.catch=="function"}T.methods={},T.methods.run=function(D,U){var q=new Function("return ("+D+").apply(this, arguments);");return q.worker=re,q.apply(q,U)},T.methods.methods=function(){return Object.keys(T.methods)},T.terminationHandler=void 0,T.abortListenerTimeout=J,T.abortListeners=[],T.terminateAndExit=function(b){var D=function(){T.exit(b)};if(!T.terminationHandler)return D();var U=T.terminationHandler(b);return M(U)?(U.then(D,D),U):(D(),new E(function(q,fe){fe(new Error("Worker terminating"))}))},T.cleanup=function(b){if(!T.abortListeners.length)return T.send({id:b,method:N,error:ue(new Error("Worker terminating"))}),new E(function(Ae){Ae()});var D=function(){T.exit()},U=function(){T.abortListeners.length||(T.abortListeners=[])},q=T.abortListeners.map(function(Ae){return Ae()}),fe,ye=new E(function(Ae,Ve){fe=setTimeout(function(){Ve(new Error("Timeout occured waiting for abort handler, killing worker"))},T.abortListenerTimeout)}),xe=E.all(q).then(function(){clearTimeout(fe),U()},function(){clearTimeout(fe),D()});return E.all([xe,ye]).then(function(){T.send({id:b,method:N,error:null})},function(Ae){T.send({id:b,method:N,error:Ae?ue(Ae):null})})};var v=null;T.on("message",function(b){if(b===j)return T.terminateAndExit(0);if(b.method===N)return T.cleanup(b.id);try{var D=T.methods[b.method];if(D){v=b.id;var U=D.apply(D,b.params);M(U)?U.then(function(q){q instanceof P?T.send({id:b.id,result:q.message,error:null},q.transfer):T.send({id:b.id,result:q,error:null}),v=null}).catch(function(q){T.send({id:b.id,result:null,error:ue(q)}),v=null}):(U instanceof P?T.send({id:b.id,result:U.message,error:null},U.transfer):T.send({id:b.id,result:U,error:null}),v=null)}else throw new Error('Unknown method "'+b.method+'"')}catch(q){T.send({id:b.id,result:null,error:ue(q)})}}),T.register=function(b,D){if(b)for(var U in b)b.hasOwnProperty(U)&&(T.methods[U]=b[U],T.methods[U].worker=re);D&&(T.terminationHandler=D.onTerminate,T.abortListenerTimeout=D.abortListenerTimeout||J),T.send("ready")},T.emit=function(b){if(v){if(b instanceof P){T.send({id:v,isEvent:!0,payload:b.message},b.transfer);return}T.send({id:v,isEvent:!0,payload:b})}},w.add=T.register,w.emit=T.emit}(fs)),fs}var wi=r.platform,xi=r.isMainThread,Ai=r.cpus;function vi(w,P){var E=bi();return new E(w,P)}var Ei=s.pool=vi;function Si(w,P){var E=un();E.add(w,P)}var Pi=s.worker=Si;function Mi(w){var P=un();P.emit(w)}var Ci=s.workerEmit=Mi,ki=c(),Ri=ki.Promise,Li=s.Promise=Ri,Oi=s.Transfer=cn(),Ii=s.platform=wi,Di=s.isMainThread=xi,Ni=s.cpus=Ai;t.Promise=Li,t.Transfer=Oi,t.cpus=Ni,t.default=s,t.isMainThread=Di,t.platform=Ii,t.pool=Ei,t.worker=Pi,t.workerEmit=Ci,Object.defineProperty(t,"__esModule",{value:!0})})}(Ot,Ot.exports)),Ot.exports}var Hc=Gc();const qc=Bc(Hc),Kc="/geospatial/assets/worker-CllrsEac.js";let Cr;function $c(){return Cr??(Cr=qc.pool(Kc,{workerOpts:{type:"module"}}))}async function Xc(a,e,t){return await $c().exec(a,e,t)}async function Qc(a,e){const[t,s]=Ro(a),n=await Xc("toCreasedNormals",[t,e],{transfer:s});return Lo(n,a)}class Zc{constructor(e){Ze(this,"options");this.options={...e}}async processTileModel(e,t){const s=[];e.traverse(n=>{n instanceof os&&n.geometry instanceof Bt&&s.push(n)}),await Promise.all(s.map(async n=>{n.geometry=await Qc(n.geometry,this.options.creaseAngle)}))}}class el{constructor(e,t,s){Ze(this,"scene");Ze(this,"camera");Ze(this,"renderer");Ze(this,"tiles");Ze(this,"controls");this.scene=e,this.camera=t,this.renderer=s,this.tiles=new ja,this.tiles.registerPlugin(new Ya({apiToken:"AIzaSyAV5oMvL_l7V0H6jELHb5OCYGjLDWozW8g",autoRefreshToken:!0})),this.tiles.registerPlugin(new Sc({dracoLoader:new Fc().setDecoderPath("https://www.gstatic.com/draco/v1/decoders/")})),this.tiles.registerPlugin(new tc),this.tiles.registerPlugin(new Ja),this.tiles.registerPlugin(new Pc),this.tiles.registerPlugin(new Nc),this.tiles.registerPlugin(new Zc({creaseAngle:30})),this.tiles.setResolutionFromRenderer(this.camera,this.renderer),this.tiles.setCamera(this.camera),this.controls=new Qa(this.scene,this.camera,this.renderer.domElement,this.tiles),this.controls.enableDamping=!0}update(){this.controls.enabled=!0,this.controls.update(),this.camera.updateMatrixWorld(),this.tiles.setResolutionFromRenderer(this.camera,this.renderer),this.tiles.setCamera(this.camera),this.tiles.update()}}export{el as G};
